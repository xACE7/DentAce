<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
  .answer table {width: 100%; border-collapse: collapse; margin-top: 10px;}
  .answer th, .answer td {border: 1px solid var(--card-border); padding: 8px; text-align: left;}
  .answer th {background-color: var(--glass);}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57Q3BDNKFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-57Q3BDNKFW');
</script>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 5</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {q: "What is the primary mechanism by which composite restorations are retained in the tooth structure?", opts: ["Macromechanical interlocking", "Chemical bonding to collagen", "Micromechanical adhesion", "Frictional resistance"], correct: 2, explain: "Composites are primarily retained by micromechanical adhesion, created by etching the tooth surface."},
    {q: "Which of the following is NOT a primary indication for composite restorations?", opts: ["Class V restorations", "Full metal crown foundations", "Diastema closures", "Sealants and preventive resin restorations"], correct: 1, explain: "While composites are used for core buildups, they are not the material of choice for full metal crown foundations. They are indicated for Classes I-V, esthetic enhancements, and sealants."},
    {q: "What is the most critical contraindication for placing a composite restoration?", opts: ["Heavy occlusal forces", "Inability to achieve adequate isolation", "Deep subgingival margins", "Patient allergy to acrylic resin"], correct: 1, explain: "Successful bonding of composite requires an environment completely isolated from oral fluids. If the site cannot be isolated, another material should be chosen."},
    {q: "In a patient with bruxism, which restorative material is generally preferred over composite for posterior restorations?", opts: ["Glass ionomer", "Resin-modified glass ionomer", "Amalgam", "Porcelain"], correct: 2, explain: "Amalgam has better wear resistance and is usually the material of choice for patients with heavy occlusion or bruxism."},
    {q: "The phenomenon of polymerization shrinkage in composites is most likely to cause gap formation on which surface?", opts: ["Occlusal surface", "Enamel margins", "Root surface", "Axial wall"], correct: 2, explain: "Polymerization shrinkage forces can lead to gap formation, especially at the junction of the composite and the root surface, where bonding is less predictable."},
    {q: "Which of the following is considered the main esthetic advantage of composite restorations?", opts: ["Low thermal conductivity", "Ability to be repaired", "Natural tooth-like appearance", "Conservative tooth preparation"], correct: 2, explain: "The most common advantage of composites is their excellent esthetics, allowing them to match the color and translucency of natural teeth."},
    {q: "What is the recommended concentration of phosphoric acid for etching tooth structure?", opts: ["10%", "25%", "37%", "50%"], correct: 2, explain: "37% phosphoric acid is the most commonly used agent for acid etching enamel and dentin."},
    {q: "What is the ideal clinical appearance of enamel after proper acid etching and drying?", opts: ["Shiny and glossy", "Slightly yellow and moist", "Chalky or frosty white", "Smooth and translucent"], correct: 2, explain: "A properly etched and dried enamel surface should have a characteristic frosty white appearance, indicating successful creation of microporosities."},
    {q: "What happens if dentin is over-dried after etching and rinsing?", opts: ["The smear layer reforms", "It prevents the adhesive from penetrating", "It increases the bond strength", "It causes immediate post-operative sensitivity"], correct: 1, explain: "Over-drying the dentin can cause the exposed collagen network to collapse, forming a dense film that prevents the adhesive agent from penetrating effectively."},
    {q: "The layer formed by the penetration of adhesive resin into the exposed collagen network of dentin is called:", opts: ["Resin tag layer", "Oxygen-inhibited layer", "Hybrid layer", "Smear layer"], correct: 2, explain: "The hybrid layer is an interlocking of resin and decalcified dentin (collagen fibers), which is crucial for bonding."},
    {q: "What is the maximum recommended thickness for each increment of composite placement?", opts: ["0.5 mm", "2 mm", "4 mm", "5 mm"], correct: 1, explain: "Increments should not exceed 2 mm in thickness to ensure complete polymerization (curing) and to minimize the effects of polymerization shrinkage."},
    {q: "Which incremental layering technique is specifically designed to reduce the effects of polymerization shrinkage?", opts: ["Horizontal layering", "Bulk fill technique", "Oblique layering", "Vertical layering"], correct: 2, explain: "The oblique technique, which uses wedge-shaped increments, directs shrinkage forces more favorably and reduces overall stress on the restoration."},
    {q: "When should shade selection for a composite restoration be performed?", opts: ["After cavity preparation", "After rubber dam placement", "Before the tooth dehydrates", "Under the dental operating light"], correct: 2, explain: "Shade selection should be done at the beginning of the appointment, before the tooth dehydrates and becomes lighter in shade."},
    {q: "A 'Three-Step Etch-and-Rinse' adhesive system involves which sequence of components?", opts: ["Etchant, Primer, Adhesive", "Etchant, All-in-one Adhesive", "Self-etching primer, Adhesive", "Etchant, Primer + Adhesive"], correct: 0, explain: "The three-step system (IV Generation) uses three separate components: an acid etchant, a primer, and an adhesive resin."},
    {q: "A 'Two-Step Self-Etch' adhesive system combines which two components?", opts: ["Etchant and Primer", "Primer and Adhesive", "Etchant and Adhesive", "All three in one bottle"], correct: 0, explain: "In a two-step self-etch system (VI Generation), the etchant and primer are combined into a 'self-etching primer', followed by a separate adhesive resin."},
    {q: "What is the primary purpose of applying a primer to etched dentin?", opts: ["To remove the smear layer", "To disinfect the dentin surface", "To facilitate wetting and adhesive penetration", "To initiate polymerization"], correct: 2, explain: "The primer contains hydrophilic monomers that displace water from the moist collagen network, allowing the hydrophobic adhesive resin to penetrate."},
    {q: "Which of the following is a primary disadvantage of composite restorations compared to amalgam?", opts: ["Poor esthetics", "Higher thermal conductivity", "More technique-sensitive", "Requires more tooth structure removal"], correct: 2, explain: "Composite restorations are more technique-sensitive, primarily because they require meticulous isolation and multiple steps for bonding."},
    {q: "Which property of composite materials allows for fixing minor defects without replacing the entire restoration?", opts: ["Low thermal conductivity", "Repairability", "High flexural strength", "Radiopacity"], correct: 1, explain: "Composites can be repaired by bonding new material to the existing restoration, which is a significant advantage."},
    {q: "What is the recommended rinsing time after applying 37% phosphoric acid for 15 seconds?", opts: ["5 seconds", "10 seconds", "15 seconds", "30 seconds"], correct: 2, explain: "The etchant should be thoroughly rinsed for the same amount of time it was applied, which is typically 15 seconds."},
    {q: "The 'Successive Cusp Buildup' technique is primarily aimed at:", opts: ["Speeding up the procedure", "Maximizing polymerization shrinkage", "Recreating natural tooth morphology", "Improving the material's color stability"], correct: 2, explain: "This technique focuses on reconstructing individual cusps to replicate the natural anatomy, which can reduce finishing time."},
    {q: "Which composite type is known to polish to the highest gloss, making it esthetically superior?", opts: ["Macrofilled", "Microfilled", "Hybrid", "Nanofilled"], correct: 1, explain: "Microfilled composites have smaller particles that allow them to be polished to a very high, long-lasting gloss."},
    {q: "A 'white line' seen at the margin of a composite restoration is often an indication of:", opts: ["Incomplete curing", "Microfractures from polymerization stress", "Excessive adhesive application", "Staining from oral fluids"], correct: 1, explain: "A white line can indicate enamel microfractures at the margin, caused by the stress of polymerization shrinkage."},
    {q: "What does the term 'Polychromatic layering' refer to in composite restorations?", opts: ["Using a single-shade composite throughout", "Using different shades to mimic natural tooth layers", "Layering different types of composite (e.g., flowable and packable)", "Curing each layer with a different wavelength of light"], correct: 1, explain: "Polychromatic layering uses different composite opacities and shades (e.g., for dentin and enamel) to replicate the appearance of a natural tooth."},
    {q: "A 'Two-Step Etch-and-Rinse' system (V Generation) combines which components into one bottle?", opts: ["Etchant and Primer", "Primer and Adhesive", "Etchant and Adhesive", "All three components"], correct: 1, explain: "In this system, the primer and adhesive are combined into one bottle, which is applied after a separate etching step."},
    {q: "Which of the following is NOT an effect of acid etching on enamel?", opts: ["Dissolution of interprismatic substance", "Creation of microporosities", "Removal of the smear layer", "Exposure of collagen fibrils"], correct: 3, explain: "Exposure of collagen fibrils occurs in dentin, not enamel. Etching enamel increases surface area and energy by dissolving the mineral structure."},
    {q: "The use of a rubber dam is mandatory for composite restorations primarily to:", opts: ["Protect the patient's soft tissues", "Improve visibility for the operator", "Prevent contamination by oral fluids", "Retract the tongue and cheeks effectively"], correct: 2, explain: "While it does all of these things, its most critical role for composites is ensuring absolute isolation to prevent moisture contamination, which would compromise the bond."},
    {q: "For a Class V restoration extending onto the root surface, what might be used under the composite to improve the marginal seal?", opts: ["A varnish", "A calcium hydroxide liner", "A resin-modified glass ionomer (RMGI)", "A thicker layer of adhesive"], correct: 2, explain: "An RMGI liner (in a 'sandwich' technique) can reduce microleakage and gap formation at the root surface margin due to its chemical bond and fluoride release."},
    {q: "Finishing and polishing of a composite restoration should be done:", opts: ["24 hours after placement", "Immediately after the final increment is cured", "Before the final increment is cured", "Only if the patient complains about roughness"], correct: 1, explain: "Unlike amalgam, light-cured composites are fully set once cured, so finishing and polishing can be initiated immediately."},
    {q: "Which is an example of an esthetic enhancement procedure using composite?", opts: ["Core buildup for a PFM crown", "Splinting of periodontally involved teeth", "Closing a diastema", "A Class I occlusal restoration"], correct: 2, explain: "Closing a diastema (a gap between teeth) is a purely esthetic procedure where composite is added to change the shape and size of the teeth."},
    {q: "What is the main reason composites are considered a 'conservative' restorative material?", opts: ["They are inexpensive", "The preparation requires less removal of healthy tooth structure", "They can be placed in a single visit", "They contain no metal"], correct: 1, explain: "Composite preparations don't require mechanical retention features like undercuts, so less healthy tooth structure needs to be removed compared to amalgam preparations."}
];

const tfs = [
    {q: "Composites have completely replaced silicate cement and acrylic resin as tooth-colored restorative materials.", answer: true, explain: "The lecture states that composites are the most popular tooth-colored materials, having completely replaced older options like silicate cement."},
    {q: "The use of a rubber dam is recommended but not mandatory for successful composite bonding.", answer: false, explain: "The lecture explicitly states that the use of a rubber dam is mandatory for all composite restoration procedures to ensure proper isolation."},
    {q: "Composite restorations are more resistant to occlusal wear than amalgam restorations.", answer: false, explain: "Composites generally have less wear resistance than amalgam, making amalgam a better choice in areas of high occlusal stress."},
    {q: "Shade selection should be done after placing the rubber dam to ensure a dry field.", answer: false, explain: "Shade selection must be done before rubber dam placement, as a dehydrated tooth appears lighter in shade, leading to a color mismatch."},
    {q: "The primary disadvantage of composites is their high thermal conductivity.", answer: false, explain: "Composites have low thermal conductivity, similar to dentin, which is an advantage. Their primary disadvantage is polymerization shrinkage."},
    {q: "Acid etching increases the surface energy of the enamel, making it easier to wet with adhesive.", answer: true, explain: "Besides creating microporosities, acid etching removes contaminants and increases surface energy, which promotes wetting by the adhesive resin."},
    {q: "A 'One-Step Self-Etch' adhesive combines the etchant, primer, and bonding agent into a single application.", answer: true, explain: "This system, also known as an 'all-in-one' adhesive, simplifies the procedure by combining all three components into one bottle."},
    {q: "It is acceptable to place composite in increments of up to 4 mm in deep cavities.", answer: false, explain: "The maximum recommended thickness for an increment is 2 mm to ensure adequate light curing and to minimize shrinkage stress."},
    {q: "Composite restorations are not repairable and must be completely replaced if they fracture.", answer: false, explain: "A key advantage of composites is that they are repairable; new composite can be bonded to an existing restoration."}
];

const saqs = [
  {
    q: "A patient presents with a deep Class II carious lesion on a maxillary first molar. The distal margin of the cavity preparation is subgingival and difficult to keep dry. What restorative material would be a better choice than composite in this specific situation, and why?",
    a: "Amalgam would be a better choice. The primary reason is the inability to achieve adequate isolation from oral fluids at the subgingival margin. Successful composite bonding is highly technique-sensitive and requires a completely dry field, which is not possible here. Amalgam is less sensitive to moisture contamination."
  },
  {
    q: "List three distinct contraindications for the use of direct composite restorations.",
    a: `
      <ol>
        <li><b>Inability to Isolate:</b> When the operating site cannot be properly isolated from contamination by saliva or other oral fluids.</li>
        <li><b>Heavy Occlusion:</b> In patients with bruxism or when all of a tooth's occlusal contacts would be solely on the composite material.</li>
        <li><b>Root Surface Extensions:</b> Restorations with margins on the root surface can be problematic due to polymerization shrinkage and a weaker bond, potentially leading to gap formation.</li>
      </ol>
    `
  },
  {
    q: "Describe the seven main steps of the restorative technique for a direct composite restoration using a two-step etch-and-rinse system.",
    a: `
      <ol>
        <li><b>Shade selection:</b> Choosing the correct composite shade before tooth isolation and dehydration.</li>
        <li><b>Isolation:</b> Isolating the operating site, typically with a rubber dam.</li>
        <li><b>Cavity preparation:</b> Removing caries and preparing the tooth conservatively.</li>
        <li><b>Acid etching and rinsing:</b> Applying phosphoric acid to enamel and dentin, then thoroughly rinsing and gently drying.</li>
        <li><b>Adhesive application:</b> Applying the bonding agent and light curing it.</li>
        <li><b>Incremental composite placement:</b> Placing and curing the composite in small layers (max 2mm).</li>
        <li><b>Finishing and polishing:</b> Contouring, finishing, and polishing the restoration.</li>
      </ol>
    `
  },
  {
    q: "Explain the main purpose of acid etching on both enamel and dentin.",
    a: "On <b>enamel</b>, acid etching selectively dissolves the mineral structure (interprismatic substance) to create microscopic pores, which increases the surface area and surface energy. This allows the adhesive resin to flow in and create micromechanical retention (resin tags). On <b>dentin</b>, etching removes the smear layer, demineralizes the top layer to expose the network of collagen fibrils, and opens the dentinal tubules. This allows the primer and adhesive to penetrate and form a 'hybrid layer' for bonding."
  },
  {
    q: "Compare the Horizontal and Oblique incremental layering techniques for placing composite. Which one is considered superior and why?",
    a: `
      <table>
        <thead>
          <tr>
            <th>Technique</th>
            <th>Description</th>
            <th>Effect on Shrinkage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>Horizontal Layering</b></td>
            <td>Composite is placed in flat layers that connect opposing cavity walls (e.g., buccal and lingual).</td>
            <td>This can increase polymerization shrinkage stress because the shrinking composite pulls the walls towards each other.</td>
          </tr>
          <tr>
            <td><b>Oblique Layering</b></td>
            <td>Composite is placed in wedge-shaped increments, touching only two or three walls at a time.</td>
            <td>This technique is superior because it directs shrinkage forces more favorably and reduces the overall stress on the tooth and the bonded interfaces.</td>
          </tr>
        </tbody>
      </table>
    `
  },
  {
    q: "List four main advantages of using composite resin for dental restorations.",
    a: `
      <ol>
        <li><b>Esthetics:</b> They can match the natural color, translucency, and texture of teeth.</li>
        <li><b>Conservative Preparation:</b> Less healthy tooth structure needs to be removed because bonding provides retention, eliminating the need for mechanical undercuts.</li>
        <li><b>Low Thermal Conductivity:</b> They insulate the pulp from temperature changes, similar to natural dentin.</li>
        <li><b>Bonding to Tooth Structure:</b> This results in good retention, reduced microleakage, and increased strength of the remaining tooth structure.</li>
      </ol>
    `
  }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null),
  tf: Array(tfs.length).fill(null),
  saq: Array(saqs.length).fill(false)
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return;
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return;
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;font-size:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;

  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
    const mcqScore = state.mcq.reduce((s, selectedVisualIndex, i) => {
        if (selectedVisualIndex === null) return s;
        const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
        if (card) {
            const feedback = card.querySelector('.feedback').innerHTML;
            if (feedback.includes("<b>Correct ✔</b>")) {
                return s + 1;
            }
        }
        return s;
    }, 0);

    const tfScore = state.tf.reduce((s, val, i) => {
        if (val === null) return s;
         const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
        if (card) {
            const feedback = card.querySelector('.feedback').innerHTML;
            if (feedback.includes("<b>Correct ✔</b>")) {
                return s + 1;
            }
        }
        return s;
    }, 0);
    const saqScore = state.saq.filter(Boolean).length;
    const total = mcqScore + tfScore + saqScore;

    const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id.includes('Mcq')) el.textContent = mcqScore;
        if (id.includes('Tf')) el.textContent = tfScore;
        if (id.includes('Saq')) el.textContent = saqScore;
        if (id.includes('Total')) el.textContent = total;
    });
}


document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

// Initial calculation
recalc();
</script>
</body>
</html>

