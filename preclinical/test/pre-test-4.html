<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table {width: 100%; border-collapse: collapse;}
  .answer th, .answer td {border: 1px solid var(--card-border); padding: 8px; text-align: left;}
  .answer th {background-color: var(--glass);}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57Q3BDNKFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-57Q3BDNKFW');
</script>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 4</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "Which of the following is NOT an objective of tooth preparation according to G.V. Black?",
        opts: ["Remove all defects and caries.", "Provide necessary protection to the pulp.", "Ensure the tooth can be easily extracted later.", "Form the preparation to withstand masticatory forces."],
        correct: 2,
        explain: "The objectives focus on restoration and preservation, not extraction."
    },
    {
        q: "The initial tooth preparation stage includes all of the following steps EXCEPT:",
        opts: ["Outline form & initial depth", "Primary Resistance form", "Pulp protection", "Convenience form"],
        correct: 2,
        explain: "Pulp protection is part of the final tooth preparation stage, only performed if needed."
    },
    {
        q: "What does 'Outline form' primarily define?",
        opts: ["The final depth of the cavity.", "The placement of preparation margins in their final position.", "The shape that resists fracture.", "The features that prevent the restoration from being dislodged."],
        correct: 1,
        explain: "Outline form is establishing the preparation margins where they will be in the final preparation."
    },
    {
        q: "To preserve marginal ridge strength in a premolar, the remaining ridge should be greater than:",
        opts: ["1.6 mm", "2.0 mm", "0.5 mm", "1.0 mm"],
        correct: 0,
        explain: "The minimum marginal ridge thickness for premolars is 1.6 mm. For molars, it is 2.0 mm."
    },
    {
        q: "What is the recommended maximum buccolingual width for a conservative preparation?",
        opts: ["1/2 of the intercuspal distance", "1/3 of the intercuspal distance", "1/4 of the intercuspal distance", "The full intercuspal distance"],
        correct: 2,
        explain: "Minimizing the buccolingual width to 1/4 of the intercuspal distance helps preserve cuspal strength."
    },
    {
        q: "The procedure of reshaping the enamel surface with rotary instruments is termed:",
        opts: ["Enameloplasty", "Odontotomy", "Amelogenesis", "Dentinoplasty"],
        correct: 0,
        explain: "Enameloplasty is the term for reshaping the enamel surface to remove shallow fissures or defects."
    },
    {
        q: "For pit and fissure caries, the initial depth of the preparation into dentin should be restricted to a maximum of:",
        opts: ["0.2 mm", "0.5 mm", "1.0 mm", "1.5 mm"],
        correct: 0,
        explain: "Restricting the initial pulpal depth to 0.2 mm into dentin (overall depth of ~2 mm) is a principle of outline form."
    },
    {
        q: "'Primary Resistance Form' is the shape that enables the tooth and restoration to withstand:",
        opts: ["Tipping or lifting forces", "Masticatory forces without fracture", "Chemical erosion", "Thermal sensitivity"],
        correct: 1,
        explain: "Resistance form is about preventing fracture of the tooth or restoration under chewing forces."
    },
    {
        q: "Which feature is crucial for achieving Primary Resistance Form in a preparation?",
        opts: ["Convergent walls", "Sharp internal line angles", "A rounded pulpal floor", "A relatively flat pulpal floor"],
        correct: 3,
        explain: "A flat floor provides a stable base and resists occlusal forces, preventing a wedging effect."
    },
    {
        q: "For an amalgam restoration, what is the minimum recommended cavity preparation depth to ensure adequate material thickness?",
        opts: ["0.5 - 1.0 mm", "1.0 - 1.2 mm", "1.5 - 2.0 mm", "2.5 - 3.0 mm"],
        correct: 2,
        explain: "A depth of 1.5-2.0 mm is required for amalgam to have sufficient bulk to resist fracture."
    },
    {
        q: "Which feature provides primary retention for a Class I amalgam restoration?",
        opts: ["Micromechanical bonding", "Occlusal convergence of facial and lingual walls", "Divergent walls", "The use of a liner and base"],
        correct: 1,
        explain: "Occlusal convergence creates an undercut that mechanically locks the amalgam restoration in place."
    },
    {
        q: "How are composite restorations primarily retained in a tooth?",
        opts: ["Dovetails and locks", "Occlusal convergence", "A micromechanical bond", "The thickness of the material"],
        correct: 2,
        explain: "Composite retention relies on the bond created by etching and priming the tooth structure."
    },
    {
        q: "What is the main purpose of 'Convenience Form'?",
        opts: ["To make the restoration look aesthetically pleasing.", "To provide adequate observation, accessibility, and ease of operation.", "To ensure the tooth is comfortable for the patient.", "To reduce the amount of tooth structure removed."],
        correct: 1,
        explain: "Convenience form is about making the preparation and restoration procedure easier for the operator."
    },
    {
        q: "Which of the following describes 'infected dentin'?",
        opts: ["Remineralizable and sensitive", "Deeper caries layer that does not stain", "Superficial, unremineralizable, and lacking sensation", "Should be left in the cavity to protect the pulp"],
        correct: 2,
        explain: "Infected dentin is the outer, soft layer of carious dentin that is full of bacteria and must be removed."
    },
    {
        q: "What is the correct treatment for 'affected dentin'?",
        opts: ["It should always be excavated with a spoon excavator.", "It should be left to allow for remineralization.", "It must be removed with a high-speed bur.", "It requires placement of a pin for retention."],
        correct: 1,
        explain: "Affected dentin is demineralized but not yet invaded by bacteria; it is capable of remineralizing and should be preserved."
    },
    {
        q: "A caries-detecting dye will stain which type of dentin?",
        opts: ["Affected dentin", "Infected dentin", "Healthy dentin", "Sclerotic dentin"],
        correct: 1,
        explain: "Caries-detecting dyes selectively stain the porous, bacteria-laden infected dentin."
    },
    {
        q: "Which instrument is best suited for removing large areas of soft, infected dentin?",
        opts: ["A high-speed diamond bur", "A spoon excavator", "An ultrasonic scaler", "A finishing strip"],
        correct: 1,
        explain: "A spoon excavator allows for tactile control and effective removal of soft caries with minimal risk to the pulp."
    },
    {
        q: "Pulp protection is considered mandatory when the remaining dentin thickness (RDT) is less than:",
        opts: ["3.0 mm", "2.5 mm", "2.0 mm", "0.5 mm"],
        correct: 2,
        explain: "If the RDT is less than 2 mm, a liner or base is needed to protect the pulp from thermal and chemical insults."
    },
    {
        q: "Which of the following is a mechanical feature for *secondary* retention?",
        opts: ["Occlusal convergence", "Dovetail", "Micromechanical bonding", "Retentive locks and grooves"],
        correct: 3,
        explain: "Locks, grooves, slots, and pins are all examples of secondary retentive features added when primary retention is insufficient."
    },
    {
        q: "What is the final step in tooth preparation, according to the 9-step sequence?",
        opts: ["Pulp protection", "Finishing external walls", "Cleaning, inspecting, and sealing", "Placing secondary retention"],
        correct: 2,
        explain: "The final step involves cleaning all debris from the preparation before placing the restorative material."
    },
    {
        q: "Connecting two separate caries lesions that are less than ____ apart is generally recommended.",
        opts: ["1.5 mm", "1.0 mm", "0.5 mm", "0.2 mm"],
        correct: 2,
        explain: "If two preparations are less than 0.5 mm apart, the thin wall of tooth structure between them is weak and should be removed, connecting them into one outline."
    },
    {
        q: "Which of these is NOT a primary goal of finishing the external walls?",
        opts: ["Creating the best marginal seal", "Providing a smooth junction", "Maximizing strength of the tooth and restoration at the margin", "Deepening the pulpal floor"],
        correct: 3,
        explain: "Finishing external walls deals with the margins of the preparation, not the depth of the pulpal floor."
    },
    {
        q: "Which principle dictates that preparation margins should be placed to allow for good finishing of the restoration?",
        opts: ["Convenience Form", "Resistance Form", "Retention Form", "Outline Form"],
        correct: 3,
        explain: "A key principle of Outline Form is placing margins in accessible areas for proper finishing."
    },
    {
        q: "A 'dovetail' feature primarily aids in:",
        opts: ["Primary Resistance", "Primary Retention", "Convenience Form", "Pulp Protection"],
        correct: 1,
        explain: "The dovetail provides a mechanical lock that prevents the restoration from being dislodged, which is a key aspect of retention form."
    },
    {
        q: "If a preparation extends more than 2/3 of the way from a central groove to a cusp tip, what should be considered?",
        opts: ["Using enameloplasty", "Cusp capping (covering the cusp)", "Using only a liner", "Making the pulpal floor rounded"],
        correct: 1,
        explain: "Extensive preparation width significantly weakens the cusp, making cusp capping necessary to prevent fracture."
    },
    {
        q: "What is the primary reason for rounding internal line angles in a preparation?",
        opts: ["To improve retention", "To reduce stress concentration in the tooth", "To make it easier to clean", "To allow for better bonding"],
        correct: 1,
        explain: "Rounded internal line angles distribute masticatory forces over a wider area, reducing stress and the risk of tooth fracture."
    },
    {
        q: "Which step is performed immediately before pulp protection in the final stage?",
        opts: ["Convenience form", "Removal of remaining infected dentin", "Finishing external walls", "Secondary retention form"],
        correct: 1,
        explain: "After establishing the initial form, the operator must remove any remaining caries before deciding if pulp protection is needed."
    },
    {
        q: "All of the following are methods for cleaning a prepared cavity EXCEPT:",
        opts: ["Air/water jets", "Dry cotton pellets", "Applying acid etch", "Using a dental explorer to scrape debris"],
        correct: 2,
        explain: "Acid etch is a step for bonding composite, not a method for general cleaning and debris removal."
    },
    {
        q: "Which form prevents displacement of the restoration by tipping or lifting forces?",
        opts: ["Resistance Form", "Outline Form", "Convenience Form", "Retention Form"],
        correct: 3,
        explain: "This is the definition of Retention Form, which is designed to resist dislodgement."
    },
    {
        q: "The two main stages of tooth preparation are:",
        opts: ["Initial and Final", "Occlusal and Proximal", "Amalgam and Composite", "Primary and Secondary"],
        correct: 0,
        explain: "The 9 steps are divided into the Initial Tooth Preparation Stage (Steps 1-4) and the Final Tooth Preparation Stage (Steps 5-9)."
    }
];

const tfs = [
    {
        q: "Infected dentin is remineralizable and should be left in the preparation.",
        answer: false,
        explain: "Infected dentin is unremineralizable and must be removed. Affected dentin is remineralizable."
    },
    {
        q: "A flat pulpal floor contributes to the primary resistance form of a cavity preparation.",
        answer: true,
        explain: "A flat floor helps the tooth and restoration resist masticatory forces without fracture."
    },
    {
        q: "Primary retention for composite restorations is achieved through occlusal convergence.",
        answer: false,
        explain: "Composite retention is primarily from micromechanical bonding. Occlusal convergence is for amalgam."
    },
    {
        q: "The final step of tooth preparation is applying pulp protection.",
        answer: false,
        explain: "The final step is cleaning, inspecting, and sealing the preparation."
    },
    {
        q: "To preserve a marginal ridge on a molar, it must be at least 2.0 mm thick.",
        answer: true,
        explain: "The minimum thickness for a molar marginal ridge is 2.0 mm; for a premolar, it is 1.6 mm."
    },
    {
        q: "Convenience form is primarily for the patient's comfort during the procedure.",
        answer: false,
        explain: "Convenience form is for the operator's ease of access, visibility, and instrumentation."
    },
    {
        q: "Caries-detecting dye stains both infected and affected dentin.",
        answer: false,
        explain: "Caries-detecting dye only stains the porous, bacteria-filled infected dentin."
    },
    {
        q: "Rounded internal line angles help to reduce stress concentration within the tooth.",
        answer: true,
        explain: "Sharp angles concentrate stress, increasing fracture risk. Rounded angles distribute forces more evenly."
    },
    {
        q: "Pins and slots are considered features of primary retention form.",
        answer: false,
        explain: "Pins, slots, locks, and grooves are features of secondary retention, used when primary retention is insufficient."
    }
];

const saqs = [
    {
        q: "A dentist prepares a Class I cavity on a mandibular premolar, leaving a marginal ridge that measures 1.4 mm in thickness. Is this preparation acceptable? Explain your reasoning.",
        a: "This preparation is not acceptable. The minimum required marginal ridge thickness for a premolar is 1.6 mm to prevent fracture under occlusal load. A 1.4 mm ridge is too thin and undermines the strength of the tooth."
    },
    {
        q: "Define 'Primary Resistance Form' and list three features that help achieve it.",
        a: "Primary Resistance Form is the shape and placement of the preparation that best enables both the restoration and the tooth to withstand masticatory forces without fracturing. <br><br>Three features include: <br>1. A relatively flat pulpal floor. <br>2. Rounded internal line angles. <br>3. Adequate thickness of the restorative material (e.g., 1.5-2mm for amalgam)."
    },
    {
        q: "In a numbered table, compare and contrast 'Infected Dentin' and 'Affected Dentin' based on at least four characteristics.",
        a: `
            <table>
              <thead>
                <tr>
                  <th>Characteristic</th>
                  <th>Infected Dentin</th>
                  <th>Affected Dentin</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1. Location</td>
                  <td>Superficial (outer) layer</td>
                  <td>Deeper layer</td>
                </tr>
                <tr>
                  <td>2. Remineralization</td>
                  <td>Unremineralizable</td>
                  <td>Remineralizable</td>
                </tr>
                <tr>
                  <td>3. Sensation</td>
                  <td>Lacking sensation</td>
                  <td>Sensitive</td>
                </tr>
                <tr>
                  <td>4. Clinical Action</td>
                  <td>Must be excavated</td>
                  <td>Should be preserved</td>
                </tr>
                 <tr>
                  <td>5. Staining</td>
                  <td>Stained by caries dye</td>
                  <td>Does not stain</td>
                </tr>
              </tbody>
            </table>
        `
    },
    {
        q: "List the four steps that comprise the 'Initial Tooth Preparation Stage'.",
        a: "The four steps of the initial stage are: <br>1. Outline form and initial depth <br>2. Primary Resistance form <br>3. Primary Retention form <br>4. Convenience form"
    },
    {
        q: "What is the primary purpose of 'Convenience Form' during tooth preparation?",
        a: "The primary purpose of Convenience Form is to provide adequate observation, accessibility, and ease of operation for the dentist while preparing and restoring the tooth. It ensures clear visibility of the entire preparation and allows instruments to be used effectively."
    },
    {
        q: "List three mechanical features that can be used to provide 'Secondary Retention' in a tooth preparation.",
        a: "Three mechanical features for secondary retention are: <br>1. Retentive locks and grooves <br>2. Retentive coves or pins <br>3. Skirts or slot preparations"
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return;
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return;
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;

  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s, v, i) => {
    if (v === null) return s;
    const item = mcqs[i];
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const buttons = card.querySelectorAll('.opt-btn');

    // Find the original index of the selected option
    const selectedVisualIndex = v;
    let originalIndexOfSelected = -1;
    for (let j = 0; j < 4; j++) {
        if (Number(buttons[j].dataset.v) === selectedVisualIndex) {
            const label = buttons[j].querySelector('.label').textContent;
            originalIndexOfSelected = item.opts.indexOf(label);
            break;
        }
    }
    return s + (originalIndexOfSelected === item.correct ? 1 : 0);
  }, 0);

  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v === null) return s;
    return s + (v === tfs[i].answer ? 1 : 0);
  },0);

  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
