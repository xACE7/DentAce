<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table{width:100%;border-collapse:collapse;margin-top:10px;}
  .answer th, .answer td{border:1px solid var(--card-border);padding:8px;text-align:left;}
  .answer th{background:rgba(255,255,255,0.05);}
  .answer ol{padding-left:20px;margin:0;}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 4</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "What is the primary risk of taking more medications simultaneously?",
        opts: ["Decreased cost of treatment", "Increased chance of drug interactions", "Faster recovery time", "Reduced need for dental visits"],
        correct: 1,
        explain: "The more medications a patient takes, the greater the likelihood that these drugs will interact with each other, potentially causing adverse effects."
    },
    {
        q: "Combining a pain medication like hydrocodone with a sedating antihistamine like diphenhydramine results in what type of effect?",
        opts: ["Antagonistic drowsiness", "Additive drowsiness", "No change in alertness", "Reduced pain relief"],
        correct: 1,
        explain: "Both hydrocodone and diphenhydramine cause drowsiness as a side effect. Taking them together leads to an additive effect, resulting in increased drowsiness."
    },
    {
        q: "Which of the following is NOT a pharmacokinetic phase where drug interactions can occur?",
        opts: ["Absorption", "Distribution", "Metabolism", "Replication"],
        correct: 3,
        explain: "Drug interactions occur during absorption, distribution, metabolism, and elimination. Replication is not a phase of pharmacokinetics."
    },
    {
        q: "Taking tetracyclines with dairy products can lead to:",
        opts: ["Increased absorption of the drug", "Reduced absorption due to chelation", "Enhanced drug efficacy", "No significant interaction"],
        correct: 1,
        explain: "Tetracyclines can chelate (bind) with calcium in dairy products, forming insoluble complexes that reduce the drug's absorption from the GI tract."
    },
    {
        q: "What is the mechanism of interaction when NSAIDs displace warfarin from albumin?",
        opts: ["Absorption interaction", "Metabolic interaction", "Distribution interaction", "Elimination interaction"],
        correct: 2,
        explain: "This is a distribution interaction. Both drugs compete for binding sites on plasma proteins (albumin). NSAIDs can displace warfarin, increasing its free concentration and the risk of bleeding."
    },
    {
        q: "Metronidazole inhibits the metabolism of which of the following drugs, increasing its anticoagulant effect?",
        opts: ["Aspirin", "Ibuprofen", "Warfarin", "Paracetamol"],
        correct: 2,
        explain: "Metronidazole inhibits hepatic enzymes (CYP450) responsible for warfarin metabolism, leading to excessive anticoagulation and an increased risk of bleeding."
    },
    {
        q: "What effect does Rifampicin, a CYP450 inducer, have on other drugs like antifungals?",
        opts: ["It increases their efficacy", "It has no effect on them", "It reduces their efficacy", "It increases their toxicity"],
        correct: 2,
        explain: "Rifampicin induces hepatic enzymes, which accelerates the metabolism of many drugs, including antifungals, thereby reducing their therapeutic efficacy."
    },
    {
        q: "NSAIDs can reduce the renal clearance of methotrexate, leading to:",
        opts: ["Reduced methotrexate efficacy", "Increased methotrexate toxicity", "No change in methotrexate levels", "Faster elimination of methotrexate"],
        correct: 1,
        explain: "NSAIDs can impair renal function by reducing prostaglandin synthesis, which in turn decreases the renal clearance of methotrexate, leading to its accumulation and potential toxicity."
    },
    {
        q: "Combining opioids and benzodiazepines can lead to what pharmacodynamic interaction?",
        opts: ["Antagonistic effect", "Synergistic or additive effect", "Reduced sedation", "Competitive inhibition"],
        correct: 1,
        explain: "Both opioids and benzodiazepines are CNS depressants. When taken together, they have a synergistic/additive effect, leading to enhanced sedation and respiratory depression."
    },
    {
        q: "What is the potential outcome of taking NSAIDs concurrently with corticosteroids?",
        opts: ["Decreased risk of GI ulcers", "Increased risk of GI ulceration/bleeding", "Improved blood pressure control", "Enhanced analgesic effect"],
        correct: 1,
        explain: "Both NSAIDs and corticosteroids can irritate the gastric mucosa. Their combined use increases the risk of developing gastrointestinal ulcers and bleeding."
    },
    {
        q: "How do NSAIDs interact with antihypertensive drugs like β-blockers?",
        opts: ["They enhance their effect", "They have no interaction", "They antagonize their effect", "They increase their absorption"],
        correct: 2,
        explain: "NSAIDs can antagonize the effects of many antihypertensives, including β-blockers, ACE inhibitors, and diuretics, leading to poor blood pressure control."
    },
    {
        q: "Which of the following patient groups is generally considered at lower risk for food-nutrient interactions?",
        opts: ["Elderly patients", "Pregnant women", "Healthy young adults", "Malnourished patients"],
        correct: 2,
        explain: "Patients who are elderly, pregnant, malnourished, or have chronic diseases are at higher risk. Healthy young adults are generally at a lower risk."
    },
    {
        q: "The bioavailability of the antibiotic Ceftin is higher when taken:",
        opts: ["In a fasting state", "With a glass of water", "After a meal", "With dairy products"],
        correct: 2,
        explain: "Food can enhance the absorption of some drugs. The bioavailability of Ceftin is significantly higher (52%) when taken after a meal compared to in a fasting state (37%)."
    },
    {
        q: "To avoid interaction with calcium, iron, or other minerals, when should Ciprofloxacin be administered?",
        opts: ["Simultaneously with the mineral supplement", "30 minutes before the mineral", "2 hours before or 6 hours after the mineral", "Immediately after the mineral"],
        correct: 2,
        explain: "To prevent chelation and reduced absorption, ciprofloxacin or tetracycline should be given 2 hours before or 6 hours after consuming minerals like calcium, iron, zinc, or magnesium."
    },
    {
        q: "What is a likely interaction when Ampicillin is taken with oral contraceptives?",
        opts: ["Increased contraceptive efficacy", "Failure of contraception", "Risk of hypertension", "Enhanced antibiotic effect"],
        correct: 1,
        explain: "Ampicillin can interfere with the gut flora that helps recycle contraceptive hormones, potentially leading to contraceptive failure. Alternative contraception should be advised."
    },
    {
        q: "The interaction between Propranolol and adrenaline (in local anesthetic) can cause:",
        opts: ["A sudden drop in blood pressure", "A significant rise in blood pressure", "Anaphylactic shock", "No significant change in vitals"],
        correct: 1,
        explain: "Propranolol, a non-selective beta-blocker, can block adrenaline's vasodilatory effects, leading to unopposed alpha-receptor stimulation and a potential hypertensive crisis."
    },
    {
        q: "Which process involves drugs competing for binding sites on plasma proteins like albumin?",
        opts: ["Metabolism", "Elimination", "Absorption", "Distribution"],
        correct: 3,
        explain: "Distribution is the process where drugs are transported throughout the body, often bound to plasma proteins. Competition for these binding sites is a common source of drug interactions."
    },
    {
        q: "A drug that increases the activity of CYP450 enzymes is known as an:",
        opts: ["Inhibitor", "Inducer", "Agonist", "Antagonist"],
        correct: 1,
        explain: "An enzyme inducer is a drug that increases the metabolic activity of an enzyme system, such as CYP450, leading to faster metabolism of other drugs."
    },
    {
        q: "Which interaction type occurs at the drug's site of action or via the same physiological systems?",
        opts: ["Pharmacokinetic", "Pharmacodynamic", "Pharmaceutical", "Physicochemical"],
        correct: 1,
        explain: "Pharmacodynamic interactions are those that occur at the receptor or target site, altering the drug's effect without changing its concentration."
    },
    {
        q: "Combining an NSAID with Ciprofloxacin can lead to what adverse effect?",
        opts: ["Reduced renal function", "Enhanced CNS toxicity and seizures", "Liver damage", "Failure of the antibiotic"],
        correct: 1,
        explain: "This combination can lead to enhanced central nervous system toxicity, including an increased risk of seizures."
    },
    {
        q: "Metronidazole can decrease the excretion of which substance, potentially leading to toxicity?",
        opts: ["Sodium", "Potassium", "Lithium salts", "Calcium"],
        correct: 2,
        explain: "Metronidazole can impair the renal excretion of lithium, causing it to accumulate to toxic levels."
    },
    {
        q: "An antagonistic effect is when:",
        opts: ["Two drugs combine to produce an enhanced effect", "One drug reduces or blocks the effect of another drug", "A drug binds to a mineral, preventing absorption", "A drug's metabolism is slowed down by another drug"],
        correct: 1,
        explain: "Antagonism occurs when one drug interferes with the action of another, often by blocking its receptor, resulting in a reduced therapeutic effect."
    },
    {
        q: "Which type of product is well-known for forming insoluble complexes with Ciprofloxacin?",
        opts: ["High-fiber foods", "Grapefruit juice", "Dairy products", "Foods high in Vitamin K"],
        correct: 2,
        explain: "The calcium in dairy products can form insoluble complexes (chelation) with Ciprofloxacin and Tetracycline, significantly reducing their absorption."
    },
    {
        q: "An additive drug effect is best described as:",
        opts: ["The effect is greater than the sum of the two drugs", "The effect is equal to the sum of the individual effects", "One drug cancels out the other", "One drug has no effect on the other"],
        correct: 1,
        explain: "An additive effect is where the combined effect of two drugs is equal to the sum of their individual effects (e.g., 1+1=2)."
    },
    {
        q: "The interaction between two CNS depressants is an example of what?",
        opts: ["Pharmacokinetic antagonism", "Pharmacodynamic synergism", "Altered drug distribution", "Induced drug metabolism"],
        correct: 1,
        explain: "This is a pharmacodynamic interaction where two drugs acting on the CNS produce a combined effect (synergism or addition) that is greater than either drug alone."
    },
    {
        q: "Which of the following is a primary objective for improving awareness of drug interactions?",
        opts: ["Prescribing more medications", "Evaluating a patient's full medication list", "Focusing only on dental drugs", "Discouraging patient questions"],
        correct: 1,
        explain: "A key objective is to thoroughly evaluate all medications a patient is taking, including over-the-counter drugs and supplements, to identify potential interactions."
    },
    {
        q: "What is the consequence of a drug interaction that alters the intended response to a medication?",
        opts: ["It is always beneficial", "It can lead to therapeutic failure or toxicity", "It only affects nutritional status", "It is therapeutically irrelevant"],
        correct: 1,
        explain: "Therapeutically important interactions are those that alter the intended response, which can manifest as either a failure to achieve the desired effect or the development of drug toxicity."
    },
    {
        q: "A drug interaction that increases the blood level and possible toxicity of another drug is likely due to:",
        opts: ["Enzyme induction", "Enzyme inhibition", "Reduced absorption", "Antagonistic effects"],
        correct: 1,
        explain: "Enzyme inhibition slows down the metabolism of a drug, causing its concentration in the blood to rise, which can lead to toxicity."
    },
    {
        q: "Taking Ampicillin with oral anticoagulants like warfarin can lead to:",
        opts: ["Reduced risk of bleeding", "Increased risk of bleeding", "Failure of the antibiotic", "No interaction"],
        correct: 1,
        explain: "Ampicillin can disrupt gut flora that produce Vitamin K, potentially enhancing the effect of oral anticoagulants and increasing the risk of bleeding."
    },
    {
        q: "Drug-drug interactions are considered a preventable cause of:",
        opts: ["Morbidity", "Genetic disorders", "Congenital defects", "Chronic disease"],
        correct: 0,
        explain: "Many adverse drug events caused by drug-drug interactions are preventable through careful medication review and patient education, thus reducing patient harm (morbidity)."
    }
];

const tfs = [
    {
        q: "Drug-drug interactions can only decrease how well medications work.",
        answer: false,
        explain: "Interactions can also increase side effects or lead to drug toxicity by increasing blood levels of a drug."
    },
    {
        q: "NSAIDs displacing warfarin from albumin is an example of a metabolic interaction.",
        answer: false,
        explain: "This is a distribution interaction, as it relates to competition for plasma protein binding, not metabolism by enzymes."
    },
    {
        q: "Rifampicin induces hepatic enzymes, which can lead to reduced efficacy of other drugs.",
        answer: true,
        explain: "As a CYP450 inducer, Rifampicin accelerates the metabolism of many drugs, lowering their concentration and effectiveness."
    },
    {
        q: "Combining NSAIDs with corticosteroids decreases the risk of gastrointestinal bleeding.",
        answer: false,
        explain: "This combination significantly increases the risk of GI ulceration and bleeding due to their combined effects on the gastric mucosa."
    },
    {
        q: "Food always decreases the absorption and bioavailability of drugs.",
        answer: false,
        explain: "Food can enhance the absorption of some drugs. For example, the bioavailability of Ceftin is higher after a meal."
    },
    {
        q: "A malnourished patient is considered at high risk for food-nutrient interactions.",
        answer: true,
        explain: "Malnourished patients, along with the elderly, infants, and those with chronic diseases, are particularly vulnerable to such interactions."
    },
    {
        q: "Taking Ciprofloxacin with a glass of milk is recommended to enhance its absorption.",
        answer: false,
        explain: "Calcium in milk chelates with Ciprofloxacin, forming an insoluble complex that significantly reduces its absorption."
    },
    {
        q: "An antagonistic drug interaction results in an enhanced therapeutic response.",
        answer: false,
        explain: "An antagonistic interaction is one where a drug's effect is reduced or blocked by another, potentially leading to therapeutic failure."
    },
    {
        q: "Metronidazole can increase the risk of bleeding when taken with warfarin.",
        answer: true,
        explain: "Metronidazole inhibits the metabolism of warfarin, leading to higher levels of the anticoagulant and an increased risk of bleeding."
    }
];

const saqs = [
    {
        q: "Define a pharmacodynamic drug interaction and provide one example mentioned in the lecture.",
        a: "A pharmacodynamic interaction is one that occurs at the drug's site of action or involves interference with the same physiological systems. It alters the drug's effect without changing its concentration. <br><b>Example:</b> Combining CNS depressants like opioids and benzodiazepines, which results in an additive sedative effect."
    },
    {
        q: "A patient is prescribed warfarin (an anticoagulant) for a heart condition. They begin taking an over-the-counter NSAID for dental pain. What is the potential interaction, and what is the underlying mechanism?",
        a: "The potential interaction is an increased risk of bleeding. The mechanism is a distribution interaction: the NSAID competes with warfarin for binding sites on plasma albumin. This displaces warfarin, increasing the concentration of free, active warfarin in the blood, which enhances its anticoagulant effect."
    },
    {
        q: "List three distinct patient populations that are at a higher risk for food-nutrient interactions.",
        a: "<ol><li>Elderly patients</li><li>Patients with chronic diseases</li><li>Pregnant women / Fetus / Infant</li><li>Malnourished patients</li></ol>(Any three are correct)"
    },
    {
        q: "Compare and contrast synergistic and antagonistic pharmacodynamic effects using examples.",
        a: `<table><thead><tr><th>Effect Type</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><strong>1. Synergistic/Additive</strong></td><td>The combined effect of two drugs is equal to or greater than the sum of their individual effects.</td><td>Opioids + Benzodiazepines leading to enhanced CNS depression.</td></tr><tr><td><strong>2. Antagonistic</strong></td><td>One drug reduces or blocks the effect of another drug, leading to a diminished response.</td><td>NSAIDs reducing the effectiveness of antihypertensive drugs like β-blockers.</td></tr></tbody></table>`
    },
    {
        q: "Explain the interaction between tetracycline antibiotics and dairy products. What is the mechanism and clinical outcome?",
        a: "The mechanism is chelation. Calcium ions in dairy products bind to the tetracycline molecule, forming an insoluble complex. This complex cannot be absorbed from the gastrointestinal tract. The clinical outcome is reduced absorption of the antibiotic, leading to lower blood concentrations and potential therapeutic failure."
    },
    {
        q: "Describe the four main stages of pharmacokinetics where drug-drug interactions can occur.",
        a: `<ol><li><b>Absorption:</b> Interactions in the GI tract that affect how much of a drug is absorbed (e.g., chelation).</li><li><b>Distribution:</b> Competition between drugs for binding sites on plasma proteins like albumin.</li><li><b>Metabolism:</b> One drug inhibiting or inducing the hepatic enzymes (like CYP450) responsible for metabolizing another drug.</li><li><b>Elimination:</b> Competition between drugs for renal excretion pathways, altering how quickly a drug is cleared from the body.</li></ol>`
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;font-size:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  if (!confirm("Are you sure you want to reset all answers and scores?")) {
    return;
  }
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
