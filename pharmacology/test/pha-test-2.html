<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 2</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  {
    q: "What is the primary site of drug metabolism in the body?",
    opts: ["Liver", "Blood", "Spleen", "Brain"],
    correct: 0,
    explain: "The liver is the main organ for metabolizing drugs, although other sites like lungs, kidneys, and intestines also contribute."
  },
  {
    q: "For a drug to effectively cross lipid cell membranes, it must be:",
    opts: ["Lipophilic", "Hydrophilic", "Ionized", "Protein-bound"],
    correct: 0,
    explain: "Drugs need to be lipid-soluble (lipophilic) to pass through the lipid bilayer of cell membranes."
  },
  {
    q: "The duration of a drug's action is primarily determined by its:",
    opts: ["Metabolic rate", "Route of administration", "Color", "Cost"],
    correct: 0,
    explain: "The speed at which a drug is metabolized determines how long its effects will last in the body."
  },
  {
    q: "To be excreted by the kidneys, a lipophilic drug must first be converted into a more:",
    opts: ["Hydrophilic form", "Lipophilic form", "Gaseous form", "Crystalline form"],
    correct: 0,
    explain: "Kidneys efficiently excrete water-loving (hydrophilic) substances, so lipophilic drugs must be metabolized into more polar, hydrophilic forms."
  },
  {
    q: "Which system is primarily responsible for Phase I drug metabolism reactions in the liver?",
    opts: ["Cytochrome P450 system", "Renin-angiotensin system", "Complement system", "Kallikrein-kinin system"],
    correct: 0,
    explain: "Phase I reactions are catalyzed by the cytochrome P450 system, also known as microsomal mixed function oxidase."
  },
  {
    q: "Phase II drug metabolism typically involves which type of reaction?",
    opts: ["Conjugation", "Oxidation", "Reduction", "Hydrolysis"],
    correct: 0,
    explain: "Phase II consists of conjugation reactions where an endogenous substrate is added to the drug metabolite to make it more water-soluble."
  },
  {
    q: "Which of the following is NOT an endogenous substrate used in Phase II conjugation?",
    opts: ["Nitric oxide", "Glucuronic acid", "Sulfuric acid", "An amino acid"],
    correct: 0,
    explain: "Phase II conjugation uses substrates like glucuronic acid, sulfuric acid, acetic acid, or amino acids to increase water solubility."
  },
  {
    q: "Where are microsomal enzymes primarily located?",
    opts: ["Smooth endoplasmic reticulum", "Mitochondria", "Cell nucleus", "Plasma"],
    correct: 0,
    explain: "Microsomal enzymes, such as CYPs, are found on the smooth endoplasmic reticulum, mainly in the liver."
  },
  {
    q: "Which characteristic is typical of non-microsomal enzymes?",
    opts: ["They are not inducible by drugs", "They are only found in the liver", "They are exclusively involved in oxidation", "They are located on the rough endoplasmic reticulum"],
    correct: 0,
    explain: "Unlike microsomal enzymes, non-microsomal enzymes are not inducible by drugs but can exhibit genetic polymorphism."
  },
  {
    q: "Besides the kidneys, which is another significant route of drug excretion?",
    opts: ["Bile", "Hair", "Saliva", "Sweat"],
    correct: 0,
    explain: "While kidneys are the primary route, drugs can also be excreted via bile, intestine, lungs, or milk."
  },
  {
    q: "How does acidification of urine affect a weak acid drug?",
    opts: ["Increases its reabsorption", "Increases its excretion", "Converts it to a weak base", "Has no effect on it"],
    correct: 0,
    explain: "Acidifying the urine increases the amount of un-ionized weak acid, which is more lipid-soluble and thus more readily reabsorbed from the tubules."
  },
  {
    q: "Alkalinization of urine would lead to decreased reabsorption of which type of drug?",
    opts: ["Weak acids", "Weak bases", "Neutral drugs", "Protein-bound drugs"],
    correct: 0,
    explain: "Alkalinization of urine has the opposite effect of acidification; it increases the excretion (decreases reabsorption) of weak acids."
  },
  {
    q: "Ampicillin is a good choice for biliary tract infections because it is:",
    opts: ["Excreted in high concentrations in bile", "Not metabolized by the liver", "Only effective against biliary pathogens", "Absorbed directly into the gallbladder"],
    correct: 0,
    explain: "The route of excretion can influence prescribing; ampicillin's high concentration in bile makes it effective for infections in that area."
  },
  {
    q: "The process where free drug enters the glomerular filtrate occurs in the:",
    opts: ["Bowman's capsule", "Proximal tubule", "Loop of Henle", "Distal tubule"],
    correct: 0,
    explain: "The first step in renal drug elimination is the filtration of free (unbound) drug from the blood into the glomerular filtrate within the Bowman's capsule."
  },
  {
    q: "What is the definition of a drug's half-life ($t_{1/2}$)?",
    opts: ["Time for plasma concentration to decrease by half", "Time for the drug to reach its maximum effect", "Half the time required for complete elimination", "Time it takes for half the dose to be absorbed"],
    correct: 0,
    explain: "Half-life is the time it takes for the concentration of the drug in the plasma to be reduced by 50%."
  },
  {
    q: "Which factor would contribute to a drug having a LONG half-life?",
    opts: ["Extensive protein binding", "Rapid metabolism", "Rapid excretion", "Extensive tissue uptake"],
    correct: 0,
    explain: "Factors like extensive protein binding and slow metabolism or excretion lead to a longer half-life."
  },
  {
    q: "If a drug's dose interval is significantly shorter than its half-life, what is the likely outcome?",
    opts: ["Toxicity", "Lack of therapeutic effect", "The drug is excreted faster", "The half-life is shortened"],
    correct: 0,
    explain: "Administering a drug too frequently (interval shorter than half-life) can lead to accumulation and toxicity."
  },
  {
    q: "A loading dose is used to:",
    opts: ["Achieve high drug concentrations quickly", "Reduce the risk of side effects", "Test for allergic reactions", "Extend the drug's half-life"],
    correct: 0,
    explain: "Loading doses are given when the clinical situation requires therapeutic concentrations to be reached rapidly."
  },
  {
    q: "Passive reabsorption of a drug in the distal tubule of the kidney is most likely to occur if the drug is:",
    opts: ["Lipid-soluble and un-ionized", "Water-soluble and ionized", "Bound to plasma proteins", "A large molecule"],
    correct: 0,
    explain: "Lipid-soluble, un-ionized drugs can easily diffuse back across the tubule membrane into the bloodstream."
  },
  {
    q: "Which of the following is a specific family of the Cytochrome P450 system?",
    opts: ["CYP3A4", "ATPase", "Amidase", "Kinase"],
    correct: 0,
    explain: "The Cytochrome P450 system is composed of many families, with CYP3A4 being one of the major ones involved in drug metabolism."
  },
  {
    q: "The main purpose of drug metabolism is to make a drug:",
    opts: ["More water-soluble for excretion", "More potent for therapeutic effect", "Less bound to plasma proteins", "More easily absorbed from the gut"],
    correct: 0,
    explain: "The overall goal of metabolism is to convert lipophilic drugs into more polar, hydrophilic metabolites that can be easily excreted by the kidneys."
  },
  {
    q: "Where does active secretion of drugs into the urine primarily occur?",
    opts: ["Proximal tubule", "Bowman's capsule", "Collecting duct", "Loop of Henle"],
    correct: 0,
    explain: "Active transport systems in the proximal tubule secrete drugs from the blood into the tubular fluid."
  },
  {
    q: "A patient with renal failure is at a higher risk of toxicity from drugs primarily excreted by the:",
    opts: ["Kidneys", "Lungs", "Bile", "Intestine"],
    correct: 0,
    explain: "Reduced renal function impairs the body's ability to eliminate renally-excreted drugs, leading to accumulation and potential toxicity."
  },
  {
    q: "What is the typical relationship between an initial loading dose and the subsequent maintenance dose?",
    opts: ["The loading dose is twice the maintenance dose", "The loading dose is half the maintenance dose", "They are always equal", "The loading dose is given intravenously, the maintenance is oral"],
    correct: 0,
    explain: "A common strategy is to give an initial dose that is double the maintenance dose to quickly fill the volume of distribution."
  },
  {
    q: "Microsomal enzymes can be induced by:",
    opts: ["Drugs and diet", "Genetic polymorphism only", "High plasma drug concentration", "The presence of non-microsomal enzymes"],
    correct: 0,
    explain: "The activity of microsomal enzymes can be increased (induced) by exposure to certain drugs, chemicals, or dietary components."
  },
  {
    q: "Which drug mentioned in the lecture has a particularly long half-life of 36 hours?",
    opts: ["Digoxin", "Aspirin", "Metronidazole", "Penicillin"],
    correct: 0,
    explain: "Digoxin has a long half-life of 36 hours, which has significant implications for its dosing and risk of toxicity, especially in the elderly."
  },
  {
    q: "The final product of drug metabolism that is excreted in urine is typically:",
    opts: ["Ionized and lipid-insoluble", "Un-ionized and lipid-soluble", "Identical to the parent drug", "Bound to albumin"],
    correct: 0,
    explain: "Metabolism converts drugs into ionized, lipid-insoluble (polar) forms that are trapped in the tubules and excreted in the urine."
  },
  {
    q: "In which part of the hepatic cell are non-microsomal enzymes found?",
    opts: ["Cytoplasm and mitochondria", "Smooth endoplasmic reticulum", "Golgi apparatus", "Lysosomes"],
    correct: 0,
    explain: "Non-microsomal enzymes are located in the cytoplasm and mitochondria of liver cells, as well as in other tissues like plasma."
  },
  {
    q: "If the dose interval for a drug is too long relative to its half-life, the result is:",
    opts: ["The desired therapeutic effect may not be achieved", "The drug will accumulate to toxic levels", "The patient will develop a tolerance to the drug", "The drug's metabolism will be induced"],
    correct: 0,
    explain: "If doses are spaced too far apart, the drug concentration will fall below the therapeutic level between doses, leading to a lack of effect."
  },
  {
    q: "The reason kidneys cannot efficiently eliminate highly lipophilic drugs is due to:",
    opts: ["Reabsorption in the distal tubules", "They are too large to be filtered", "They are inactivated by renal enzymes", "They bind irreversibly to the glomerulus"],
    correct: 0,
    explain: "Lipophilic drugs that are filtered can easily diffuse back out of the renal tubules into the bloodstream, preventing their efficient elimination."
  }
];

const tfs = [
  {
    q: "A drug must be lipophilic to be easily excreted by the kidneys.",
    answer: false,
    explain: "To be excreted by the kidneys, drugs need to be hydrophilic (water-soluble). Lipophilic drugs are reabsorbed."
  },
  {
    q: "Phase I drug metabolism reactions always result in an inactive compound.",
    answer: false,
    explain: "Phase I metabolites can still be pharmacologically active; the main goal is to make them more polar for subsequent Phase II reactions or excretion."
  },
  {
    q: "Microsomal enzymes are inducible by drugs and diet.",
    answer: true,
    explain: "Microsomal enzymes, like CYPs, are located on the smooth endoplasmic reticulum and their activity can be increased (induced) by various substances."
  },
  {
    q: "Non-microsomal enzymes are found only in the cytoplasm of hepatic cells.",
    answer: false,
    explain: "They are present in the cytoplasm and mitochondria of hepatic cells, as well as in other tissues, including plasma."
  },
  {
    q: "Acidification of urine increases the excretion of weak base drugs.",
    answer: true,
    explain: "Acidification of urine decreases the reabsorption of weak bases by making them more ionized, which in turn increases their excretion."
  },
  {
    q: "The optimal dosage interval for a drug is theoretically equal to its half-life.",
    answer: true,
    explain: "In theory, administering a dose every half-life maintains a relatively stable concentration of the drug in the body."
  },
  {
    q: "A short drug half-life is associated with extensive protein binding and slow metabolism.",
    answer: false,
    explain: "These factors (extensive protein binding, slow metabolism) lead to a long half-life. A short half-life is associated with rapid metabolism and excretion."
  },
  {
    q: "A loading dose is typically smaller than the maintenance dose.",
    answer: false,
    explain: "A loading dose is a larger initial dose, often twice the maintenance dose, used to quickly achieve therapeutic levels."
  },
  {
    q: "All drug excretion from the body occurs via the kidneys.",
    answer: false,
    explain: "While the kidneys are the primary route, drugs can also be excreted through bile, the intestine, lungs, or milk."
  }
];

const saqs = [
  {
    q: "Define the term 'drug half-life' ($t_{1/2}$) and explain its importance in determining dosing intervals.",
    a: "Drug half-life ($t_{1/2}$) is the time required for the concentration of the drug in the plasma to decrease by one-half of its initial value. It is crucial for determining dosing intervals because if the interval is too long, the drug level may fall below the therapeutic range, and if it's too short, the drug can accumulate to toxic levels."
  },
  {
    q: "List the three main processes involved in drug elimination by the kidney as depicted in the lecture diagram.",
    a: `
      <ol>
        <li><b>Glomerular Filtration:</b> Free drug enters the glomerular filtrate in the Bowman's capsule.</li>
        <li><b>Active Secretion:</b> The drug is actively secreted from the blood into the proximal tubule.</li>
        <li><b>Passive Reabsorption:</b> Lipid-soluble, un-ionized drug is passively reabsorbed from the distal tubule back into the blood.</li>
      </ol>
    `
  },
  {
    q: "Compare microsomal and non-microsomal enzymes based on their location, inducibility, and one example for each.",
    a: `
      <table style="width:100%; border-collapse: collapse;">
        <tr style="background:rgba(255,255,255,0.05);">
          <th style="padding:8px; border:1px solid var(--card-border); text-align:left;">Feature</th>
          <th style="padding:8px; border:1px solid var(--card-border); text-align:left;">Microsomal Enzymes</th>
          <th style="padding:8px; border:1px solid var(--card-border); text-align:left;">Non-microsomal Enzymes</th>
        </tr>
        <tr>
          <td style="padding:8px; border:1px solid var(--card-border);"><b>Location</b></td>
          <td style="padding:8px; border:1px solid var(--card-border);">Smooth endoplasmic reticulum (liver, kidney, etc.)</td>
          <td style="padding:8px; border:1px solid var(--card-border);">Cytoplasm & mitochondria (hepatic cells), plasma</td>
        </tr>
        <tr style="background:rgba(255,255,255,0.05);">
          <td style="padding:8px; border:1px solid var(--card-border);"><b>Inducibility</b></td>
          <td style="padding:8px; border:1px solid var(--card-border);">Inducible by drugs and diet</td>
          <td style="padding:8px; border:1px solid var(--card-border);">Not inducible, but have polymorphism</td>
        </tr>
        <tr>
          <td style="padding:8px; border:1px solid var(--card-border);"><b>Example</b></td>
          <td style="padding:8px; border:1px solid var(--card-border);">Cytochrome P450s (CYPs)</td>
          <td style="padding:8px; border:1px solid var(--card-border);">Esterases, amidases</td>
        </tr>
      </table>
    `
  },
  {
    q: "Explain the two phases of drug metabolism that occur in the liver.",
    a: "Drug metabolism in the liver occurs in two phases. <b>Phase I</b> reactions, catalyzed by the cytochrome P450 system, introduce or unmask functional groups to make the drug more polar. <b>Phase II</b> consists of conjugation reactions, where an endogenous substrate (e.g., glucuronic acid) is attached to the drug metabolite, making it highly polar and water-soluble for easy excretion."
  },
  {
    q: "An 80-year-old patient with reduced kidney function is prescribed digoxin, a drug primarily excreted by the kidneys with a long half-life of 36 hours. What potential problem is this patient at high risk for, and why?",
    a: "The patient is at a high risk for <b>drug toxicity</b>. The reduced renal capacity impairs the excretion of digoxin, causing the drug to build up in the body. Combined with its naturally long half-life, this accumulation can easily lead to toxic concentrations."
  },
  {
    q: "Explain how altering urinary pH can be used to increase the excretion of a weakly acidic drug like aspirin.",
    a: "To increase the excretion of a weakly acidic drug, the urine should be <b>alkalinized</b>. Alkalinization increases the ionization of the weak acid. The resulting ionized, polar form is less lipid-soluble and therefore cannot be easily reabsorbed from the renal tubules back into the bloodstream, leading to increased excretion."
  }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>