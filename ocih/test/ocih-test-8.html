<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table{width:100%;border-collapse:collapse;margin-top:8px;}
  .answer th, .answer td{border:1px solid var(--glass-border);padding:8px;text-align:left;}
  .answer th{background-color:var(--glass);}
  
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 8</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "Which two physiological processes are most characteristic of the Bell Stage of tooth development?",
        opts: ["Histodifferentiation & Morphodifferentiation", "Initiation & Proliferation", "Apposition & Calcification", "Eruption & Attrition"],
        correct: 0,
        explain: "The Bell Stage is defined by cell differentiation (histodifferentiation) and the establishment of the tooth's final shape (morphodifferentiation)."
    },
    {
        q: "How many distinct cell layers are present in the enamel organ during the Early Bell Stage?",
        opts: ["Two", "Three", "Four", "Five"],
        correct: 2,
        explain: "The Early Bell Stage features four layers: Outer Enamel Epithelium, Stellate Reticulum, Stratum Intermedium, and Inner Enamel Epithelium."
    },
    {
        q: "Which layer appears between the inner enamel epithelium and the stellate reticulum during the Bell Stage?",
        opts: ["Stratum Intermedium", "Dental Papilla", "Outer Enamel Epithelium", "Odontoblast Layer"],
        correct: 0,
        explain: "The Stratum Intermedium is a new layer of squamous cells that forms between the IEE and the stellate reticulum."
    },
    {
        q: "The Stratum Intermedium is particularly rich in which enzyme, crucial for enamel mineralization?",
        opts: ["Acid Phosphatase", "Alkaline Phosphatase", "Amylase", "DNA Polymerase"],
        correct: 1,
        explain: "This layer is rich in alkaline phosphatase, which plays a vital role in the mineralization of enamel."
    },
    {
        q: "What happens to the Stellate Reticulum just before enamel formation begins?",
        opts: ["It collapses", "It expands rapidly", "It transforms into cementum", "It merges with the dental papilla"],
        correct: 0,
        explain: "The Stellate Reticulum collapses to reduce the distance between the ameloblasts and the nutrient-supplying capillaries of the dental sac."
    },
    {
        q: "The final shape of the tooth's crown is determined by the folding of which cell layer?",
        opts: ["Inner Enamel Epithelium", "Outer Enamel Epithelium", "Dental Follicle", "Stellate Reticulum"],
        correct: 0,
        explain: "The folding of the Inner Enamel Epithelium maps out the future pattern of cusps and fossae of the crown."
    },
    {
        q: "During the Advanced Bell Stage, which hard tissue is deposited first?",
        opts: ["Enamel", "Cementum", "Dentin", "Bone"],
        correct: 2,
        explain: "Dentinogenesis (dentin formation) always precedes Amelogenesis (enamel formation)."
    },
    {
        q: "Remnants of the dental lamina that persist in the jaw after it degenerates are known as:",
        opts: ["Epithelial Rests of Malassez", "Enamel Pearls", "Cell Rests of Serre", "Denticles"],
        correct: 2,
        explain: "Cell Rests of Serre are the epithelial remnants of the dental lamina."
    },
    {
        q: "Once hard tissue formation begins, the primary nutritional source for the ameloblasts shifts from the dental papilla to the:",
        opts: ["Oral Epithelium", "Stellate Reticulum", "Dental Sac", "Inner Enamel Epithelium"],
        correct: 2,
        explain: "The newly formed dentin cuts off the supply from the dental papilla, so the ameloblasts rely on blood vessels in the adjacent dental sac."
    },
    {
        q: "The structure responsible for forming Hertwig's Epithelial Root Sheath (HERS) is the:",
        opts: ["Dental Lamina", "Enamel Knot", "Cervical Loop", "Stratum Intermedium"],
        correct: 2,
        explain: "The Cervical Loop, the junction of the IEE and OEE, proliferates apically to form HERS, which guides root development."
    },
    {
        q: "The Membrana Preformativa, which separates the enamel organ from the dental papilla, will eventually become the:",
        opts: ["Dentin-Enamel Junction (DEJ)", "Cemento-Enamel Junction (CEJ)", "Pulp Chamber", "Periodontal Ligament"],
        correct: 0,
        explain: "The Membrana Preformativa is the basement membrane that becomes the future Dentin-Enamel Junction."
    },
    {
        q: "The complete congenital absence of teeth is known as:",
        opts: ["Anodontia", "Hypodontia", "Supernumerary", "Microdontia"],
        correct: 0,
        explain: "Anodontia is a clinical condition characterized by the failure of all teeth to develop, stemming from a defect in the initiation stage."
    },
    {
        q: "Development of extra teeth, or supernumerary teeth, is a clinical anomaly of which physiological stage?",
        opts: ["Initiation", "Apposition", "Histodifferentiation", "Morphodifferentiation"],
        correct: 0,
        explain: "Abnormal activity during the initiation stage can lead to the formation of additional tooth germs, resulting in supernumerary teeth."
    },
    {
        q: "Abnormalities in tooth size and shape, such as peg laterals or macrodontia, are caused by defects in:",
        opts: ["Morphodifferentiation", "Histodifferentiation", "Initiation", "Calcification"],
        correct: 0,
        explain: "Morphodifferentiation is the stage that defines the tooth's size and shape; defects here lead to morphological anomalies."
    },
    {
        q: "Enamel hypocalcification, which results in soft and weak enamel, is a disturbance in which stage?",
        opts: ["Apposition", "Proliferation", "Initiation", "Histodifferentiation"],
        correct: 0,
        explain: "Apposition is the deposition of the enamel matrix. A defect in the quality of this matrix results in hypocalcification."
    },
    {
        q: "The dental papilla is the formative organ for which two tooth structures?",
        opts: ["Dentin and Pulp", "Enamel and Dentin", "Cementum and PDL", "Enamel and Pulp"],
        correct: 0,
        explain: "The dental papilla differentiates to form the odontoblasts (which produce dentin) and the core of the papilla develops into the dental pulp."
    },
    {
        q: "Which cells are characterized by 'Reverse Polarity' during their differentiation in the advanced bell stage?",
        opts: ["Fibroblasts and Cementoblasts", "Ameloblasts and Odontoblasts", "Osteoclasts and Osteoblasts", "Epithelial cells and Mesenchymal cells"],
        correct: 1,
        explain: "Both Ameloblasts and Odontoblasts exhibit reverse polarity, where the nucleus shifts away from the basement membrane (future DEJ) to facilitate secretion."
    },
    {
        q: "What is the main function of the folding of the Outer Enamel Epithelium during the late bell stage?",
        opts: ["To provide a rich nutritional supply", "To determine the number of roots", "To secrete a protective layer", "To initiate nerve formation"],
        correct: 0,
        explain: "The OEE folds to bring capillaries from the dental sac closer to the enamel organ, increasing the surface area for nutrient exchange for the active ameloblasts."
    },
    {
        q: "The deposition of enamel and dentin matrices always begins at the:",
        opts: ["Cervical Loop", "Cusp tips or Incisal edges", "Center of the dental papilla", "Root apex"],
        correct: 1,
        explain: "Hard tissue formation starts at the areas of the future cusps or incisal edges and progresses cervically."
    },
    {
        q: "Which layer of the enamel organ acts as a single functional unit with the inner enamel epithelium for enamel formation?",
        opts: ["Stellate Reticulum", "Outer Enamel Epithelium", "Dental Follicle", "Stratum Intermedium"],
        correct: 3,
        explain: "The Stratum Intermedium works closely with the IEE (ameloblasts) to support the process of enamel formation and mineralization."
    },
    {
        q: "Amelogenesis is the process of depositing:",
        opts: ["Dentin matrix by Odontoblasts", "Enamel matrix by Ameloblasts", "Cementum matrix by Cementoblasts", "Pulp tissue by Fibroblasts"],
        correct: 1,
        explain: "Amelogenesis specifically refers to the formation of enamel matrix by the ameloblasts."
    },
    {
        q: "What triggers the peripheral cells of the dental papilla to differentiate into odontoblasts?",
        opts: ["An organizing influence from the IEE", "A signal from the dental lamina", "Increased vascular supply", "The collapse of the stellate reticulum"],
        correct: 0,
        explain: "The inner enamel epithelium exerts an organizing influence that induces the underlying mesenchymal cells of the dental papilla to become odontoblasts."
    },
    {
        q: "After Hertwig's epithelial root sheath guides root formation, it begins to break down into a network of cells called:",
        opts: ["Cell Rests of Serre", "Epithelial Rests of Malassez", "Enamel Pearls", "Cementicles"],
        correct: 1,
        explain: "The fragmentation of HERS leaves behind clusters of epithelial cells in the periodontal ligament known as the Epithelial Rests of Malassez."
    },
    {
        q: "The cervical loop is an area of intense mitotic activity composed of which two layers?",
        opts: ["IEE and Stratum Intermedium", "OEE and Stellate Reticulum", "IEE and OEE", "Stellate Reticulum and Stratum Intermedium"],
        correct: 2,
        explain: "The cervical loop is found at the growing rim of the enamel organ and consists only of the inner and outer enamel epithelium."
    },
    {
        q: "Which of the following structures is considered avascular (lacking its own blood supply)?",
        opts: ["Dental Papilla", "Dental Sac", "Enamel Organ", "Periodontal Ligament"],
        correct: 2,
        explain: "The enamel organ is of epithelial origin and is avascular; it relies on surrounding vascularized tissues like the dental papilla and dental sac for nutrients."
    },
    {
        q: "The physiological process responsible for the deposition of enamel and dentin matrix is called:",
        opts: ["Histodifferentiation", "Proliferation", "Apposition", "Initiation"],
        correct: 2,
        explain: "Apposition is the stage of laying down the extracellular matrix for hard tissues in an incremental, layered fashion."
    },
    {
        q: "Which cell loses its functional activity completely after the tooth crown is fully formed?",
        opts: ["Odontoblast", "Cementoblast", "Fibroblast", "Ameloblast"],
        correct: 3,
        explain: "After enamel formation is complete, the ameloblasts become part of the reduced enamel epithelium and are lost upon tooth eruption, meaning enamel cannot regenerate."
    },
    {
        q: "The inner enamel epithelium (IEE) cells differentiate into what functional cells?",
        opts: ["Odontoblasts", "Ameloblasts", "Cementoblasts", "Preameloblasts"],
        correct: 1,
        explain: "The tall columnar cells of the inner enamel epithelium differentiate into ameloblasts, the cells responsible for producing enamel."
    },
    {
        q: "The dental follicle (or dental sac) will give rise to which of the following structures?",
        opts: ["Enamel and Dentin", "Pulp and Dentin", "Cementum, PDL, and Alveolar Bone", "Enamel and Gingiva"],
        correct: 2,
        explain: "The ectomesenchymal cells of the dental follicle (sac) form the primary supporting tissues of the tooth: cementum, periodontal ligament, and some of the alveolar bone."
    },
    {
        q: "Which stage is characterized by the tooth crown assuming its final shape, but before any hard tissue formation has begun?",
        opts: ["Advanced Bell Stage", "Cap Stage", "Early Bell Stage", "Bud Stage"],
        correct: 2,
        explain: "The Early Bell Stage involves histodifferentiation and morphodifferentiation to finalize the crown shape, but mineralization (hard tissue formation) does not start until the Advanced Bell Stage."
    }
];

const tfs = [
    {
        q: "Enamel formation begins before dentin formation.",
        answer: false,
        explain: "This is false. Dentinogenesis (dentin formation) always precedes amelogenesis (enamel formation)."
    },
    {
        q: "The Stratum Intermedium is essential for dentin mineralization due to its high concentration of alkaline phosphatase.",
        answer: false,
        explain: "This is false. The Stratum Intermedium and its enzymes are essential for ENAMEL mineralization, not dentin."
    },
    {
        q: "Ameloblasts can continue to produce new enamel if the tooth is damaged later in life.",
        answer: false,
        explain: "This is false. Ameloblasts are lost after crown formation is complete, so enamel cannot regenerate."
    },
    {
        q: "The final shape of the tooth's crown is determined by the folding of the inner enamel epithelium.",
        answer: true,
        explain: "This is true. The folding of the IEE during the bell stage establishes the pattern of cusps and fissures."
    },
    {
        q: "The cervical loop is composed of only the inner enamel epithelium and the outer enamel epithelium.",
        answer: true,
        explain: "This is true. It is the junction of these two layers at the most cervical part of the enamel organ."
    },
    {
        q: "Cell Rests of Serre are remnants of Hertwig's epithelial root sheath.",
        answer: false,
        explain: "This is false. Cell Rests of Serre are remnants of the dental lamina. Remnants of HERS are called Epithelial Rests of Malassez."
    },
    {
        q: "The nutritional supply for ameloblasts shifts from the dental papilla to the dental sac during the advanced bell stage.",
        answer: true,
        explain: "This is true. The formation of dentin cuts off the papillary supply, forcing reliance on the vascular dental sac."
    },
    {
        q: "Morphodifferentiation is the process where undifferentiated cells become specialized, such as becoming ameloblasts.",
        answer: false,
        explain: "This is false. That process is histodifferentiation. Morphodifferentiation is the process that determines the shape and size of the tooth."
    },
    {
        q: "The Membrana Preformativa is the future Cemento-Enamel Junction (CEJ).",
        answer: false,
        explain: "This is false. The Membrana Preformativa is the future Dentino-Enamel Junction (DEJ)."
    }
];

const saqs = [
    {
        q: "Describe the primary function of the Stellate Reticulum and explain what happens to this layer just before enamel formation commences.",
        a: "The Stellate Reticulum's primary function is to act as a protective cushion for the developing enamel organ and to support it by synthesizing and holding glycosaminoglycans. Just before enamel formation begins, this layer collapses, reducing the distance between the ameloblasts and the blood vessels in the dental sac to facilitate nutrient supply."
    },
    {
        q: "List the four distinct cell layers of the enamel organ that are present in the Early Bell Stage, from outermost to innermost.",
        a: "The four layers are:<br><ol><li>Outer Enamel Epithelium</li><li>Stellate Reticulum</li><li>Stratum Intermedium</li><li>Inner Enamel Epithelium</li></ol>"
    },
    {
        q: "Compare Amelogenesis and Dentinogenesis based on the responsible cell, the tissue formed, and the tissue's ability to regenerate.",
        a: "<table><thead><tr><th>Feature</th><th>Amelogenesis</th><th>Dentinogenesis</th></tr></thead><tbody><tr><td><b>Responsible Cell</b></td><td>Ameloblast</td><td>Odontoblast</td></tr><tr><td><b>Tissue Formed</b></td><td>Enamel</td><td>Dentin</td></tr><tr><td><b>Regenerative Potential</b></td><td>None (Ameloblasts are lost)</td><td>Yes (Odontoblasts persist)</td></tr></tbody></table>"
    },
    {
        q: "A patient presents with teeth that have a chalky, opaque appearance and are structurally weak, leading to easy chipping. This condition affects multiple teeth. A defect in which physiological stage of tooth development is the most likely cause? Explain your reasoning.",
        a: "The most likely cause is a defect in the <b>Apposition</b> stage. This stage involves the deposition of the enamel and dentin matrices. A qualitative defect here, specifically in enamel matrix mineralization, leads to <b>Enamel Hypocalcification</b>. This results in enamel that is of normal thickness but is soft, weak, and chalky, matching the clinical description."
    },
    {
        q: "What is the Membrana Preformativa, and what critical anatomical landmark does it become in a fully formed tooth?",
        a: "The Membrana Preformativa is the acellular basement membrane that separates the inner enamel epithelium (pre-ameloblasts) from the dental papilla (pre-odontoblasts) before hard tissue formation begins. In the mature tooth, it becomes the <b>Dentino-Enamel Junction (DEJ)</b>."
    },
    {
        q: "Identify three distinct clinical anomalies that can result from disturbances in tooth development, and name the specific physiological stage associated with each.",
        a: "<ol><li><b>Anodontia or Supernumerary Teeth:</b> A total lack or an excess number of teeth, caused by a defect in the <b>Initiation</b> stage.</li><li><b>Macrodontia or Microdontia:</b> Abnormally large or small teeth, caused by a defect in the <b>Morphodifferentiation</b> stage.</li><li><b>Amelogenesis Imperfecta (Hypoplasia/Hypocalcification):</b> Defective enamel formation (quality or quantity), caused by a defect in the <b>Apposition</b> stage.</li></ol>"
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      const originalV = visualToOriginal[v];
      state.mcq[idx] = originalV; // Store original index for scoring logic

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;font-size:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;

  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
    const mcqScore = state.mcq.reduce((s, v, i) => {
        if (v === null) return s;
        // Re-find the correct answer using original data, not shuffled display
        return s + (v === mcqs[i].correct ? 1 : 0);
    }, 0);

    const tfScore = state.tf.reduce((s, v, i) => {
        if (v === null) return s;
        return s + (v === tfs[i].answer ? 1 : 0);
    }, 0);

    const saqScore = state.saq.filter(Boolean).length;
    const total = mcqScore + tfScore + saqScore;

    const ids = ["sMcq", "sTf", "sSaq", "sTotal", "sMcq2", "sTf2", "sSaq2", "sTotal2"];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id.includes('Mcq')) el.textContent = mcqScore;
        if (id.includes('Tf')) el.textContent = tfScore;
        if (id.includes('Saq')) el.textContent = saqScore;
        if (id.includes('Total')) el.textContent = total;
    });
}


document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
