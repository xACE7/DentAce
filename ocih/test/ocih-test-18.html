<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:8px;text-align:left;border:1px solid var(--card-border);}
  th{background-color:var(--glass);}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 18</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "What is the primary function of dentin?",
        opts: ["To form the main bulk of the tooth", "To cover the crown", "To provide blood supply to the tooth", "To protect the enamel"],
        correct: 0,
        explain: "Dentin is the mineralized tissue that forms the main bulk of the tooth, underlying the enamel in the crown and the cementum in the root."
    },
    {
        q: "Which property differentiates dentin from enamel?",
        opts: ["It is harder than enamel", "It is formed throughout life", "It is completely inorganic", "It is not sensitive"],
        correct: 1,
        explain: "Dentin is formed throughout life (secondary and tertiary dentin), whereas enamel formation ceases after tooth eruption. Dentin is also sensitive."
    },
    {
        q: "What is the color of healthy dentin?",
        opts: ["Bright white", "Slightly grayish", "Light yellowish", "Transparent"],
        correct: 2,
        explain: "Dentin has a light yellowish color, which can influence the overall shade of the tooth as it shows through the translucent enamel."
    },
    {
        q: "What is the approximate inorganic composition of dentin by weight?",
        opts: ["96%", "45%", "65-70%", "20%"],
        correct: 2,
        explain: "Dentin is composed of 65-70% inorganic material, primarily hydroxyapatite crystals."
    },
    {
        q: "What is the main organic component of dentin?",
        opts: ["Keratin", "Collagen type II", "Collagen type I", "Elastin"],
        correct: 2,
        explain: "The organic matrix of dentin is about 90% Collagen type I, which provides a scaffold for mineralization."
    },
    {
        q: "Odontoblasts differentiate from which cells?",
        opts: ["Ameloblasts", "Inner dental epithelium cells", "Stellate reticulum cells", "Peripheral dental papilla cells (UMC)"],
        correct: 3,
        explain: "Odontoblasts, the cells that form dentin, differentiate from the undifferentiated mesenchymal cells (UMC) of the dental papilla."
    },
    {
        q: "What is the name of the unmineralized organic matrix of dentin?",
        opts: ["Enameloid", "Cementoid", "Predentin", "Osteoid"],
        correct: 2,
        explain: "Predentin is the initially laid down, unmineralized organic matrix of dentin that subsequently mineralizes to become mature dentin."
    },
    {
        q: "The single cytoplasmic extension of an odontoblast left within the dentin matrix is called:",
        opts: ["Enamel spindle", "Tomes' process", "Tomes' fiber", "Sharpey's fiber"],
        correct: 2,
        explain: "As odontoblasts recede, they leave a single process within the forming dentin matrix. This process is known as Tomes' fiber."
    },
    {
        q: "The first layer of dentin formed, located near the DEJ, is called:",
        opts: ["Circumpulpal dentin", "Mantle dentin", "Secondary dentin", "Tertiary dentin"],
        correct: 1,
        explain: "Mantle dentin is the first-formed layer, about 10-20 µm thick, located in the crown and root, differing slightly in fiber orientation from the rest of the dentin."
    },
    {
        q: "Mineralization of mantle dentin is initiated by what structures?",
        opts: ["Collagen fibers", "Golgi apparatus", "Matrix vesicles", "Ameloblasts"],
        correct: 2,
        explain: "Mineralization in mantle dentin begins with budding of matrix vesicles from odontoblasts, which contain enzymes and ions that initiate crystallization."
    },
    {
        q: "What is the pattern of mineralization in circumpulpal dentin just below the mantle layer?",
        opts: ["Linear", "Globular", "Reticular", "Lamellar"],
        correct: 1,
        explain: "Mineralization in the circumpulpal dentin occurs in a globular (or calcospheric) pattern, where globules of hydroxyapatite fuse."
    },
    {
        q: "What is the main histological unit of dentin?",
        opts: ["Enamel rod", "Osteon", "Dentinal tubule", "Cementocyte"],
        correct: 2,
        explain: "Dentin is composed of millions of microscopic parallel tubules, called dentinal tubules, which radiate from the pulp to the periphery."
    },
    {
        q: "The space between the odontoblastic process and the wall of the dentinal tubule is called:",
        opts: ["Periodontoblastic space", "Intertubular space", "Peritubular space", "Canaliculus"],
        correct: 0,
        explain: "The periodontoblastic space is filled with dentinal fluid (lymph) and surrounds the odontoblastic process (Tome's fiber)."
    },
    {
        q: "Which type of dentin is highly calcified and forms the immediate wall of the dentinal tubule?",
        opts: ["Intertubular dentin", "Mantle dentin", "Peritubular dentin", "Predentin"],
        correct: 2,
        explain: "Peritubular (or Intratubular) dentin is a hypermineralized collar of dentin that lines the tubule wall, being about 40% more mineralized than the surrounding dentin."
    },
    {
        q: "What forms the main bulk of the dentin and is located between the dentinal tubules?",
        opts: ["Peritubular dentin", "Intertubular dentin", "Mantle dentin", "Predentin"],
        correct: 1,
        explain: "Intertubular dentin constitutes the primary structural component of dentin, located between the peritubular dentin rings."
    },
    {
        q: "How does the direction of collagen fibers in mantle dentin differ from circumpulpal dentin in the crown?",
        opts: ["Parallel to DEJ", "Perpendicular to DEJ", "Randomly oriented", "They are absent"],
        correct: 1,
        explain: "In the crown, the large collagen fibers of mantle dentin are oriented perpendicular (at a right angle) to the dentinoenamel junction (DEJ)."
    },
    {
        q: "Unmineralized or hypomineralized areas resulting from the failure of fusion of calcification globules are known as:",
        opts: ["Tomes' granular layer", "Incremental lines of Owen", "Interglobular dentin", "Sclerotic dentin"],
        correct: 2,
        explain: "Interglobular dentin consists of areas where globular zones of mineralization have failed to coalesce, leaving behind unmineralized organic matrix."
    },
    {
        q: "Where is Tomes' granular layer typically found?",
        opts: ["Just below the DEJ in the crown", "Adjacent to the cementum in the root", "Surrounding the pulp chamber", "Within the mantle dentin"],
        correct: 1,
        explain: "Tomes' granular layer is a specific feature of root dentin, appearing as a granular zone adjacent to the dentinocemental junction (DCJ)."
    },
    {
        q: "The incremental lines in dentin that represent a 5-day cycle of formation are called:",
        opts: ["Contour lines of Owen", "Neonatal lines", "Striae of Retzius", "Incremental lines of von Ebner"],
        correct: 3,
        explain: "The lines of von Ebner are fine lines that represent the daily rhythmic, incremental deposition of dentin, with more pronounced lines occurring in a 5-day cycle."
    },
    {
        q: "Accentuated contour lines representing disturbances in mineralization due to illness or malnutrition are known as:",
        opts: ["Lines of von Ebner", "Neonatal lines", "Contour lines of Owen", "Hunter-Schreger bands"],
        correct: 2,
        explain: "Contour lines of Owen are hypocalcified bands that reflect a systemic disturbance that affected the odontoblasts during dentin formation."
    },
    {
        q: "What is the shape of odontoblasts in the crown (pulp chamber)?",
        opts: ["Flat", "Cuboidal", "Columnar or pseudostratified columnar", "Squamous"],
        correct: 2,
        explain: "In the crown, where dentin formation is most active, odontoblasts are tall and closely packed, appearing as columnar or pseudostratified columnar cells."
    },
    {
        q: "The lateral branches of odontoblastic processes are responsible for dentin's:",
        opts: ["Hardness", "Color", "Permeability", "Elasticity"],
        correct: 2,
        explain: "The lateral branches connect adjacent odontoblastic processes, forming a network that contributes to the permeability of dentin."
    },
    {
        q: "How does the diameter of dentinal tubules change from the pulp towards the DEJ?",
        opts: ["It widens", "It remains constant", "It tapers (narrows)", "It branches without changing diameter"],
        correct: 2,
        explain: "Dentinal tubules are widest at the pulpal surface and taper to a smaller diameter as they approach the DEJ or DCJ."
    },
    {
        q: "A neonatal line is found in which teeth?",
        opts: ["All permanent teeth", "All deciduous teeth and first permanent molars", "Only canines and incisors", "Only premolars"],
        correct: 1,
        explain: "The neonatal line is an enlarged incremental line that marks the disruption in formation and mineralization occurring at birth, found in all primary teeth and the cusps of first permanent molars."
    },
    {
        q: "Which method is used to study the organic components of dentin?",
        opts: ["Ground section", "Decalcified section", "Electron microscopy", "Radiography"],
        correct: 1,
        explain: "To study the organic matrix (like collagen), the mineral component must be removed using an acid, a process called decalcification."
    },
    {
        q: "In which direction do dentinal tubules run in the cuspal areas?",
        opts: ["S-shaped", "Straight", "Apically curved", "Horizontally"],
        correct: 1,
        explain: "In the area of cusps or incisal edges, the dentinal tubules follow a relatively straight path from the pulp towards the DEJ."
    },
    {
        q: "Peritubular dentin is continuously formed, leading to:",
        opts: ["Widening of the tubule", "Narrowing of the tubule", "Increased permeability", "Decreased hardness"],
        correct: 1,
        explain: "The continuous deposition of peritubular dentin throughout life causes the diameter of the dentinal tubule to decrease, a process which can lead to sclerosis."
    },
    {
        q: "The ground substance for circumpulpal dentin comes from:",
        opts: ["The cell-free zone only", "Ameloblasts", "Odontoblasts", "Blood plasma"],
        correct: 2,
        explain: "Odontoblasts are responsible for synthesizing and secreting the organic ground substance (non-collagenous proteins, etc.) for circumpulpal dentin."
    },
    {
        q: "What is the approximate thickness of dentin?",
        opts: ["0.1-0.5 mm", "1-2 mm", "3-10 mm", "Over 15 mm"],
        correct: 2,
        explain: "The thickness of dentin varies depending on the tooth and location but generally ranges from 3 to 10 millimeters."
    },
    {
        q: "Radiographically, how does dentin compare to enamel?",
        opts: ["More radiolucent", "More radio-opaque", "Same radiodensity", "Completely radiolucent"],
        correct: 0,
        explain: "Because it is less mineralized, dentin is more radiolucent (appears darker on an X-ray) than enamel, but more radio-opaque (lighter) than pulp."
    }
];

const tfs = [
    {
        q: "Dentin is harder than enamel but softer than cementum.",
        answer: false,
        explain: "Dentin is softer than enamel but harder than both cementum and bone."
    },
    {
        q: "The organic material in dentin is approximately 30-35% of its total weight.",
        answer: true,
        explain: "Dentin consists of 30-35% organic material (mainly collagen) and water, and 65-70% inorganic material."
    },
    {
        q: "Odontoblasts initially form a single process which later branches out.",
        answer: false,
        explain: "Odontoblasts initially have more than one process, which later merge, leaving a single main process (Tomes' fiber) as dentin is laid down."
    },
    {
        q: "The quiescent state of odontoblasts means they stop forming dentin completely.",
        answer: false,
        explain: "In the quiescent state, odontoblasts decrease in size and form dentin at a much slower rate (secondary dentin), but they do not stop completely."
    },
    {
        q: "Matrix vesicles are rich in alkaline phosphatase, which is crucial for mineralization.",
        answer: true,
        explain: "The membrane of matrix vesicles is rich in alkaline phosphatase, an enzyme that plays a key role in initiating the crystallization of hydroxyapatite."
    },
    {
        q: "Dentinal tubules are uniform in diameter from the pulp to the DEJ.",
        answer: false,
        explain: "Dentinal tubules taper and become narrower as they extend from the pulpal surface towards the dentinoenamel junction (DEJ)."
    },
    {
        q: "Peritubular dentin is less mineralized than intertubular dentin.",
        answer: false,
        explain: "Peritubular dentin is significantly more mineralized (by about 40%) than the surrounding intertubular dentin."
    },
    {
        q: "Interglobular dentin represents a defect in mineralization and is always present in root dentin.",
        answer: false,
        explain: "Interglobular dentin is a mineralization defect but it is typically found in the crown, just below the mantle dentin. It is not always present."
    },
    {
        q: "Tomes' granular layer is caused by the looping of terminal dentinal tubules.",
        answer: true,
        explain: "This granular-appearing layer, found in the root dentin adjacent to the cementum, is believed to be caused by the looping and coalescing of the terminal portions of dentinal tubules."
    }
];

const saqs = [
    {
        q: "Describe the two major properties that differentiate dentin from enamel.",
        a: "Dentin differs from enamel in two key ways:<br>1. <b>Sensitivity:</b> Dentin is a sensitive tissue due to the presence of odontoblastic processes and fluid within the dentinal tubules, which can transmit stimuli to the pulp. Enamel is insensitive.<br>2. <b>Lifelong Formation:</b> Dentin is formed throughout the life of the tooth. After the primary dentin is formed, secondary dentin continues to be deposited slowly, and tertiary (reparative) dentin can be formed in response to stimuli. Enamel formation ceases once the tooth erupts."
    },
    {
        q: "List three physical properties of dentin.",
        a: "Here are three physical properties of dentin: <br>1. <b>Color:</b> Light yellowish. <br>2. <b>Hardness:</b> Less hard than enamel, but harder than cementum and bone. <br>3. <b>Visco-Elasticity:</b> It has a slight flexibility that provides support to the overlying brittle enamel, preventing fracture."
    },
    {
        q: "Compare and contrast mantle dentin and circumpulpal dentin.",
        a: `<table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Mantle Dentin</th>
                        <th>Circumpulpal Dentin</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><b>Location</b></td>
                        <td>The first-formed, outermost layer (10-20 µm).</td>
                        <td>Forms the remaining bulk of the dentin, surrounding the pulp.</td>
                    </tr>
                    <tr>
                        <td><b>Collagen Fibers</b></td>
                        <td>Large diameter fibers, perpendicular to the DEJ (in crown).</td>
                        <td>Smaller diameter fibers, parallel to the DEJ.</td>
                    </tr>
                    <tr>
                        <td><b>Mineralization</b></td>
                        <td>Initiated by matrix vesicles; occurs in a linear pattern.</td>
                        <td>Occurs via globular (calcospheric) calcification; no matrix vesicles.</td>
                    </tr>
                </tbody>
            </table>`
    },
    {
        q: "Explain the process of dentinogenesis, starting from the differentiation of odontoblasts to the formation of predentin.",
        a: "Dentinogenesis begins with the differentiation of odontoblasts from the peripheral cells of the dental papilla, induced by signals from the inner dental epithelium. These cells elongate into columnar cells. Next, they become protein-secreting cells, developing organelles like RER and Golgi bodies, and begin to secrete the organic matrix of dentin, known as predentin. This predentin is composed mainly of type I collagen fibers and ground substance. The odontoblasts then recede pulpally, leaving behind a process (Tomes' fiber) as they deposit successive layers of predentin, which will later be mineralized."
    },
    {
        q: "A patient who had a severe fever and nutritional deficiency during childhood now has teeth that show distinct accentuated lines in the dentin on a radiograph. What are these lines called, and what do they represent?",
        a: "These lines are called the <b>Contour lines of Owen</b>. They represent a disturbance in the mineralization process of dentin that occurred during the period of illness and inadequate nutrition. They are essentially hypocalcified bands within the dentin that follow the contour of the developing dentin at the time of the systemic disruption. They are a permanent record of the metabolic stress the child experienced."
    },
    {
        q: "List and describe the three main components found within and immediately surrounding a single dentinal tubule.",
        a: `Here are the three components:
            <ol>
                <li><b>Odontoblastic Process (Tome's Fiber):</b> This is the cytoplasmic extension of the odontoblast cell body that occupies the dentinal tubule.</li>
                <li><b>Periodontoblastic Space:</b> This is the space between the odontoblastic process and the tubule wall. It is filled with dentinal fluid (tissue fluid).</li>
                <li><b>Peritubular Dentin (Intratubular Dentin):</b> This is a highly calcified ring of dentin that forms the immediate wall of the tubule. It is about 40% more mineralized than the surrounding dentin.</li>
            </ol>`
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
    const mcqScore = state.mcq.reduce((s, v, i) => {
        if (v === null) return s;
        const item = mcqs[i];
        const card = mcqGrid.children[i];
        const buttons = card.querySelectorAll('.opt-btn');

        const visualToOriginal = shuffleIndices(4);
        const originalToVisual = Array(4);
        visualToOriginal.forEach((orig, vis) => { originalToVisual[orig] = vis; });
        const correctVisualIndex = originalToVisual[item.correct];

        return s + (v === correctVisualIndex ? 1 : 0);
    }, 0);

    const tfScore = state.tf.reduce((s, v, i) => {
        if (v === null) return s;
        return s + (v === tfs[i].answer ? 1 : 0);
    }, 0);

    const saqScore = state.saq.filter(Boolean).length;
    const total = mcqScore + tfScore + saqScore;

    const ids = ["sMcq", "sTf", "sSaq", "sTotal", "sMcq2", "sTf2", "sSaq2", "sTotal2"];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id.includes('Mcq')) el.textContent = mcqScore;
        if (id.includes('Tf')) el.textContent = tfScore;
        if (id.includes('Saq')) el.textContent = saqScore;
        if (id.includes('Total')) el.textContent = total;
    });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

// Initial calculation to set scores to 0
recalc();
</script>
</body>
</html>
