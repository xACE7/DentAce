<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57Q3BDNKFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-57Q3BDNKFW');
</script>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 7</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  {
    q: "At which week of intrauterine life does the formation of the primary epithelial band begin?",
    opts: ["4th week", "6th week", "8th week", "10th week"],
    correct: 1,
    explain: "Tooth formation begins with the formation of the primary epithelial band during the 6th week of intrauterine life."
  },
  {
    q: "The primary epithelial band divides into which two structures during the 7th week?",
    opts: ["Enamel organ and Dental papilla", "Dental lamina and Vestibular lamina", "Inner and Outer enamel epithelium", "Stellate reticulum and Stratum intermedium"],
    correct: 1,
    explain: "In the 7th week, the primary epithelial band divides into the dental lamina, which forms teeth, and the vestibular lamina, which forms the oral vestibule."
  },
  {
    q: "Which physiological stage of tooth development is primarily characterized by the proliferation of cells?",
    opts: ["Initiation", "Histodifferentiation", "Apposition", "Morphodifferentiation"],
    correct: 0,
    explain: "The initiation and proliferation (bud stage) physiological stages involve the growth and multiplication of dental cells."
  },
  {
    q: "The shape and size of a tooth are determined during which physiological stage?",
    opts: ["Histodifferentiation", "Apposition", "Morphodifferentiation", "Initiation"],
    correct: 2,
    explain: "Morphodifferentiation, occurring during the bell stage, is the process where the final shape and size of the tooth crown are established."
  },
  {
    q: "The 'Bud Stage' is the first morphological stage of tooth development. What is its main characteristic?",
    opts: ["Formation of a cap-like structure", "Differentiation of cell layers", "Formation of a rounded epithelial outgrowth", "Deposition of enamel and dentin"],
    correct: 2,
    explain: "The Bud Stage is characterized by the proliferation of the dental lamina into a small, rounded bud-like enamel organ that pushes into the underlying ectomesenchyme."
  },
  {
    q: "What are the three components that make up the 'Tooth Germ'?",
    opts: ["Enamel, Dentin, Pulp", "Enamel organ, Dental papilla, Dental sac", "Outer enamel epithelium, Inner enamel epithelium, Stellate reticulum", "Crown, Root, Apex"],
    correct: 1,
    explain: "The tooth germ, the primordial structure of a tooth, consists of the enamel organ, the dental papilla, and the dental sac (or follicle)."
  },
  {
    q: "During the cap stage, what do the peripheral cells of the enamel organ differentiate into?",
    opts: ["Ameloblasts and Odontoblasts", "Stellate Reticulum", "Outer and Inner Enamel Epithelium", "Cementoblasts and Fibroblasts"],
    correct: 2,
    explain: "Histodifferentiation begins in the cap stage, where peripheral cells form the cuboidal Outer Enamel Epithelium and the low columnar Inner Enamel Epithelium."
  },
  {
    q: "The star-shaped appearance of the Stellate Reticulum is due to the secretion of which substance?",
    opts: ["Collagen fibers", "Keratin", "Hydrophilic Glycosaminoglycans (GAGs)", "Calcium phosphate"],
    correct: 2,
    explain: "Polygonal cells in the center of the enamel organ secrete hydrophilic GAGs, which pull water in, separating the cells. They remain connected by cytoplasmic processes, creating a star-shaped network."
  },
  {
    q: "What is the primary function of the Stellate Reticulum?",
    opts: ["To form enamel", "To provide nutrition to the enamel organ", "To act as a cushion and protect the developing tooth", "To form the dentin-pulp complex"],
    correct: 2,
    explain: "The Stellate Reticulum provides a cushion-like consistency, protecting the delicate structures of the enamel organ from physical forces."
  },
  {
    q: "The 'Enamel Knot' is a transient structure seen in which stage of tooth development?",
    opts: ["Dental Lamina Stage", "Bud Stage", "Cap Stage", "Bell Stage"],
    correct: 2,
    explain: "The Enamel Knot is a transient condensation of ectodermal cells in the central region of the inner enamel epithelium, appearing during the cap stage."
  },
  {
    q: "What is the proposed role of the Enamel Knot?",
    opts: ["To initiate root formation", "To form the periodontal ligament", "To determine the initial position of the first cusp", "To supply blood vessels to the dental papilla"],
    correct: 2,
    explain: "The Enamel Knot is believed to play a role in mapping out the future crown pattern by determining the position of the first cusp."
  },
  {
    q: "The Cervical Loop is the region where which two layers meet?",
    opts: ["Dental Papilla and Dental Sac", "Inner and Outer Enamel Epithelium", "Stellate Reticulum and Stratum Intermedium", "Enamel and Dentin"],
    correct: 1,
    explain: "The Cervical Loop is the zone of reflexion at the rim of the enamel organ where the inner and outer enamel epithelia meet."
  },
  {
    q: "What critical process begins at the Cervical Loop?",
    opts: ["Crown formation", "Cusp development", "Root formation", "Tooth eruption"],
    correct: 2,
    explain: "The Cervical Loop is the site where root formation is initiated after the crown has been completed."
  },
  {
    q: "The Dental Papilla is derived from which embryonic tissue?",
    opts: ["Ectoderm", "Endoderm", "Mesoderm", "Ectomesenchyme"],
    correct: 3,
    explain: "The Dental Papilla, which forms dentin and pulp, is a condensation of ectomesenchyme under the influence of the epithelial enamel organ."
  },
  {
    q: "Which adult tooth structures are derived from the Dental Papilla?",
    opts: ["Enamel and Cementum", "Dentin and Pulp", "Periodontal Ligament and Alveolar Bone", "Gingiva and Epithelial attachment"],
    correct: 1,
    explain: "The Dental Papilla gives rise to the dentin and the pulp of the tooth."
  },
  {
    q: "The Dental Sac (or Dental Follicle) gives rise to which of the following structures?",
    opts: ["Enamel", "Dentin", "Pulp", "Cementum"],
    correct: 3,
    explain: "The Dental Sac is an ectomesenchymal structure that forms the supporting tissues of the tooth: cementum, periodontal ligament, and alveolar bone."
  },
  {
    q: "Which of these is NOT derived from the Dental Sac?",
    opts: ["Cementum", "Periodontal Ligament", "Alveolar Bone", "Dentin"],
    correct: 3,
    explain: "Dentin is derived from the Dental Papilla. The Dental Sac forms the cementum, periodontal ligament, and alveolar bone."
  },
  {
    q: "The enamel organ is responsible for the formation of which tooth tissue?",
    opts: ["Dentin", "Enamel", "Cementum", "Pulp"],
    correct: 1,
    explain: "The enamel organ, which is of ectodermal origin, is solely responsible for the formation of enamel."
  },
  {
    q: "How many epithelial outgrowths (tooth buds) form in the upper arch for the deciduous teeth?",
    opts: ["5", "8", "10", "16"],
    correct: 2,
    explain: "Localized proliferative activity in the dental lamina leads to the formation of 10 epithelial outgrowths in the upper jaw and 10 in the lower jaw, corresponding to the future deciduous teeth."
  },
  {
    q: "The connection between the developing tooth bud and the dental lamina becomes what shape during the cap stage?",
    opts: ["A narrow cord", "A broad, sheet-like connection", "It disappears completely", "It fragments into rests"],
    correct: 1,
    explain: "During the cap stage, differential growth changes the shape of the enamel organ and it maintains a short and broad connection to the dental lamina."
  },
  {
    q: "What is the term for the ectomesenchyme that condenses below the enamel organ in the bud stage?",
    opts: ["Dental Sac", "Stellate Reticulum", "Dental Papilla", "Vestibular Lamina"],
    correct: 2,
    explain: "In the bud stage, the ectomesenchyme immediately under the epithelial bud condenses to become the dental papilla."
  },
  {
    q: "The cells of the Inner Enamel Epithelium in the cap stage are best described as:",
    opts: ["Squamous", "Cuboidal", "Low Columnar", "Stellate"],
    correct: 2,
    explain: "During the cap stage, the Inner Enamel Epithelium consists of low columnar cells covering the concavity of the enamel organ."
  },
  {
    q: "The cells of the Outer Enamel Epithelium in the cap stage are best described as:",
    opts: ["Columnar", "Cuboidal", "Fusiform", "Stellate"],
    correct: 1,
    explain: "The Outer Enamel Epithelium consists of cuboidal cells covering the outer convexity of the enamel organ during the cap stage."
  },
  {
    q: "Which process describes the differentiation of cells into specialized tissue-forming cells, like ameloblasts and odontoblasts?",
    opts: ["Proliferation", "Morphodifferentiation", "Histodifferentiation", "Apposition"],
    correct: 2,
    explain: "Histodifferentiation is the physiological process where embryonic cells differentiate to gain their functional and morphological characteristics, which begins in the cap stage and is prominent in the bell stage."
  },
  {
    q: "The permanent molars develop from which structure?",
    opts: ["The successional lamina", "The vestibular lamina", "A distal extension of the dental lamina", "Fragmentation of the primary epithelial band"],
    correct: 2,
    explain: "The permanent molars, which have no deciduous predecessors, arise from a distal extension of the dental lamina."
  },
  {
    q: "What separates the oral ectoderm from the underlying ectomesenchyme in the early stages?",
    opts: ["A cell-free zone", "The stellate reticulum", "A basement membrane", "The dental sac"],
    correct: 2,
    explain: "A basement membrane separates the epithelial structures (like the enamel organ) from the connective tissue structures (like the dental papilla and sac)."
  },
  {
    q: "The transition from the bud stage to the cap stage is primarily caused by:",
    opts: ["Apoptosis of central cells", "Unequal or differential growth", "Hormonal signals", "Deposition of hard tissue"],
    correct: 1,
    explain: "The change from a symmetrical bud to an asymmetrical cap is the result of differential growth, where parts of the enamel organ proliferate at different rates."
  },
  {
    q: "What is the embryonic origin of the Enamel Organ?",
    opts: ["Mesoderm", "Ectomesenchyme", "Endoderm", "Ectoderm"],
    correct: 3,
    explain: "The Enamel Organ originates from the oral ectoderm, which is the epithelial lining of the primitive oral cavity (stomodeum)."
  },
  {
    q: "The ectomesenchyme surrounding both the enamel organ and the dental papilla is called the:",
    opts: ["Cervical Loop", "Enamel Knot", "Dental Sac", "Basement Membrane"],
    correct: 2,
    explain: "The dental sac (or follicle) is the ectomesenchymal condensation that encircles both the enamel organ and the dental papilla."
  },
  {
    q: "In which morphological stage does histodifferentiation first become evident?",
    opts: ["Dental Lamina Stage", "Bud Stage", "Cap Stage", "Apposition Stage"],
    correct: 2,
    explain: "Histodifferentiation, the differentiation of cells into distinct types, begins in the cap stage with the formation of the outer and inner enamel epithelia and the stellate reticulum."
  }
];

const tfs = [
  {
    q: "The Dental Lamina gives rise to all deciduous and permanent teeth.",
    answer: true,
    explain: "The dental lamina and its extensions (successional and distal) are responsible for forming the enamel organs of all teeth."
  },
  {
    q: "The Bud Stage is characterized by a high degree of cellular differentiation.",
    answer: false,
    explain: "The Bud Stage is primarily a stage of proliferation with minimal cellular differentiation. Histodifferentiation begins in the subsequent Cap Stage."
  },
  {
    q: "The Dental Papilla and the Dental Sac are both derived from ectoderm.",
    answer: false,
    explain: "Both the Dental Papilla and the Dental Sac are derived from ectomesenchyme, not ectoderm. Only the enamel organ is of ectodermal origin."
  },
  {
    q: "The Stellate Reticulum forms the enamel of the tooth.",
    answer: false,
    explain: "The Stellate Reticulum is a supportive and protective layer. Enamel is formed by ameloblasts, which differentiate from the Inner Enamel Epithelium."
  },
  {
    q: "The Enamel Knot is a permanent structure that becomes the primary cusp of the tooth.",
    answer: false,
    explain: "The Enamel Knot is a transient signaling center that disappears after it influences cusp development; it does not become the cusp itself."
  },
  {
    q: "The physiological stage of 'Apposition' refers to the layering of enamel and dentin matrix.",
    answer: true,
    explain: "Apposition is the physiological process of depositing the extracellular matrix of the hard dental tissues in incremental layers."
  },
  {
    q: "The vestibular lamina is responsible for forming the tongue.",
    answer: false,
    explain: "The vestibular lamina is a proliferation of the primary epithelial band that hollows out to form the vestibule, the space between the cheek/lips and the alveolar ridge."
  },
  {
    q: "In the cap stage, the enamel organ has a convex inner surface and a concave outer surface.",
    answer: false,
    explain: "The cap-shaped enamel organ has a convex outer surface and a concave inner surface that fits over the dental papilla."
  },
  {
    q: "The 'Tooth Germ' refers only to the enamel organ and the dental papilla.",
    answer: false,
    explain: "The Tooth Germ is composed of three parts: the enamel organ, the dental papilla, AND the dental sac (follicle)."
  }
];

const saqs = [
  {
    q: "Define the term 'Odontogenesis' and list the three main morphological stages of tooth development discussed in the lecture.",
    a: "Odontogenesis is the complex biological process of tooth development. The three main morphological stages are: <br>1. Bud Stage <br>2. Cap Stage <br>3. Bell Stage"
  },
  {
    q: "List the three adult derivatives that arise from the Dental Sac (Dental Follicle).",
    a: "The three adult derivatives of the Dental Sac are: <ol><li>Cementum</li><li>Periodontal Ligament</li><li>Alveolar Bone</li></ol>"
  },
  {
    q: "An embryo at the 8th week of intrauterine life is examined. A developing tooth shows an epithelial structure with a distinct outer cuboidal cell layer, an inner low columnar cell layer, and a central core of star-shaped cells. What morphological stage is this tooth in, and what is the central core called?",
    a: "Based on the cellular differentiation into distinct layers (outer, inner, and central), the tooth is in the <strong>Cap Stage</strong>. The central core of star-shaped cells is called the <strong>Stellate Reticulum</strong>."
  },
  {
    q: "Explain the process that causes the polygonal cells in the center of the enamel organ to become the star-shaped cells of the stellate reticulum.",
    a: "The centrally located polygonal cells synthesize and secrete hydrophilic Glycosaminoglycans (GAGs). These GAGs pull water into the enamel organ from the dental papilla. The increased fluid volume pushes the cells apart, causing them to stretch and assume a star shape while maintaining contact with each other through cytoplasmic processes."
  },
  {
    q: "Compare the cellular morphology of the Outer Enamel Epithelium and the Inner Enamel Epithelium during the Cap Stage.",
    a: "A comparison of the two epithelia in the cap stage is as follows: <ol><li><strong>Outer Enamel Epithelium (OEE):</strong> Covers the outer convexity of the enamel organ and consists of <strong>cuboidal cells</strong>.</li><li><strong>Inner Enamel Epithelium (IEE):</strong> Covers the inner concavity of the enamel organ and consists of <strong>low columnar cells</strong>.</li></ol>"
  },
  {
    q: "Describe the 'Cervical Loop', including its location and its significance in future tooth development.",
    a: "The Cervical Loop is the region at the rim of the enamel organ where the cuboidal cells of the Outer Enamel Epithelium meet the columnar cells of the Inner Enamel Epithelium. It is a zone of intense mitotic activity, and its significance is that it marks the site where root formation will begin after the crown is complete."
  }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[j]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
