<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table{width:100%;border-collapse:collapse;text-align:left;}
  .answer th, .answer td{padding:8px;border:1px solid var(--card-border);}
  .answer tr:nth-child(odd){background:rgba(255,255,255,0.05);}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 22</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  {
    q: "What is the primary function of cementum?",
    opts: ["Anchorage of periodontal ligament fibers", "Providing nutrition to the dentin", "Forming the bulk of the tooth structure", "Responding to sensory stimuli"],
    correct: 0,
    explain: "The main function of cementum is to provide a medium for the attachment of collagen fibers from the periodontal ligament, thus anchoring the tooth to the alveolar bone."
  },
  {
    q: "Which condition is characterized by an almost total absence of cementum, leading to premature tooth loss?",
    opts: ["Paget's disease", "Hypophosphatasia", "Acromegaly", "Hypercementosis"],
    correct: 1,
    explain: "Hypophosphatasia is a rare hereditary disease where the lack of cementum formation results in failed PDL attachment and subsequent premature loss of deciduous teeth."
  },
  {
    q: "How does cementum deposition compensate for occlusal wear?",
    opts: ["By increasing its vascularity", "By resorbing at the cervical margin", "By depositing new cementum in the apical area", "By forming enamel-like structures"],
    correct: 2,
    explain: "Continuous deposition of cementum at the apex allows for slight tooth eruption, which compensates for the loss of tooth substance from occlusal wear and maintains proper occlusion."
  },
  {
    q: "Which type of cementum is formed during rapid repair of root damage?",
    opts: ["Acellular afibrillar cementum", "Acellular primary cementum", "Cellular cementum", "Mixed cementum"],
    correct: 2,
    explain: "Cellular cementum forms faster than acellular cementum and is typically responsible for repairing damage to roots, such as fractures and resorptions."
  },
  {
    q: "Where is acellular primary cementum typically located?",
    opts: ["Only at the apex of the root", "From the cervical margin to the apical third", "Exclusively in furcation areas", "Overlying enamel spurs"],
    correct: 1,
    explain: "Acellular (primary) cementum is the first type formed and covers the root from the cementoenamel junction to the apical third, primarily serving an anchorage function."
  },
  {
    q: "How does cementum receive its nutrition?",
    opts: ["From internal blood vessels", "Directly from the dentin", "From the surrounding vascular periodontal ligament", "It does not require nutrition"],
    correct: 2,
    explain: "Cementum is avascular, meaning it has no internal blood supply. It receives all its nutrients from the blood vessels within the adjacent periodontal ligament."
  },
  {
    q: "What is the term for the abnormal thickening of cementum?",
    opts: ["Ankylosis", "Cemental tear", "Hypoplasia", "Hypercementosis"],
    correct: 3,
    explain: "Hypercementosis is the excessive deposition of cementum on the root surface, which can be localized to one tooth or generalized across the dentition."
  },
  {
    q: "Generalized hypercementosis is a known oral manifestation of which systemic disease?",
    opts: ["Hypophosphatasia", "Diabetes", "Paget's disease", "Arthritis"],
    correct: 2,
    explain: "Paget's disease of bone is a systemic condition that can cause generalized hypercementosis, affecting multiple teeth."
  },
  {
    q: "What are the spikelike excrescences sometimes seen in hypercementosis?",
    opts: ["Calcified enamel drops", "Resorbed areas of dentin", "Coalescence of cementicles or calcified PDL fibers", "Newly formed blood vessels"],
    correct: 2,
    explain: "These prong-like extensions can be due to the fusion of free cementicles to the root surface or the calcification of periodontal fibers at their insertion sites."
  },
  {
    q: "In 'functional repair' of cementum resorption, how is the normal width of the PDL space restored?",
    opts: ["By depositing a thick layer of new cementum", "By the formation of a bony projection", "By shrinking the periodontal ligament", "By resorbing the opposing bone"],
    correct: 1,
    explain: "In functional repair, only a thin layer of cementum is deposited on the resorbed root. The normal PDL width is then re-established by the apposition of new bone on the alveolar side."
  },
  {
    q: "Which property makes cementum more resistant to resorption than bone?",
    opts: ["Its higher mineral content", "Its avascular nature", "Its rich nerve supply", "Its rapid remodeling capacity"],
    correct: 1,
    explain: "Cementum's lack of vascularity makes it more resistant to pressure-induced resorption compared to the highly vascular alveolar bone, which is a key principle in orthodontics."
  },
  {
    q: "What is a 'cemental tear'?",
    opts: ["A developmental defect in cementum", "A type of root caries", "Fragments of cementum severed from the dentin", "A form of hypercementosis"],
    correct: 2,
    explain: "A cemental tear is an injury, often due to a severe blow or trauma, where a piece of the cementum layer is fractured and detached from the underlying dentin."
  },
  {
    q: "What is the fusion of bone and cementum called?",
    opts: ["Hyperplasia", "Dysplasia", "Ankylosis", "Concrescence"],
    correct: 2,
    explain: "Ankylosis is the fusion of the alveolar bone directly to the cementum, which obliterates the periodontal ligament space and immobilizes the tooth."
  },
  {
    q: "Compared to bone, cementum has a:",
    opts: ["Lower inorganic content", "Higher rate of apposition", "Higher remodeling capacity", "Rich nerve supply"],
    correct: 0,
    explain: "Cementum is about 45% inorganic material, whereas bone is about 67% inorganic. Bone also has a much faster apposition rate and effective remodeling capacity."
  },
  {
    q: "What cells are responsible for producing cementum?",
    opts: ["Odontoblasts", "Osteoblasts", "Cementoblasts", "Ameloblasts"],
    correct: 2,
    explain: "Cementoblasts are the cells that form cementum. They are derived from either HERS (Hertwig's Epithelial Root Sheath) or the dental follicle."
  },
  {
    q: "Which type of cementum is found in the middle to apical third of the root and in furcations?",
    opts: ["Acellular afibrillar", "Acellular primary", "Cellular secondary", "Enameloid cementum"],
    correct: 2,
    explain: "Cellular (secondary) cementum is typically found in the apical and interradicular regions, where it plays a role in adaptation and repair."
  },
  {
    q: "What is the primary organic component of both cementum and bone matrix?",
    opts: ["Type I collagen", "Elastin fibers", "Keratin", "Type IV collagen"],
    correct: 0,
    explain: "The extracellular matrix of both cementum and bone is predominantly composed of Type I collagen fibers, providing a scaffold for mineralization."
  },
  {
    q: "What happens to cementocytes in older layers of thick cementum?",
    opts: ["They transform into cementoblasts", "They increase in number and size", "They gradually die", "They migrate to the PDL"],
    correct: 2,
    explain: "As cementum thickness increases with age, the cementocytes trapped deep within the matrix (lacunae) lose access to nutrition from the PDL and eventually die."
  },
  {
    q: "Acellular afibrillar cementum is most commonly found:",
    opts: ["At the root apex", "In furcation areas", "As spurs or patches over enamel near the CEJ", "Uniformly covering the entire root"],
    correct: 2,
    explain: "This specific type of cementum, lacking fibers and cells, is found in small patches near the cementoenamel junction and is considered to have no known function."
  },
  {
    q: "What is the main purpose of localized hypercementosis, such as a spur-like extension?",
    opts: ["To repair a root fracture", "To increase the surface area for fiber attachment", "To fight periapical infection", "To compensate for enamel loss"],
    correct: 1,
    explain: "In teeth exposed to great stress, localized hypercementosis can form to provide a larger surface area for the periodontal ligament fibers to attach, resulting in a firmer anchorage."
  },
  {
    q: "Radiographically, how can hypercementosis be distinguished from normal root structure?",
    opts: ["There is no visible periodontal ligament space around it", "It appears radiolucent compared to dentin", "The PDL and lamina dura are seen enveloping it", "It always fuses with the alveolar bone"],
    correct: 2,
    explain: "A key diagnostic feature is that the radiolucent PDL shadow and radiopaque lamina dura are always seen on the outer border of the hypercementosis area, just as they would be on a normal root."
  },
  {
    q: "The rate of apposition for acellular cementum is approximately:",
    opts: ["1-2 µm/day", "10-15 µm/day", "0.005-0.01 µm/day", "0.5-1 µm/day"],
    correct: 2,
    explain: "Acellular cementum forms very slowly, at a rate of 0.005-0.01 µm/day, compared to lamellar bone which forms at a much faster rate of 1-2 µm/day."
  },
  {
    q: "Which non-collagenous proteins are present in both cementum and bone?",
    opts: ["Amelogenin and Enamelin", "Keratin and Fibrillin", "Bone sialoprotein and Osteopontin", "Dentin phosphoprotein and DSP"],
    correct: 2,
    explain: "Bone sialoprotein and Osteopontin are key non-collagenous proteins involved in mineralization and are found in both bone and, in smaller quantities, cementum."
  },
  {
    q: "In which situation might a tooth with hypercementosis require sectioning before extraction?",
    opts: ["If it is a single-rooted anterior tooth", "If the hypercementosis is very minor", "If it is a multi-rooted tooth with bulbous roots", "If the patient has Paget's disease"],
    correct: 2,
    explain: "If a multi-rooted tooth has significant hypercementosis, the enlarged, bulbous roots can lock it into the socket, necessitating surgical sectioning of the tooth for a successful extraction."
  },
  {
    q: "What causes alterations in the physical and chemical characteristics of cementum exposed in periodontal pockets?",
    opts: ["Excessive occlusal forces", "Systemic diseases like diabetes", "Plaque and its by-products", "Age-related changes"],
    correct: 2,
    explain: "When cementum is exposed to the oral environment due to periodontal disease, bacterial plaque and its toxins can alter its surface, which may interfere with healing."
  },
  {
    q: "The function of 'Adaptation' for cellular cementum is best demonstrated in which location?",
    opts: ["Cervical third of the root", "Middle to apical third and furcations", "Cementoenamel junction", "Entire root surface uniformly"],
    correct: 1,
    explain: "Cellular cementum is primarily located in the apical and furcation areas, where its faster deposition rate allows it to adapt to tooth movement and repair damage."
  },
  {
    q: "The inorganic component of cementum is predominantly:",
    opts: ["Fluorapatite", "Calcium carbonate", "Calcium and phosphate as hydroxyapatite", "Magnesium phosphate"],
    correct: 2,
    explain: "Similar to other hard tissues like bone and dentin, the mineral component of cementum is mainly calcium and phosphate in the form of hydroxyapatite crystals."
  },
  {
    q: "Which cells are involved in the resorption of cementum?",
    opts: ["Cementoclasts (Odontoclasts)", "Osteoblasts", "Fibroblasts", "Cementocytes"],
    correct: 0,
    explain: "Odontoclasts (sometimes called cementoclasts when acting on cementum) are large, multinucleated cells responsible for resorbing dental hard tissues."
  },
  {
    q: "The continuous formation of cementum helps to maintain the width of the:",
    opts: ["Pulp chamber", "Dentin tubules", "Periodontal ligament", "Lamina dura"],
    correct: 2,
    explain: "As new layers of cementum are added to the root, it helps maintain a consistent width for the periodontal ligament, which is crucial for proper tooth function and support."
  },
  {
    q: "Which type of cementum has fibers that are entirely of intrinsic origin (from cementoblasts)?",
    opts: ["Acellular primary cementum", "Cellular secondary cementum", "Mixed cementum", "Acellular afibrillar cementum"],
    correct: 1,
    explain: "Cellular cementum contains intrinsic fibers, which are produced by the cementoblasts themselves. In contrast, acellular cementum's fibers are primarily extrinsic (Sharpey's fibers from the PDL)."
  }
];

const tfs = [
  {
    q: "Cementum is a vascular tissue with a rich nerve supply.",
    answer: false,
    explain: "Cementum is avascular (no blood vessels) and has no nerve supply. It receives its nutrition from the adjacent periodontal ligament."
  },
  {
    q: "The thickness of cementum generally decreases with age.",
    answer: false,
    explain: "Cementum thickness triples from age 10 to 75. This deposition, especially at the apex, compensates for occlusal wear."
  },
  {
    q: "Generalized hypercementosis can be associated with Paget's disease.",
    answer: true,
    explain: "Paget's disease is a systemic bone disorder that is known to cause generalized, excessive deposition of cementum on the roots of teeth."
  },
  {
    q: "Anatomic repair of cementum completely restores the original root outline.",
    answer: true,
    explain: "In anatomic repair, new cementum is deposited in the resorbed area to a degree that it fully reconstructs the original contour of the root surface."
  },
  {
    q: "Bone is more resistant to resorption than cementum.",
    answer: false,
    explain: "Cementum is more resistant to resorption than bone, primarily because it is avascular. This principle is fundamental to orthodontic tooth movement."
  },
  {
    q: "Cellular cementum is mainly responsible for anchorage.",
    answer: false,
    explain: "The primary function of cellular cementum is adaptation and repair. Anchorage is the primary function of acellular cementum."
  },
  {
    q: "Cementum can form throughout the life of a tooth.",
    answer: true,
    explain: "Like other dental hard tissues, cementum deposition is a continuous process that occurs throughout the life of the tooth, allowing for adaptation and repair."
  },
  {
    q: "The inorganic mineral content of cementum is higher than that of bone.",
    answer: false,
    explain: "Cementum has a lower inorganic content (~45%) compared to bone (~67%), making it a softer hard tissue."
  },
  {
    q: "A cemental tear can result from severe trauma to a tooth.",
    answer: true,
    explain: "A severe blow or excessive occlusal force can cause a fracture in the cementum layer, separating fragments of it from the underlying dentin."
  }
];

const saqs = [
  {
    q: "Describe the process of 'functional repair' following cemental resorption.",
    a: "Functional repair occurs when the resorbed area on the root is repaired with only a thin layer of new cementum, which does not restore the original root contour. To compensate and restore the normal width of the periodontal ligament space, new alveolar bone is deposited on the opposing socket wall."
  },
  {
    q: "List the four main types of cementum classified by cellularity and fiber origin.",
    a: "<ol style='padding-left:20px;'><li><b>Acellular (primary) cementum:</b> Extrinsic fibers, for anchorage.</li><li><b>Cellular (secondary) cementum:</b> Intrinsic fibers, for adaptation/repair.</li><li><b>Mixed cementum:</b> Alternating layers with intrinsic and extrinsic fibers.</li><li><b>Acellular afibrillar cementum:</b> No cells or fibers, found near CEJ.</li></ol>"
  },
  {
    q: "Explain why cementum is more resistant to resorption than bone during orthodontic tooth movement.",
    a: "Cementum's higher resistance to resorption is primarily attributed to it being avascular and having a protective surface layer of cementoid. The lack of blood supply makes it less susceptible to the pressure-induced resorption process that readily affects the vascular alveolar bone, allowing the tooth to move through the bone."
  },
  {
    q: "A radiograph of a patient's molar shows a localized, bulbous enlargement of the root in the apical third, but the periodontal ligament space and lamina dura appear intact around the enlargement. What is this condition called and what is a common local cause?",
    a: "This condition is <b>hypercementosis</b> (localized). A common local cause is excessive occlusal stress or chronic periapical inflammation, which stimulates cementoblasts to deposit excessive amounts of cementum as an adaptive response."
  },
  {
    q: "List the three primary functions of cementum.",
    a: "<ol style='padding-left:20px;'><li><b>Anchorage:</b> To provide attachment for the collagen fibers of the periodontal ligament, securing the tooth in the alveolar bone.</li><li><b>Adaptation:</b> To compensate for tooth wear and maintain tooth position through continuous deposition, especially at the apex.</li><li><b>Repair:</b> To repair root fractures and resorptive defects on the root surface.</li></ol>"
  },
  {
    q: "Present a comparison between cementum and bone regarding their vascularity, nerve supply, and remodeling capacity.",
    a: "<table><thead><tr><th>Feature</th><th>Cementum</th><th>Bone</th></tr></thead><tbody><tr><td>Vascularity</td><td>Avascular (no blood vessels)</td><td>Vascular (contains blood vessels)</td></tr><tr><td>Nerve Supply</td><td>Lacks nerve supply</td><td>Richly innervated</td></tr><tr><td>Remodeling Capacity</td><td>Limited remodeling</td><td>Effective and continuous remodeling</td></tr></tbody></table>"
  }
];


// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    toggleBtn.classList.toggle('primary', now);
    toggleBtn.classList.toggle('ghost', !now);
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  if (!confirm('Are you sure you want to reset all answers and scores?')) {
    return;
  }
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{
      b.textContent="I was correct";
      b.style.outline="none";
      b.classList.remove('primary');
      b.classList.add('ghost');
  });


  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

// Initial calculation on load
recalc();
</script>
</body>
</html>
