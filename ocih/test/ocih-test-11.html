<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
  table{width:100%;border-collapse:collapse;}
  th,td{border:1px solid var(--card-border);padding:8px;text-align:left;}
  th{background-color:var(--glass);}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57Q3BDNKFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-57Q3BDNKFW');
</script>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 11</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  {
    q: "During which period of intrauterine life does the TMJ originate?",
    opts: ["2nd-4th week", "6th-8th week", "10th-12th week", "14th-16th week"],
    correct: 1,
    explain: "The TMJ develops from the first pharyngeal arch (Meckel's cartilage) during the 6th-8th week of intrauterine life."
  },
  {
    q: "The TMJ is classified as what type of joint?",
    opts: ["Fibrous joint", "Cartilaginous joint", "Synovial joint", "Suture joint"],
    correct: 2,
    explain: "The TMJ is a synovial joint, specifically a ginglymodiarthrodial joint, allowing for complex movements."
  },
  {
    q: "Which movement is characteristic of a 'ginglymoid' joint action in the TMJ?",
    opts: ["Forward sliding", "Side-to-side movement", "Pivoting", "Hinging"],
    correct: 3,
    explain: "A ginglymoid joint performs a hinging movement, which in the TMJ is the rotation responsible for the initial opening and closing of the mouth."
  },
  {
    q: "What is the primary function of the synovial fluid in the TMJ?",
    opts: ["Nourishment", "Shock absorption", "Lubrication", "Growth"],
    correct: 2,
    explain: "Synovial fluid provides lubrication to reduce friction between the articular surfaces during movement."
  },
  {
    q: "The articular disc of the TMJ is primarily composed of what tissue?",
    opts: ["Elastic cartilage", "Hyaline cartilage", "Fibrous connective tissue", "Adipose tissue"],
    correct: 2,
    explain: "The articular disc is composed of dense fibrous connective tissue, which is avascular and aneural in its central part."
  },
  {
    q: "Which part of the articular disc is normally in contact with the articular surface of the condyle?",
    opts: ["Anterior band", "Posterior band", "Intermediate zone", "Retrodiscal tissue"],
    correct: 2,
    explain: "In a normal joint, the thinnest part, the intermediate zone of the disc, is located on the articular surface of the condyle."
  },
  {
    q: "What is the main role of ligaments in the TMJ?",
    opts: ["To actively move the joint", "To produce synovial fluid", "To passively limit extreme movements", "To provide blood supply"],
    correct: 2,
    explain: "Ligaments do not actively control joint movement; they act as passive restraints to limit and restrict extreme movements."
  },
  {
    q: "Which ligament is considered an 'accessory' ligament of the TMJ?",
    opts: ["Collateral ligament", "Capsular ligament", "Temporomandibular ligament", "Sphenomandibular ligament"],
    correct: 3,
    explain: "The sphenomandibular and stylomandibular ligaments are classified as accessory ligaments."
  },
  {
    q: "What is the function of the capsular ligament?",
    opts: ["Limit protrusive movements", "Restrict disc movement away from the condyle", "Encompass the joint and retain synovial fluid", "Limit posterior condyle movement"],
    correct: 2,
    explain: "The capsular ligament's function is to encompass the entire joint, thus retaining the synovial fluid."
  },
  {
    q: "Which muscle is NOT a primary muscle of mastication?",
    opts: ["Masseter", "Temporalis", "Digastric", "Medial pterygoid"],
    correct: 2,
    explain: "The digastric muscle is part of the suprahyoid group and is considered a secondary muscle of mastication."
  },
  {
    q: "The primary blood supply to the TMJ comes from which arteries?",
    opts: ["Facial and lingual arteries", "Superficial temporal and maxillary arteries", "Occipital and posterior auricular arteries", "Ascending pharyngeal and internal carotid arteries"],
    correct: 1,
    explain: "The TMJ receives its blood supply from branches of the superficial temporal and maxillary arteries."
  },
  {
    q: "What is the main nerve supplying the TMJ?",
    opts: ["Facial nerve", "Masseteric nerve", "Auriculotemporal nerve", "Buccal nerve"],
    correct: 2,
    explain: "The auriculotemporal nerve, a branch of the mandibular nerve (V3), provides the primary sensory innervation to the TMJ."
  },
  {
    q: "Which imaging modality is best for visualizing the soft tissues of the TMJ, such as the articular disc?",
    opts: ["Panoramic radiography (OPG)", "Cone Beam Computed Tomography (CBCT)", "Magnetic Resonance Imaging (MRI)", "Conventional radiograph"],
    correct: 2,
    explain: "MRI is the preferred imaging modality for detailed evaluation of the soft tissues of the TMJ, including the position and integrity of the articular disc."
  },
  {
    q: "The temporal component of the TMJ is part of which bone?",
    opts: ["Zygomatic bone", "Sphenoid bone", "Temporal bone", "Parietal bone"],
    correct: 2,
    explain: "The mandibular fossa and articular eminence are parts of the squamous portion of the temporal bone."
  },
  {
    q: "Which ligament primarily limits excessive protrusive movements of the mandible?",
    opts: ["Sphenomandibular ligament", "Stylomandibular ligament", "Temporomandibular ligament", "Collateral ligament"],
    correct: 1,
    explain: "The stylomandibular ligament tightens during protrusion and thus limits excessive forward movement of the mandible."
  },
  {
    q: "The articular surfaces of the TMJ are covered by what type of tissue?",
    opts: ["Hyaline cartilage", "Elastic cartilage", "Fibrocartilage", "Simple squamous epithelium"],
    correct: 2,
    explain: "Unlike most synovial joints, the articulating surfaces of the TMJ condyle and fossa are covered by dense fibrocartilage, not hyaline cartilage."
  },
  {
    q: "The development of the articular disc occurs from the condensation of which tissue?",
    opts: ["Endoderm", "Ectoderm", "Mesenchyme", "Notochord"],
    correct: 2,
    explain: "The articular disc develops during the 12th week from the condensation of the mesenchyme located between the developing condyle and temporal bone."
  },
  {
    q: "'Weeping lubrication' in the TMJ refers to:",
    opts: ["Friction prevention in a moving joint", "Lubricant preventing sticking during compression", "Synovial fluid production", "The breakdown of lubrication"],
    correct: 1,
    explain: "Weeping lubrication acts to prevent sticking between articular surfaces when they are under compressive forces."
  },
  {
    q: "The collateral (discal) ligaments attach the disc to which structure?",
    opts: ["The temporal bone", "The sphenoid bone", "The medial and lateral poles of the condyle", "The joint capsule anteriorly"],
    correct: 2,
    explain: "The collateral ligaments attach the medial and lateral borders of the articular disc to the corresponding poles of the mandibular condyle."
  },
  {
    q: "Which part of the mandible articulates with the temporal bone?",
    opts: ["Coronoid process", "Ramus", "Angle of the mandible", "Mandibular condyle"],
    correct: 3,
    explain: "The mandibular condyle is the specific part of the mandible that serves as the articulating surface within the TMJ."
  },
  {
    q: "An 'arthrodial' joint action allows for what type of movement?",
    opts: ["Hinging", "Gliding", "Pivoting", "Flexion"],
    correct: 1,
    explain: "An arthrodial joint is a gliding joint. In the TMJ, this refers to the forward and backward sliding motion (translation) of the condyle and disc."
  },
  {
    q: "Which conventional radiographic view provides a broad overview of the TMJ and surrounding structures?",
    opts: ["Periapical X-ray", "Bitewing X-ray", "Panoramic image (OPG)", "Cephalometric X-ray"],
    correct: 2,
    explain: "A panoramic image is a useful screening tool for a broad, general overview of the TMJ's osseous structures."
  },
  {
    q: "The upper and lower joint compartments are formed by the:",
    opts: ["Synovial membrane", "Articular disc", "Capsular ligament", "Retrodiscal tissue"],
    correct: 1,
    explain: "The articular disc and its attachments divide the joint space into a superior (upper) and inferior (lower) compartment."
  },
  {
    q: "The retrodiscal tissue is highly vascularized and innervated.",
    opts: ["This statement is true", "This statement is false", "It is only vascularized", "It is only innervated"],
    correct: 0,
    explain: "The retrodiscal tissue is a pad of loose connective tissue located posterior to the disc, and it is rich in blood vessels and nerve fibers."
  },
  {
    q: "Which part of the temporomandibular ligament limits posterior movement of the condyle?",
    opts: ["Outer oblique portion", "Inner horizontal portion", "Superior lamina", "Inferior lamina"],
    correct: 1,
    explain: "The inner horizontal portion of the temporomandibular ligament limits posterior movement of the condyle and disc."
  },
  {
    q: "When does the TMJ typically achieve its adult morphology and functional maturation?",
    opts: ["At birth", "By age 6", "During adolescence (16-20 years)", "After age 30"],
    correct: 2,
    explain: "While structurally present at birth, complete functional maturation and remodeling of the TMJ are usually achieved by 16-20 years of age."
  },
  {
    q: "The mandibular fossa is also known as the:",
    opts: ["Articular eminence", "Glenoid fossa", "Zygomatic process", "Pterygoid fossa"],
    correct: 1,
    explain: "The mandibular fossa is also referred to as the articular fossa or glenoid fossa."
  },
  {
    q: "Which imaging modality is primarily used to assess the osseous (bony) structures of the TMJ in detail?",
    opts: ["MRI", "Ultrasonography", "CBCT or MDCT", "Panoramic imaging"],
    correct: 2,
    explain: "CBCT (Cone Beam Computed Tomography) or MDCT provides detailed, multi-planar images of the bony components of the joint."
  },
  {
    q: "The superior head of which muscle attaches to the joint capsule and articular disc?",
    opts: ["Medial Pterygoid", "Temporalis", "Masseter", "Lateral Pterygoid"],
    correct: 3,
    explain: "The superior head of the lateral pterygoid muscle has fibers that attach directly to the anteromedial part of the articular disc and capsule."
  },
  {
    q: "What is the primary mechanism of lubrication in a moving TMJ?",
    opts: ["Weeping lubrication", "Hydrostatic lubrication", "Boundary lubrication", "Elastohydrodynamic lubrication"],
    correct: 2,
    explain: "Boundary lubrication is the primary mechanism that prevents friction in the moving joint."
  }
];

const tfs = [
  {
    q: "The articular disc of the TMJ is highly vascular and contains numerous nerve fibers throughout its entirety.",
    answer: false,
    explain: "The central, articulating portion of the disc is avascular and aneural. Only the periphery is slightly innervated."
  },
  {
    q: "The TMJ is considered a ginglymodiarthrodial joint, capable of both hinging and gliding movements.",
    answer: true,
    explain: "It combines the characteristics of a ginglymoid (hinge) joint and an arthrodial (gliding) joint."
  },
  {
    q: "Ligaments in the TMJ are responsible for actively initiating joint movement.",
    answer: false,
    explain: "Ligaments are passive structures; their role is to restrict and limit the range of motion, not to actively produce it. Muscles initiate movement."
  },
  {
    q: "The upper and lower synovial cavities of the TMJ normally communicate with each other.",
    answer: false,
    explain: "The articular disc completely separates the joint into two distinct upper and lower cavities that do not normally communicate."
  },
  {
    q: "The sphenomandibular ligament has significant limiting effects on normal mandibular movements.",
    answer: false,
    explain: "The lecture slide states that this ligament 'does not have any significant limiting effects on mandibular movements'."
  },
  {
    q: "The auriculotemporal nerve is the primary source of sensory innervation to the TMJ.",
    answer: true,
    explain: "The auriculotemporal nerve, along with branches from the masseteric and deep temporal nerves, supplies the joint."
  },
  {
    q: "Magnetic Resonance Imaging (MRI) is the best modality for assessing the bony structures of the TMJ.",
    answer: false,
    explain: "MRI excels at visualizing soft tissues like the disc and capsule. CBCT or MDCT is superior for detailed imaging of osseous (bony) structures."
  },
  {
    q: "Complete functional maturation of the TMJ is achieved at birth.",
    answer: false,
    explain: "While structurally present, the TMJ continues to remodel and functionally matures during adolescence, typically by 16-20 years of age."
  },
  {
    q: "The digastric muscle is classified as a primary muscle of mastication.",
    answer: false,
    explain: "The digastric is a suprahyoid muscle and is considered a secondary or supplementary muscle of mastication, not a primary one."
  }
];

const saqs = [
  {
    q: "Describe the composition and vascularity of the articular disc of the TMJ.",
    a: "The articular disc is composed of dense fibrous connective tissue. It is notably avascular (lacks blood vessels) and aneural (lacks nerves) in its central, load-bearing area. The periphery of the disc, however, is slightly innervated."
  },
  {
    q: "List the three functional ligaments that support the TMJ.",
    a: `
      <table>
        <thead><tr><th>#</th><th>Ligament</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Collateral (discal) ligament</td></tr>
          <tr><td>2</td><td>Capsular ligament</td></tr>
          <tr><td>3</td><td>Temporomandibular ligament</td></tr>
        </tbody>
      </table>
    `
  },
  {
    q: "Compare the primary functions of 'weeping' and 'boundary' lubrication in the TMJ.",
    a: `
      <table>
        <thead>
          <tr><th>#</th><th>Lubrication Type</th><th>Primary Function</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>Weeping Lubrication</td><td>Acts as a lubricant between articular surfaces to prevent sticking during compressive forces.</td></tr>
          <tr><td>2</td><td>Boundary Lubrication</td><td>Prevents friction in the moving joint and is considered the primary mechanism for overall lubrication during function.</td></tr>
        </tbody>
      </table>
    `
  },
  {
    q: "A dental student is examining a patient who cannot fully open their mouth. The student suspects an issue with the primary muscles of mastication. List the four primary muscles responsible for jaw movement.",
    a: `
      <table>
        <thead><tr><th>#</th><th>Primary Muscle of Mastication</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Masseter</td></tr>
          <tr><td>2</td><td>Temporalis</td></tr>
          <tr><td>3</td><td>Medial pterygoid</td></tr>
          <tr><td>4</td><td>Lateral pterygoid</td></tr>
        </tbody>
      </table>
    `
  },
  {
    q: "Explain the main difference in what is visualized between an MRI and a CBCT when imaging the TMJ.",
    a: "The main difference is the type of tissue each modality is best suited to visualize. An MRI excels at showing the soft tissues of the joint, such as the articular disc, muscles, and any inflammation or fluid (effusion). In contrast, a CBCT (or MDCT) is superior for providing detailed images of the hard, osseous structures, like the mandibular condyle and temporal fossa, allowing for assessment of bone morphology and integrity."
  },
  {
    q: "Briefly outline the key developmental stages of the TMJ, starting from the 6th week of intrauterine life.",
    a: "The TMJ develops from the first pharyngeal arch around the 6th-8th week. Condylar and temporal blastemas form first. By the 10th-12th week, joint cavities form through cavitation of mesenchyme. The articular disc condenses from this mesenchyme around the 12th week. Finally, the capsule and ligaments develop between the 12th-20th week, with functional adaptation continuing postnatally."
  }
];


// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      const originalIndex = visualToOriginal[v];
      state.mcq[idx] = originalIndex; // Save the original index for scoring logic

      // Mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      const isCorrect = (v === correctVisualIndex);

      if(!isCorrect){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      const isCorrect = (val === item.answer);

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((score, selectedIdx, questionIdx) => {
    // Note: selectedIdx here is the original index of the option.
    if (selectedIdx === null) return score;
    const correctOriginalIndex = mcqs[questionIdx].correct;
    // We need to re-find the visual index that was clicked. This is tricky without more state.
    // A simpler way is to check the feedback text on the card.
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${questionIdx}"]`);
    if(card && card.dataset.locked === 'true'){
        const feedback = card.querySelector('.feedback').textContent;
        if(feedback.startsWith("Correct")){
            return score + 1;
        }
    }
    return score;
  }, 0);

  const tfScore = state.tf.reduce((score, selectedValue, questionIdx) => {
    if (selectedValue === null) return score;
    const isCorrect = selectedValue === tfs[questionIdx].answer;
    return score + (isCorrect ? 1 : 0);
  }, 0);

  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc(); // Initial calculation
</script>
</body>
</html>
