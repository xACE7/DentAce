<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Dentin Part 3</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table{width:100%;border-collapse:collapse;margin-top:8px;}
  .answer th, .answer td{border:1px solid var(--glass-border);padding:8px;text-align:left;}
  .answer th{background-color:var(--glass);}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 19</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  { q: "Which type of dentin forms the bulk of the tooth structure before root completion?", opts: ["Secondary dentin", "Tertiary dentin", "Primary dentin", "Mantle dentin"], correct: 2, explain: "Primary dentin, which includes mantle and circumpulpal dentin, forms most of the tooth before the root is fully developed." },
  { q: "The outermost layer of primary dentin, located just beneath the enamel, is known as:", opts: ["Circumpulpal dentin", "Mantle dentin", "Predentin", "Secondary dentin"], correct: 1, explain: "Mantle dentin is the first-formed layer of dentin, situated directly adjacent to the dentino-enamel junction (DEJ)." },
  { q: "When does the formation of secondary dentin typically begin?", opts: ["During crown formation", "Immediately after tooth eruption", "After root formation is completed", "In response to trauma"], correct: 2, explain: "Secondary dentin is a physiological type of dentin that starts forming at a slow rate only after the tooth's root is fully developed." },
  { q: "Compared to primary dentin, the tubular structure of secondary dentin is generally:", opts: ["More regular and straight", "Less regular with a wavy course", "Completely atubular", "Wider in diameter"], correct: 1, explain: "Secondary dentin tubules are less regular and show a distinct change in direction from primary dentin tubules." },
  { q: "The uneven deposition of secondary dentin, particularly on the roof and floor of the pulp chamber, leads to a condition called:", opts: ["Pulp exposure", "Pulp recession", "Dentin sclerosis", "Dead tracts"], correct: 1, explain: "This uneven deposition gradually reduces the size of the pulp space, a process known as pulp recession." },
  { q: "Tertiary dentin is formed in response to which of the following stimuli?", opts: ["Physiological aging", "Systemic disease", "Dental caries", "Normal mastication"], correct: 2, explain: "Tertiary dentin is a localized, defensive response to stimuli like tooth wear, caries, or restorative procedures." },
  { q: "Which type of tertiary dentin is formed by surviving odontoblasts in response to a mild stimulus?", opts: ["Reparative dentin", "Reactionary dentin", "Osteodentin", "Atubular dentin"], correct: 1, explain: "Reactionary dentin is produced by the original odontoblasts when the stimulus is not severe enough to destroy them." },
  { q: "If a stimulus is aggressive and destroys the original odontoblasts, which cells differentiate to form reparative dentin?", opts: ["Fibroblasts", "Cementoblasts", "Ameloblasts", "Undifferentiated mesenchymal cells"], correct: 3, explain: "Undifferentiated mesenchymal cells (UMCs) from the pulp differentiate into new odontoblast-like cells to form reparative dentin." },
  { q: "Which of the following is NOT a potential structural form of reparative dentin?", opts: ["Osteodentin", "Atubular dentin", "Vasodentin", "Mantle dentin"], correct: 3, explain: "Reparative dentin is highly irregular and can be atubular, contain trapped cells (osteodentin), or blood vessels (vasodentin). Mantle dentin is a type of primary dentin." },
  { q: "What is sclerotic dentin?", opts: ["Dentin with empty, wide tubules", "Dentin with occluded, mineralized tubules", "Newly formed unmineralized dentin", "The first layer of dentin formed"], correct: 1, explain: "Sclerosis is an age-related change where the dentinal tubules become completely filled with mineral, making the dentin translucent." },
  { q: "How do 'dead tracts' appear under transmitted light?", opts: ["Translucent or transparent", "White and opaque", "Black", "Yellowish"], correct: 2, explain: "Dead tracts consist of empty dentinal tubules (due to odontoblast death) that fill with air, causing them to appear black under transmitted light." },
  { q: "What is typically formed on the pulpal surface directly underneath a dead tract area?", opts: ["Secondary dentin", "Sclerotic dentin", "Reparative dentin", "Mantle dentin"], correct: 2, explain: "The formation of reparative dentin is a defense mechanism to seal off the pulpal end of the empty tubules in a dead tract." },
  { q: "Which theory of dentin sensitivity is the most widely accepted by the scientific community?", opts: ["Direct Neural Stimulation Theory", "Odontoblastic Transduction Theory", "Hydrodynamic Theory", "Thermal Conduction Theory"], correct: 2, explain: "The Hydrodynamic Theory is the most accepted because it best explains the characteristics of dentin pain in response to various stimuli." },
  { q: "According to the Hydrodynamic Theory, what directly stimulates the pulpal nerve endings?", opts: ["The odontoblast cell body", "Direct contact with a nerve fiber", "Rapid fluid movement within the tubules", "Temperature changes in the dentin matrix"], correct: 2, explain: "This theory posits that stimuli cause fluid to shift within the tubules, and this movement is detected by nerve receptors in the pulp." },
  { q: "A major argument against the Direct Neural Stimulation theory is:", opts: ["The presence of gap junctions", "The absence of nerve fibers in the outer dentin", "The speed of pain transmission", "The effect of local anesthetics on pulp"], correct: 1, explain: "The outer dentin (near the DEJ) is the most sensitive region, yet nerve fibers are not found there, contradicting this theory." },
  { q: "What key cellular component is missing in odontoblasts, which argues against the Odontoblastic Transduction Theory?", opts: ["Mitochondria", "Nucleus", "Vesicles containing neurotransmitters", "Gap junctions"], correct: 2, explain: "For odontoblasts to act as receptor cells that transmit a signal to nerves, they would need neurotransmitter vesicles, which have not been observed." },
  { q: "The profuse branching of dentinal tubules in which region helps explain its heightened sensitivity?", opts: ["The pulp floor", "The cemento-dentinal junction (CDJ)", "The dentino-enamel junction (DEJ)", "The apical foramen"], correct: 2, explain: "The high density and branching of tubules at the DEJ make it a particularly sensitive area, as explained by the Hydrodynamic Theory." },
  { q: "Which dentin is classified as 'physiological' and forms throughout the life of the tooth after root completion?", opts: ["Primary dentin", "Secondary dentin", "Reparative dentin", "Reactionary dentin"], correct: 1, explain: "Secondary dentin is part of the normal aging process and is not a response to a specific stimulus." },
  { q: "Why is there a greater risk of pulp exposure during cavity preparation in younger patients?", opts: ["Their dentin is softer", "They have larger pulp chambers and horns", "They lack secondary dentin", "Their enamel is thinner"], correct: 1, explain: "Due to less pulp recession from secondary dentin deposition, the pulp is closer to the surface in younger teeth." },
  { q: "Sclerotic dentin appears translucent because it has a uniform:", opts: ["Cellular density", "Collagen content", "Refractive index", "Hardness"], correct: 2, explain: "The filling of tubules with mineral makes the refractive index of the tubules the same as the surrounding intertubular dentin, allowing light to pass through uniformly." },
  { q: "The formation of tertiary dentin in response to caries serves as a:", opts: ["Method of nutrition for the pulp", "Defensive barrier to protect the pulp", "Source of new odontoblasts", "Way to increase tooth sensitivity"], correct: 1, explain: "Tertiary dentin increases the thickness of hard tissue between the stimulus (caries) and the pulp, acting as a protective barrier." },
  { q: "Which type of dentin is characterized by having the least regular or even atubular structure?", opts: ["Mantle dentin", "Circumpulpal dentin", "Secondary dentin", "Tertiary dentin"], correct: 3, explain: "Tertiary dentin, especially reparative dentin, is formed rapidly and has a very irregular, and sometimes completely atubular, structure." },
  { q: "The cells that form primary and secondary dentin are called:", opts: ["Ameloblasts", "Odontoblasts", "Cementoblasts", "Fibroblasts"], correct: 1, explain: "Odontoblasts are the cells responsible for forming physiological dentin (primary and secondary)." },
  { q: "Application of local anesthetics on the surface of exposed dentin does not eliminate sensitivity. This evidence argues against which theory?", opts: ["Hydrodynamic Theory", "Odontoblastic Transduction Theory", "Direct Neural Stimulation Theory", "All of the above"], correct: 2, explain: "If nerves were present at the surface, an anesthetic should block the pain signal, but it doesn't. This is a key piece of evidence against direct neural stimulation." },
  { q: "What is Predentin?", opts: ["The final, hypermineralized layer of dentin", "A type of tertiary dentin", "The newly formed, unmineralized dentin matrix", "Dentin found only in the root"], correct: 2, explain: "Predentin is the unmineralized organic matrix of dentin located adjacent to the odontoblast layer, which will subsequently mineralize." },
  { q: "The rate of matrix deposition is slowest for which type of dentin?", opts: ["Mantle dentin", "Circumpulpal dentin", "Secondary dentin", "Reparative dentin"], correct: 2, explain: "Secondary dentin is deposited very slowly throughout life, in contrast to the relatively faster formation of primary dentin." },
  { q: "What is the primary cause of 'dead tracts' formation?", opts: ["Physiological aging", "Mineral deposition in tubules", "Destruction of odontoblasts or their processes", "Excessive fluoride intake"], correct: 2, explain: "Severe stimulation leads to the death of the odontoblast, leaving its corresponding tubule empty." },
  { q: "The presence of gap junctions between adjacent odontoblasts is evidence used to support which theory of sensitivity?", opts: ["Direct Neural Stimulation Theory", "Odontoblastic Transduction Theory", "Hydrodynamic Theory", "Cellular Communication Theory"], correct: 1, explain: "Gap junctions allow for electronic coupling, suggesting that odontoblasts could pass a signal between each other and to nerve endings, which is the basis of the transduction theory." },
  { q: "Which area of the tooth shows the highest dentin sensitivity?", opts: ["Near the pulpal surface", "At the dentino-enamel junction (DEJ)", "In the middle third of the dentin", "At the cemento-dentinal junction (CDJ)"], correct: 1, explain: "While the DEJ has many tubule branches, sensitivity is highest near the pulp where the nerve endings are located and tubule diameter is largest." },
  { q: "What is the clinical significance of pulp recession?", opts: ["It increases the risk of pulp exposure", "It decreases the risk of pulp exposure", "It makes teeth more sensitive", "It causes discoloration of the crown"], correct: 1, explain: "By reducing the size of the pulp chamber, pulp recession makes it less likely for a dental bur to expose the pulp during cavity preparation in older patients." }
];

const tfs = [
  { q: "Primary dentin formation ceases once the root of the tooth is completely formed.", answer: false, explain: "Primary dentin formation is completed when the root is formed, but secondary dentin formation then begins and continues throughout life." },
  { q: "Secondary dentin is deposited evenly on all surfaces of the pulp chamber.", answer: false, explain: "Secondary dentin deposition is uneven, occurring more on the roof and floor of the pulp chamber." },
  { q: "Tertiary dentin is considered a physiological type of dentin, formed as part of the normal aging process.", answer: false, explain: "Tertiary dentin is a response to a stimulus or pathology, not a physiological process. Secondary dentin is the physiological age-related dentin." },
  { q: "Reparative dentin is formed by the original odontoblasts that have survived an injury.", answer: false, explain: "Reparative dentin is formed by new odontoblast-like cells after the original ones have been destroyed. Reactionary dentin is formed by surviving odontoblasts." },
  { q: "Sclerotic dentin results from the demineralization of peritubular dentin.", answer: false, explain: "Sclerotic dentin is the opposite; it is hypermineralization where the tubule becomes completely filled with mineral." },
  { q: "Dead tracts appear translucent under transmitted light due to being filled with fluid.", answer: false, explain: "Dead tracts appear black because the empty tubules are filled with air, not fluid. Sclerotic dentin appears translucent." },
  { q: "The Hydrodynamic Theory proposes that fluid movement in the dentinal tubules stimulates nerve receptors in the pulp.", answer: true, explain: "This is the core concept of the Hydrodynamic Theory, which is the most accepted explanation for dentin sensitivity." },
  { q: "The presence of nerve fibers extending to the dentino-enamel junction is well-documented and supports the Direct Neural Stimulation theory.", answer: false, explain: "Nerve fibers have not been found in the outer dentin, which is a major point of evidence against this theory." },
  { q: "Pulp capping procedures are clinically successful partly due to the tooth's ability to form reparative dentin.", answer: true, explain: "The ability of the pulp to form a reparative dentin bridge to wall off an exposure is the biological basis for pulp capping." }
];

const saqs = [
  { q: "A 60-year-old patient presents with significant, flattened wear on the occlusal surfaces of their molars. What specific type of dentin is likely being formed in response, and what is its primary function in this scenario?", a: "The tooth is forming <strong>tertiary dentin</strong> (specifically, reactionary dentin, as tooth wear is typically a slow, mild stimulus).<br><br>Its primary function is to act as a <strong>defensive barrier</strong>, increasing the thickness of hard tissue over the pulp to protect it from the advancing external surface and thermal stimuli." },
  { q: "Explain what 'dead tracts' are in dentin. Include their cause, their appearance under transmitted light, and the typical pulpal response to their formation.", a: "<strong>Cause:</strong> Dead tracts are formed when a severe stimulus (like rapid caries or trauma) destroys the odontoblasts and their processes.<br><br><strong>Appearance:</strong> This leaves the dentinal tubules empty. When viewed under transmitted light, these air-filled tubules appear <strong>black</strong>.<br><br><strong>Pulpal Response:</strong> The pulp typically responds by forming <strong>reparative dentin</strong> at the pulpal end of the dead tract to seal it off." },
  { q: "List the three main theories that have been proposed to explain dentin sensitivity.", a: "1. <strong>Direct Neural Stimulation Theory:</strong> Proposes that nerves extend all the way through the dentin to the DEJ and are directly stimulated.<br><br>2. <strong>Odontoblastic Transduction Theory:</strong> Proposes that the odontoblast acts as a receptor cell, sensing a stimulus and transmitting a signal to an adjacent nerve.<br><br>3. <strong>Hydrodynamic Theory:</strong> Proposes that stimuli cause rapid fluid movement within the dentinal tubules, which in turn stimulates nerve receptors in the pulp." },
  { q: "A young patient experiences a traumatic fracture of a molar cusp, exposing a small area of dentin. Describe the two stages of dentin response you would expect to see over time, assuming the pulp remains vital.", a: "1. <strong>Immediate response (Dead Tract/Sclerosis):</strong> The odontoblasts under the exposed tubules may be damaged or die, potentially creating a localized 'dead tract'. Surrounding tubules may begin to sclerose as a protective measure.<br><br>2. <strong>Long-term response (Tertiary Dentin):</strong> The pulp will initiate the formation of tertiary dentin on the pulpal wall beneath the fracture. If the original odontoblasts were destroyed, it would be <strong>reparative dentin</strong>. This new dentin acts as a barrier to protect the pulp from bacteria and thermal stimuli." },
  { q: "Define Sclerotic Dentin and explain why it appears translucent or transparent when viewed with transmitted light.", a: "<strong>Definition:</strong> Sclerotic dentin is a type of dentin where the dentinal tubules have become completely occluded (filled in) with mineral deposits. It is a common age-related change and a response to slow stimuli.<br><br><strong>Appearance:</strong> It appears translucent because the mineral filling the tubule has the same refractive index as the surrounding intertubular dentin. This uniformity allows light to pass through without being scattered, unlike in normal dentin where the difference in refractive indices between the tubule wall and the fluid/space inside causes light scattering." },
  { q: "Compare and contrast Primary, Secondary, and Tertiary Dentin using a table format. Include the stimulus for formation and the general regularity of the tubular structure.", a: "<table border='1' style='width:100%;'><tr><th>Feature</th><th>Primary Dentin</th><th>Secondary Dentin</th><th>Tertiary Dentin</th></tr><tr><td><strong>Stimulus</strong></td><td>Physiological (part of normal tooth development)</td><td>Physiological (part of normal aging, after root completion)</td><td>Pathological/External (e.g., caries, wear, trauma)</td></tr><tr><td><strong>Tubular Structure</strong></td><td>Regular and organized</td><td>Less regular, shows a change in direction</td><td>Highly irregular, sometimes atubular</td></tr></table>" }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;font-size:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v === null) return s;
    const item = mcqs[i];
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    // Need to find the original correct index based on the shuffled map
    const map = Array.from(card.querySelectorAll('.opt-btn')).map(btn => {
        const label = btn.querySelector('.label').textContent;
        return item.opts.indexOf(label);
    });
    const correctVisualIndex = map.indexOf(item.correct);
    return s + (v === correctVisualIndex ? 1 : 0);
  },0);

  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v === null) return s;
    return s + (v === tfs[i].answer ? 1 : 0);
  },0);

  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}


document.getElementById('resetAll').addEventListener('click', ()=>{
  if (!confirm('Are you sure you want to reset all progress?')) return;
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc(); // Initial calculation
</script>
</body>
</html>
