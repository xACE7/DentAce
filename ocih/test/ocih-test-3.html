<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57Q3BDNKFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-57Q3BDNKFW');
</script>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 3</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "Which major salivary gland is characterized by being purely serous?",
        opts: ["Parotid gland", "Submandibular gland", "Sublingual gland", "Von Ebner's gland"],
        correct: 0,
        explain: "The parotid gland is the largest major salivary gland and is composed almost entirely of serous acini."
    },
    {
        q: "What is the primary histological feature of a mucous acinus?",
        opts: ["Darkly stained cytoplasm with rounded basal nuclei", "Pale, foamy cytoplasm with flattened basal nuclei", "Pyramidal cells with central nuclei", "Presence of zymogen granules"],
        correct: 1,
        explain: "Mucous acini have cells filled with mucinogen droplets, which stain poorly, giving a pale, foamy or vacuolated appearance. The nuclei are typically flattened and pushed to the basal part of the cell."
    },
    {
        q: "A 'serous demilune' is a structure found in which type of salivary gland?",
        opts: ["Purely serous glands", "Purely mucous glands", "Mixed serous-mucous glands", "Minor labial glands"],
        correct: 2,
        explain: "Serous demilunes (of Giannuzzi) are crescent-shaped caps of serous cells on mucous acini, characteristic of mixed glands like the submandibular gland."
    },
    {
        q: "Which part of the ductal system is immediately adjacent to the acinus and lined by low cuboidal cells?",
        opts: ["Striated duct", "Excretory duct", "Intercalated duct", "Main duct"],
        correct: 2,
        explain: "Intercalated ducts are the smallest ducts that lead directly from the acini. They are characterized by their small diameter and simple low cuboidal epithelium."
    },
    {
        q: "The 'basal striations' seen in striated ducts are due to the presence of numerous:",
        opts: ["Ribosomes", "Mitochondria", "Golgi apparatus", "Secretory granules"],
        correct: 1,
        explain: "The basal infoldings of the plasma membrane in striated ducts are lined with numerous mitochondria, which provide the energy needed for ion transport to modify saliva."
    },
    {
        q: "Which gland is considered a mixed, but predominantly mucous, salivary gland?",
        opts: ["Parotid gland", "Submandibular gland", "Sublingual gland", "Lacrimal gland"],
        correct: 2,
        explain: "The sublingual gland is a mixed gland, but the majority of its secretory units are mucous acini, with some having serous demilunes."
    },
    {
        q: "What is the function of myoepithelial cells surrounding the acini and intercalated ducts?",
        opts: ["To produce saliva", "To modify saliva's ionic content", "To contract and expel saliva", "To provide structural support"],
        correct: 2,
        explain: "Myoepithelial cells are contractile cells that embrace the acini and parts of the duct system. Their contraction helps to move saliva out of the acini and into the ducts."
    },
    {
        q: "Which type of duct is typically found within the connective tissue septa between lobules?",
        opts: ["Intercalated duct", "Striated duct", "Intralobular duct", "Excretory (Interlobular) duct"],
        correct: 3,
        explain: "Excretory ducts are the largest ducts and are located in the interlobular connective tissue septa. Intercalated and striated ducts are considered intralobular (within the lobules)."
    },
    {
        q: "The submandibular gland is best described as:",
        opts: ["Purely serous", "Purely mucous", "Mixed, predominantly serous", "Mixed, predominantly mucous"],
        correct: 2,
        explain: "The submandibular gland is a mixed gland, but it contains more serous acini than mucous acini, making it predominantly serous."
    },
    {
        q: "Histologically, a serous cell is typically:",
        opts: ["Columnar with a flattened basal nucleus", "Cuboidal with a pale cytoplasm", "Pyramidal with a rounded basal nucleus", "Flattened with no visible nucleus"],
        correct: 2,
        explain: "Serous secretory cells are pyramidal in shape, with a spherical nucleus located in the basal third of the cell, and their cytoplasm is rich in zymogen granules."
    },
    {
        q: "What type of epithelium lines the larger excretory ducts?",
        opts: ["Simple squamous", "Simple cuboidal", "Pseudostratified or stratified columnar", "Transitional epithelium"],
        correct: 2,
        explain: "As the ducts increase in size, the epithelium transitions from simple cuboidal to pseudostratified and then to stratified columnar or cuboidal in the largest excretory ducts."
    },
    {
        q: "A wide, irregular lumen is a characteristic feature of which structure?",
        opts: ["Serous acinus", "Mucous acinus", "Striated duct", "Intercalated duct"],
        correct: 1,
        explain: "Compared to the narrow, well-defined lumen of a serous acinus, a mucous acinus typically has a larger, more tubular or irregular lumen."
    },
    {
        q: "Connective tissue septa in salivary glands serve to:",
        opts: ["Produce mucous secretions", "Divide the gland into lobes and lobules", "Contract to expel saliva", "Modify the saliva composition"],
        correct: 1,
        explain: "The connective tissue capsule of the gland extends septa into the parenchyma, dividing it into smaller lobes and lobules."
    },
    {
        q: "Which of these ducts is considered 'intralobular'?",
        opts: ["Main excretory duct", "Interlobular duct", "Striated duct", "Terminal duct"],
        correct: 2,
        explain: "Both intercalated ducts and striated ducts are located within the glandular lobules, hence they are termed intralobular."
    },
    {
        q: "The darkly stained, granular cytoplasm of serous cells is due to an abundance of:",
        opts: ["Mucin", "Rough Endoplasmic Reticulum and zymogen granules", "Lipid droplets", "Mitochondria"],
        correct: 1,
        explain: "Serous cells are protein-secreting cells, so they have extensive RER (which is basophilic) and apical zymogen granules (which are eosinophilic), leading to a granular, basophilic appearance."
    },
    {
        q: "In a mixed salivary gland slide, how can you differentiate a mucous acinus from an empty space or artifact?",
        opts: ["By the presence of a central nucleus", "By its large size and irregular shape", "By the presence of flattened nuclei at the periphery", "By its dark staining characteristic"],
        correct: 2,
        explain: "A key identifying feature of mucous acini is the presence of flattened, heterochromatic nuclei pressed against the basal cell membrane, which distinguishes them from artifacts."
    },
    {
        q: "The parotid gland contains numerous, long, and branching...",
        opts: ["Mucous acini", "Serous demilunes", "Intercalated ducts", "Excretory ducts only"],
        correct: 2,
        explain: "A characteristic feature of the parotid gland is its prominent, long, and branching intercalated ducts."
    },
    {
        q: "Saliva modification, specifically ion exchange, primarily occurs in which duct segment?",
        opts: ["Acinus", "Intercalated duct", "Striated duct", "Excretory duct"],
        correct: 2,
        explain: "The striated ducts are the principal site of ion transport, where sodium is resorbed and potassium is secreted into the saliva, making it hypotonic."
    },
    {
        q: "Which feature would NOT be found in a slide of the parotid gland?",
        opts: ["Serous acini", "Striated ducts", "Adipose tissue", "Mucous acini"],
        correct: 3,
        explain: "The adult parotid gland is considered purely serous. While some mucous metaplasia can occur, mucous acini are not a normal, characteristic feature. Adipose tissue commonly infiltrates the parotid with age."
    },
    {
        q: "The cells of intercalated ducts are known to contain which of the following?",
        opts: ["Zymogen granules and lysozyme", "Large amounts of mitochondria", "Mucinogen droplets", "Keratin filaments"],
        correct: 0,
        explain: "The cells of intercalated ducts contribute enzymes like lysozyme and lactoferrin to the saliva. They are not primarily involved in ion exchange or mucous secretion."
    },
    {
        q: "Which gland has the shortest and least conspicuous striated ducts?",
        opts: ["Parotid gland", "Submandibular gland", "Sublingual gland", "Von Ebner's glands"],
        correct: 2,
        explain: "The sublingual gland, being predominantly mucous, has a less developed ductal system. Its intercalated and striated ducts are short and difficult to identify."
    },
    {
        q: "The duct that opens into the oral cavity is the:",
        opts: ["Intercalated duct", "Intralobular duct", "Striated duct", "Main excretory duct"],
        correct: 3,
        explain: "The entire ductal system converges into a main excretory duct (e.g., Stensen's duct for the parotid) that ultimately delivers saliva to the oral cavity."
    },
    {
        q: "In H&E staining, the nuclei of mucous cells appear:",
        opts: ["Round and euchromatic", "Oval and central", "Flattened and heterochromatic", "Large and vesicular"],
        correct: 2,
        explain: "Due to the accumulation of mucin pushing the cell contents, the nuclei in mucous acini are typically flattened against the basal membrane and are condensed (heterochromatic)."
    },
    {
        q: "A salivary gland composed of lobules with a nearly equal mix of serous and mucous acini, plus numerous serous demilunes, is most likely the:",
        opts: ["Parotid gland", "Submandibular gland", "Sublingual gland", "Labial gland"],
        correct: 1,
        explain: "This classic description fits the submandibular gland, which is a mixed gland (predominantly serous) and the primary location of serous demilunes."
    },
    {
        q: "The diameter of an intercalated duct is typically:",
        opts: ["Larger than a serous acinus", "Smaller than a serous acinus", "Equal to a striated duct", "Larger than an excretory duct"],
        correct: 1,
        explain: "Intercalated ducts are the narrowest part of the duct system, having a diameter that is considerably smaller than that of the secretory acini they drain."
    },
    {
        q: "Simple columnar epithelium is the characteristic lining of:",
        opts: ["Serous acini", "Mucous acini", "Intercalated ducts", "Striated ducts"],
        correct: 3,
        explain: "Striated ducts are lined by simple columnar epithelial cells, which are taller than the cuboidal cells of the intercalated ducts."
    },
    {
        q: "The term 'parenchyma' of the salivary gland refers to:",
        opts: ["The connective tissue framework", "The secretory units and ducts", "The blood vessels and nerves", "The capsule surrounding the gland"],
        correct: 1,
        explain: "Parenchyma refers to the functional parts of an organ. In salivary glands, this includes the acini (secretory units) and the ductal system."
    },
    {
        q: "The 'stroma' of the salivary gland refers to:",
        opts: ["The secretory acini", "The intercalated and striated ducts", "The connective tissue, blood vessels, and nerves", "The saliva produced by the gland"],
        correct: 2,
        explain: "Stroma is the supportive framework of an organ, which includes the connective tissue septa, capsule, blood vessels, and nerves."
    },
    {
        q: "Which of these is a 'major' salivary gland?",
        opts: ["Buccal glands", "Palatine glands", "Lingual glands (Von Ebner)", "Sublingual gland"],
        correct: 3,
        explain: "The three pairs of major salivary glands are the parotid, submandibular, and sublingual glands. The others listed are minor salivary glands."
    },
    {
        q: "A slide shows large, pale-staining tubular structures with flattened basal nuclei, and very few, if any, serous cells or prominent ducts. This is most likely the:",
        opts: ["Parotid gland", "Submandibular gland", "Sublingual gland", "Pancreas"],
        correct: 2,
        explain: "This description is characteristic of the sublingual gland, which is predominantly mucous, with tubular acini and a poorly developed duct system."
    }
];

const tfs = [
    {
        q: "The parotid gland is a mixed salivary gland, containing roughly equal parts serous and mucous acini.",
        answer: false,
        explain: "This is false. The parotid gland is considered a purely serous gland in adults."
    },
    {
        q: "Serous acini have a narrow, well-defined central lumen.",
        answer: true,
        explain: "This is true. In contrast to mucous acini, the lumen of serous acini is small and distinct."
    },
    {
        q: "Striated ducts are so named because of apical cilia used to move saliva.",
        answer: false,
        explain: "This is false. The striations are at the basal end of the cells and are formed by folded cell membranes and mitochondria, not cilia."
    },
    {
        q: "Myoepithelial cells are located inside the basement membrane of the acini.",
        answer: true,
        explain: "This is true. Myoepithelial cells lie between the secretory cells and the basement membrane, allowing them to contract upon the acinus."
    },
    {
        q: "The sublingual gland is the smallest of the three major salivary glands and is predominantly serous.",
        answer: false,
        explain: "This is false. While it is the smallest, the sublingual gland is predominantly mucous."
    },
    {
        q: "Intercalated ducts are larger in diameter than striated ducts.",
        answer: false,
        explain: "This is false. Intercalated ducts are the smallest ducts in the system and drain into the larger striated ducts."
    },
    {
        q: "A serous demilune is a cap of mucous cells on a serous acinus.",
        answer: false,
        explain: "This is false. It is the other way around: a serous demilune is a cap of serous cells on a mucous acinus."
    },
    {
        q: "Both intercalated and striated ducts are considered 'intralobular' ducts.",
        answer: true,
        explain: "This is true. They are located within the parenchyma of the lobule, before the ducts enter the interlobular connective tissue septa."
    },
    {
        q: "The cytoplasm of mucous cells stains darkly with H&E due to abundant ribosomes.",
        answer: false,
        explain: "This is false. The cytoplasm of mucous cells stains very pale because the mucinogen droplets do not take up H&E stain well."
    }
];

const saqs = [
    {
        q: "Describe the primary function of myoepithelial cells and state where they are located within a salivary gland secretory unit.",
        a: "Myoepithelial cells are contractile cells that function to expel saliva from the acini and intercalated ducts into the larger duct system. They are located between the basal plasma membrane of the secretory cells and the basal lamina (basement membrane) of the epithelium."
    },
    {
        q: "List three key histological features that can be used to differentiate a mucous acinus from a serous acinus.",
        a: `<ol>
            <li><b>Cytoplasm Appearance:</b> Mucous acini have pale, foamy, or vacuolated cytoplasm, while serous acini have dark-staining, granular, basophilic cytoplasm.</li>
            <li><b>Nucleus Shape & Position:</b> Mucous acini have flattened nuclei pressed against the basal membrane, whereas serous acini have rounded nuclei located in the basal third of the cell.</li>
            <li><b>Lumen Size:</b> Mucous acini typically have a larger, more tubular or irregular lumen compared to the small, narrow, and well-defined lumen of a serous acinus.</li>
           </ol>`
    },
    {
        q: "Compare the epithelial lining and relative location of intercalated ducts versus the main excretory ducts.",
        a: `
           <table>
             <thead>
               <tr><th>Feature</th><th>Intercalated Duct</th><th>Main Excretory Duct</th></tr>
             </thead>
             <tbody>
               <tr>
                 <td><b>Epithelium</b></td>
                 <td>Simple low cuboidal epithelium.</td>
                 <td>Becomes progressively taller, typically pseudostratified columnar or stratified cuboidal/columnar.</td>
               </tr>
               <tr>
                 <td><b>Location</b></td>
                 <td>Intralobular, immediately draining the acini.</td>
                 <td>Interlobular, located within the main connective tissue septa, leading towards the oral cavity.</td>
               </tr>
             </tbody>
           </table>
        `
    },
    {
        q: "Explain the histological reason for the 'striated' appearance of striated ducts and what this structure indicates about the duct's function.",
        a: "The 'striated' appearance is due to numerous deep infoldings of the basal plasma membrane, which are aligned with vertically arranged, elongated mitochondria. This structure dramatically increases the surface area at the base of the cell and indicates a high level of metabolic activity, specifically for active transport. It is the site where saliva is modified by reabsorbing sodium and chloride ions and secreting potassium and bicarbonate ions."
    },
    {
        q: "A histology slide from a major salivary gland reveals a mixture of mucous and serous acini. Many of the pale-staining mucous acini are capped by crescent-shaped groups of dark-staining serous cells. What is the most likely identification of this gland, and what is the specific term for these crescent-shaped structures?",
        a: "The most likely identification is the <b>Submandibular Gland</b>. The crescent-shaped structures are called <b>serous demilunes</b> (or Demilunes of Giannuzzi)."
    },
    {
        q: "List the three main segments of the salivary gland ductal system in order, starting from the secretory acinus and moving outwards.",
        a: `<ol>
            <li><b>Intercalated Duct:</b> The narrowest duct, leading directly from the acinus.</li>
            <li><b>Striated Duct:</b> A larger intralobular duct into which intercalated ducts drain.</li>
            <li><b>Excretory Duct:</b> The largest type of duct, located in the interlobular connective tissue, formed by the joining of striated ducts.</li>
           </ol>`
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  if (!confirm("Are you sure you want to reset all answers and scores?")) {
    return;
  }
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
