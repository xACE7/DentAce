<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .answer table {width:100%;border-collapse:collapse;margin-top:10px;}
  .answer th, .answer td {border:1px solid var(--card-border);padding:8px;text-align:left;}
  .answer th {background-color: var(--glass);}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 23</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "What is the average width of a healthy periodontal ligament (PDL)?",
        opts: ["0.2 mm", "0.05 mm", "1.0 mm", "It is uniform along the root"],
        correct: 0,
        explain: "The average width of the PDL is about 0.2 mm, though it can range from 0.15 to 0.38 mm. It is thinnest in the middle region of the root."
    },
    {
        q: "On a dental radiograph, how does the PDL typically appear?",
        opts: ["As a thin radiolucent line", "As a thick radiopaque line", "It is not visible on radiographs", "As a mottled, mixed-density area"],
        correct: 0,
        explain: "The PDL space appears as a thin radiolucent line between the tooth root (radiopaque) and the alveolar bone (radiopaque)."
    },
    {
        q: "The terminal portions of the principal fibers that insert into cementum and bone are known as:",
        opts: ["Sharpey fibers", "Oxytalan fibers", "Reticular fibers", "Indifferent fiber plexus"],
        correct: 0,
        explain: "Sharpey fibers are the mineralized terminal ends of the principal collagen fibers that embed into the cementum and alveolar bone."
    },
    {
        q: "Which of the following is NOT one of the six principal fiber groups of the PDL?",
        opts: ["Gingivodental fibers", "Transseptal fibers", "Oblique fibers", "Apical fibers"],
        correct: 0,
        explain: "The six principal fiber groups are transseptal, alveolar crest, horizontal, oblique, apical, and interradicular. Gingivodental fibers are part of the gingival fiber group, not the PDL proper."
    },
    {
        q: "Which group of principal fibers is the most numerous and bears the brunt of vertical masticatory forces?",
        opts: ["Oblique fibers", "Horizontal fibers", "Alveolar crest fibers", "Interradicular fibers"],
        correct: 0,
        explain: "The oblique fibers constitute the largest group and are responsible for transforming vertical masticatory stresses into tension on the alveolar bone."
    },
    {
        q: "What is the most common type of cell found in the periodontal ligament?",
        opts: ["Fibroblasts", "Osteoblasts", "Cementoblasts", "Mast cells"],
        correct: 0,
        explain: "Fibroblasts are the most common cells, responsible for both synthesizing and resorbing collagen fibers, thus maintaining the PDL."
    },
    {
        q: "The Epithelial Rests of Malassez are remnants of which structure?",
        opts: ["Hertwig's epithelial root sheath", "Dental pulp", "Dental follicle", "Stellate reticulum"],
        correct: 0,
        explain: "These epithelial cell clusters are remnants of Hertwig's root sheath, which disintegrates during root development. They can proliferate to form cysts."
    },
    {
        q: "The ground substance of the PDL is primarily composed of glycosaminoglycans, glycoproteins, and a high content of:",
        opts: ["Water (70%)", "Collagen type III", "Minerals", "Lipids"],
        correct: 0,
        explain: "The ground substance is a gel-like matrix with a high water content (about 70%), which helps it withstand functional forces."
    },
    {
        q: "Which type of collagen is the main component of the PDL's principal fibers?",
        opts: ["Type I", "Type II", "Type III", "Type IV"],
        correct: 0,
        explain: "The principal fibers are mainly composed of collagen type I, which provides high tensile strength."
    },
    {
        q: "What is the function of the transseptal fibers?",
        opts: ["Connect adjacent teeth interproximally", "Resist lateral tooth movement", "Attach the tooth to the alveolar crest", "Resist vertical occlusal forces"],
        correct: 0,
        explain: "Transseptal fibers extend interproximally over the alveolar bone crest, connecting the cementum of adjacent teeth and helping to maintain tooth alignment."
    },
    {
        q: "A tooth with reduced function (e.g., an unerupted tooth) would be expected to have a:",
        opts: ["Thinner PDL", "Wider PDL", "PDL with more cells", "PDL with no fibers"],
        correct: 0,
        explain: "The width of the PDL decreases with reduced function and increases with hyperfunction. An unerupted tooth has a thinner PDL."
    },
    {
        q: "Which cells in the PDL are responsible for synthesizing new bone?",
        opts: ["Osteoblasts", "Osteoclasts", "Fibroblasts", "Cementoblasts"],
        correct: 0,
        explain: "Osteoblasts are located along the surface of the alveolar bone and are responsible for its formation."
    },
    {
        q: "Which fiber group prevents extrusion and resists lateral tooth movements?",
        opts: ["Alveolar crest fibers", "Oblique fibers", "Apical fibers", "Horizontal fibers"],
        correct: 0,
        explain: "Alveolar crest fibers extend from the cementum just below the junctional epithelium to the alveolar crest, helping to secure the tooth in its socket."
    },
    {
        q: "The blood supply to the PDL comes from all the following sources EXCEPT:",
        opts: ["Vessels from the dental pulp only", "Apical vessels that supply the pulp", "Intra-alveolar vessels", "Gingival vessels"],
        correct: 0,
        explain: "The PDL has a rich, triple blood supply from apical vessels, intra-alveolar vessels, and gingival vessels, not just from the pulp."
    },
    {
        q: "The sensory nerve fibers in the PDL are associated with which sensations?",
        opts: ["Touch, pressure, pain, and proprioception", "Taste and temperature", "Only deep pain", "Only autonomic functions"],
        correct: 0,
        explain: "The PDL is highly innervated with sensory fibers that provide feedback on touch, pressure, pain, and proprioception (spatial awareness)."
    },
    {
        q: "What are oxytalan and elaunin fibers found in the PDL?",
        opts: ["Immature forms of elastin", "Mature elastin fibers", "A type of collagen fiber", "Nerve fibers"],
        correct: 0,
        explain: "The PDL does not contain mature elastin but does have two immature forms, oxytalan and elaunin, which are thought to regulate vascular flow."
    },
    {
        q: "Which cells are involved in the resorption of cementum?",
        opts: ["Cementoclasts", "Cementoblasts", "Odontoblasts", "Osteoclasts"],
        correct: 0,
        explain: "Cementoclasts are specialized cells responsible for the resorption of cementum, similar to how osteoclasts resorb bone."
    },
    {
        q: "The process of collagen biosynthesis to form bundles follows which sequence?",
        opts: ["Tropocollagen → microfibrils → fibrils → fibers → bundles", "Fibrils → fibers → tropocollagen → microfibrils → bundles", "Microfibrils → tropocollagen → fibrils → fibers → bundles", "Bundles → fibers → fibrils → microfibrils → tropocollagen"],
        correct: 0,
        explain: "Collagen biosynthesis occurs in a hierarchical assembly, starting from tropocollagen molecules aggregating up to large bundles."
    },
    {
        q: "Which fiber group fans out from the cementum in the furcation area of multirooted teeth?",
        opts: ["Interradicular fibers", "Apical fibers", "Transseptal fibers", "Oblique fibers"],
        correct: 0,
        explain: "Interradicular fibers are found specifically in the furcation areas of multirooted teeth, providing stability."
    },
    {
        q: "What is the primary role of the indifferent fiber plexus?",
        opts: ["To form a supportive network between principal fibers", "To transmit pain signals", "To produce ground substance", "To directly attach tooth to bone"],
        correct: 0,
        explain: "The indifferent fiber plexus consists of small collagen fibers that run in all directions, forming a supportive meshwork around the principal fiber bundles."
    },
    {
        q: "A 'cementicle' is best described as:",
        opts: ["A calcified mass found in the PDL", "A type of PDL cell", "A small collagen fiber", "A developing cementoblast"],
        correct: 0,
        explain: "Cementicles are small, calcified bodies found in the PDL, which may be free, attached to, or embedded in the cementum."
    },
    {
        q: "The unique nature of the PDL allows it to:",
        opts: ["Connect two different mineralized tissues (bone and cementum)", "Produce enamel and dentin", "Function as a typical ligament with high elasticity", "Contain only one type of cell"],
        correct: 0,
        explain: "A unique feature of the PDL is that it is a soft connective tissue that connects the mineralized tissues of cementum and alveolar bone."
    },
    {
        q: "Which defense cells are typically found in a healthy PDL?",
        opts: ["Neutrophils, lymphocytes, macrophages, mast cells", "Only neutrophils", "Only plasma cells", "Red blood cells and platelets"],
        correct: 0,
        explain: "A range of defense cells, including neutrophils, lymphocytes, macrophages, mast cells, and eosinophils, are present to protect the periodontium."
    },
    {
        q: "What is the function of glycoproteins like fibronectin and laminin in the ground substance?",
        opts: ["Mediate interaction between cells and other components", "Provide tensile strength", "Store water", "Resorb old collagen"],
        correct: 0,
        explain: "Glycoproteins such as fibronectin and laminin play a crucial role in mediating the adhesion and interaction between cells and the extracellular matrix."
    },
    {
        q: "Orthodontic tooth movement is possible because of the PDL's ability to:",
        opts: ["Remodel itself through cellular activity", "Stretch indefinitely like an elastic band", "Dissolve the tooth root completely", "Become inflamed and swell"],
        correct: 0,
        explain: "The cellular activity (resorption and formation of bone and fibers) within the PDL allows it to remodel in response to orthodontic forces, enabling tooth movement."
    },
    {
        q: "Which fiber group extends at right angles to the long axis of the tooth?",
        opts: ["Horizontal fibers", "Oblique fibers", "Apical fibers", "Alveolar crest fibers"],
        correct: 0,
        explain: "Horizontal fibers run perpendicular to the long axis of the tooth, from the cementum to the alveolar bone."
    },
    {
        q: "Autonomic nerve fibers in the PDL are primarily associated with:",
        opts: ["Regulating blood vessel diameter", "Sensing tooth contact", "Transmitting pain", "Controlling cell division"],
        correct: 0,
        explain: "The autonomic fibers in the PDL are associated with the neurovascular elements and regulate the blood flow within the ligament."
    },
    {
        q: "All of the following are important amino acids for collagen synthesis EXCEPT:",
        opts: ["Tryptophan", "Glycine", "Proline", "Hydroxyproline"],
        correct: 0,
        explain: "Glycine, proline, and hydroxyproline are key amino acids in the structure of collagen. Tryptophan is not a primary component."
    },
    {
        q: "Periapical cysts can be formed by the proliferation of which cells in the PDL?",
        opts: ["Epithelial Rests of Malassez", "Fibroblasts", "Undifferentiated mesenchymal cells", "Mast cells"],
        correct: 0,
        explain: "When stimulated by inflammation, the Epithelial Rests of Malassez can proliferate and are implicated in the formation of periapical and lateral root cysts."
    },
    {
        q: "The term 'gomphosis' refers to:",
        opts: ["The specialized joint that anchors a tooth to the jawbone", "A type of PDL fiber", "A disease of the periodontium", "A cell that forms cementum"],
        correct: 0,
        explain: "Gomphosis is a term for the unique fibrous joint that secures a tooth in its socket, with the PDL being the primary component of this joint."
    }
];

const tfs = [
    {
        q: "The PDL is thinnest at the apex and cervix of the tooth and widest in the middle.",
        answer: false,
        explain: "The PDL is thinnest in the middle region of the root, not widest."
    },
    {
        q: "Fibroblasts in the PDL are capable of both synthesizing and phagocytosing collagen fibers.",
        answer: true,
        explain: "This dual function allows fibroblasts to actively remodel the PDL in response to functional demands."
    },
    {
        q: "The PDL contains a rich network of mature, elastic elastin fibers.",
        answer: false,
        explain: "The PDL does not contain mature elastin; it contains two immature forms called oxytalan and elaunin."
    },
    {
        q: "The principal fibers of the PDL follow a straight, rigid course from bone to cementum.",
        answer: false,
        explain: "The principal fibers follow a wavy or undulating course when viewed in longitudinal section, which allows for slight tooth movement."
    },
    {
        q: "The ground substance of the PDL is secreted by cementoblasts.",
        answer: false,
        explain: "The components of the ground substance are presumed to be secreted by fibroblasts, the most common cell type in the PDL."
    },
    {
        q: "Apical fibers are present on both completely and incompletely formed roots.",
        answer: false,
        explain: "Apical fibers radiate from the apical cementum to the bone and do not occur on incompletely formed roots."
    },
    {
        q: "Increased function or hyperfunction of a tooth can lead to a widening of the PDL space.",
        answer: true,
        explain: "The PDL adapts to increased functional demands by increasing its width and fiber thickness."
    },
    {
        q: "The PDL has a poor blood supply, making it susceptible to necrosis.",
        answer: false,
        explain: "The PDL has an abundant and rich vasculature from three different sources, ensuring its vitality."
    },
    {
        q: "Transseptal fibers are reconstructed even after destruction of the alveolar bone from periodontal disease.",
        answer: true,
        explain: "These fibers, connecting adjacent teeth, have a remarkable capacity for regeneration."
    }
];

const saqs = [
    {
        q: "What is the primary function of fibroblasts within the Periodontal Ligament?",
        a: "Fibroblasts are the most common cells in the PDL and have a dual function. They are responsible for synthesizing collagen to form and maintain the principal fibers, and they also possess the capacity to phagocytose and degrade 'old' collagen fibers. This allows for continuous remodeling and adaptation of the PDL."
    },
    {
        q: "List the three sources of arterial blood supply to the Periodontal Ligament.",
        a: "The PDL receives a rich blood supply from three main sources: <br>1. <b>Apical vessels:</b> Branches from the vessels that supply the dental pulp. <br>2. <b>Intra-alveolar vessels:</b> Branches that run horizontally, penetrating the alveolar bone to enter the PDL. <br>3. <b>Gingival vessels:</b> Branches from gingival arteries that enter the PDL from the coronal direction."
    },
    {
        q: "A patient's radiograph reveals a distinct, uniform widening of the PDL space around a molar that supports a dental bridge. The patient reports sensitivity upon biting. What is the likely clinical condition and its cause?",
        a: "The clinical condition is likely <b>occlusal trauma</b>. The widening of the PDL space on the radiograph indicates a response to excessive occlusal (biting) forces, also known as hyperfunction. The bridge may be concentrating these forces on the molar, causing the PDL to thicken as an adaptive response. The sensitivity is a common symptom of this condition."
    },
    {
        q: "Describe the composition of the ground substance in the PDL.",
        a: "The ground substance fills the spaces between fibers and cells. It consists of two main components: <br>1. <b>Glycosaminoglycans (GAGs):</b> such as hyaluronic acid and proteoglycans. <br>2. <b>Glycoproteins:</b> such as fibronectin and laminin. <br>It also has a very high water content (about 70%), which helps the PDL resist forces."
    },
    {
        q: "In a numbered table, list the six groups of principal fibers in the PDL.",
        a: "<table><thead><tr><th>#</th><th>Fiber Group</th></tr></thead><tbody><tr><td>1</td><td>Transseptal fibers</td></tr><tr><td>2</td><td>Alveolar crest fibers</td></tr><tr><td>3</td><td>Horizontal fibers</td></tr><tr><td>4</td><td>Oblique fibers</td></tr><tr><td>5</td><td>Apical fibers</td></tr><tr><td>6</td><td>Interradicular fibers</td></tr></tbody></table>"
    },
    {
        q: "Compare the main functions of the Oblique fiber group and the Horizontal fiber group in a numbered table.",
        a: "<table><thead><tr><th>#</th><th>Oblique Fibers</th><th>Horizontal Fibers</th></tr></thead><tbody><tr><td>1</td><td>Constitute the largest group of fibers in the PDL.</td><td>Run at right angles to the long axis of the tooth.</td></tr><tr><td>2</td><td>Bear the brunt of vertical masticatory stresses.</td><td>Primarily resist horizontal or lateral forces.</td></tr><tr><td>3</td><td>Transform vertical stress into tension on the alveolar bone.</td><td>Help to prevent lateral tooth movement.</td></tr></tbody></table>"
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;font-size:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  if (!confirm("Are you sure you want to reset all progress?")) return;
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

// Initial calculation
recalc();
</script>
</body>
</html>
