<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid var(--card-border); padding: 8px; text-align: left; }
  th { background-color: var(--glass); }
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 16</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
    {
        q: "Which of the following is NOT listed as a hypocalcified structure of enamel?",
        opts: ["Rod sheaths", "Enamel spindles", "Odontoblasts", "Enamel tufts"],
        correct: 2,
        explain: "Odontoblasts are cells that form dentin, not a structure within enamel. The others are all listed as hypocalcified structures."
    },
    {
        q: "What do the Incremental Lines of Retzius represent?",
        opts: ["Cracks in the enamel surface", "Successive deposition of enamel layers", "The junction between enamel and dentin", "Bundles of enamel rods"],
        correct: 1,
        explain: "These lines illustrate the successive deposition of enamel layers during the formation of the crown."
    },
    {
        q: "How do the Incremental Lines of Retzius appear in a cross-section of a tooth?",
        opts: ["As oblique lines", "As concentric rings", "As dark and light bands", "As small tufts"],
        correct: 1,
        explain: "In a cross-section, the Striae of Retzius appear as concentric rings, similar to the growth rings of a tree."
    },
    {
        q: "What does a broadening of the Incremental Lines of Retzius suggest?",
        opts: ["Rapid enamel formation", "A metabolic disturbance during matrix formation", "High mineral content", "Normal tooth development"],
        correct: 1,
        explain: "A broadening of these lines can reflect a metabolic disturbance that occurred while the enamel matrix was being formed."
    },
    {
        q: "The Neonatal Line is an accentuated form of which other enamel structure?",
        opts: ["Enamel Lamellae", "Hunter-Schreger Bands", "Incremental line of Retzius", "Enamel Tufts"],
        correct: 2,
        explain: "The Neonatal Line is a particularly pronounced Incremental Line of Retzius, marking the boundary between enamel formed before and after birth."
    },
    {
        q: "Why is prenatal enamel generally better developed than postnatal enamel?",
        opts: ["It contains more organic material.", "It is formed at a faster rate.", "The fetus is in a well-protected environment with adequate essential materials.", "Postnatal enamel is subject to wear and tear immediately."],
        correct: 2,
        explain: "The fetal environment is stable and provides a consistent supply of nutrients, leading to higher quality enamel formation compared to the period after birth."
    },
    {
        q: "What causes the appearance of Hunter-Schreger bands in enamel?",
        opts: ["Variations in calcification", "Presence of enamel proteins", "Cracks extending from the surface", "Regular changes in the direction of enamel rods"],
        correct: 3,
        explain: "Hunter-Schreger bands are an optical phenomenon caused by the alternating orientation of groups of enamel rods."
    },
    {
        q: "Where do Hunter-Schreger bands typically originate?",
        opts: ["At the outer enamel surface", "At the Dentinoenamel junction (DEJ)", "Within the enamel spindles", "Along the neonatal line"],
        correct: 1,
        explain: "These bands originate at the DEJ and extend outwards, usually ending some distance from the enamel surface."
    },
    {
        q: "What is the primary composition of Enamel Tufts?",
        opts: ["Highly mineralized enamel rods", "Greater concentrations of enamel proteins", "Entrapped odontoblast processes", "Salivary proteins"],
        correct: 1,
        explain: "Enamel tufts are hypocalcified, containing a higher concentration of enamel proteins compared to the surrounding enamel."
    },
    {
        q: "What is the clinical significance of Enamel Tufts?",
        opts: ["They increase the risk of caries.", "They are pathways for bacteria.", "They help prevent enamel fracture.", "They cause tooth discoloration."],
        correct: 2,
        explain: "Enamel tufts are believed to play a role in preventing the propagation of fractures through the enamel."
    },
    {
        q: "Which structure is described as a thin organic layer that can extend from the enamel surface towards the DEJ and sometimes into dentin?",
        opts: ["Enamel Spindle", "Enamel Lamella", "Perikymata", "Neonatal Line"],
        correct: 1,
        explain: "Enamel lamellae are crack-like structures that fit this description and can be a pathway for bacteria."
    },
    {
        q: "Which type of Enamel Lamellae is most commonly found in erupted teeth and contains organic matter from saliva?",
        opts: ["Type A", "Type B", "Type C", "Type D"],
        correct: 2,
        explain: "Type C lamellae are found in erupted teeth, reach into the dentin, and are filled with organic matter from the oral cavity."
    },
    {
        q: "What is the primary significance of the scalloped shape of the Dentinoenamel Junction (DEJ)?",
        opts: ["It increases the surface area for nutrient exchange.", "It allows for the passage of nerve endings.", "It ensures a firm hold of enamel to dentin.", "It marks the rate of enamel deposition."],
        correct: 2,
        explain: "The scalloped interface provides a strong mechanical lock between the enamel and the underlying dentin, preventing them from separating under load."
    },
    {
        q: "What are Enamel Spindles?",
        opts: ["Groups of hypocalcified enamel rods", "Cracks filled with organic debris", "Terminal ends of odontoblast processes trapped in enamel", "External manifestations of incremental lines"],
        correct: 2,
        explain: "Enamel spindles are formed when the terminal ends of odontoblast processes become trapped in the enamel matrix during development."
    },
    {
        q: "Which surface structure is a highly mineralized, 20-40 µm thick layer containing crystals arranged at right angles to the surface?",
        opts: ["Perikymata", "Enamel cuticle", "Prismless enamel", "Enamel rod ends"],
        correct: 2,
        explain: "Prismless enamel is a distinct surface layer that is more heavily mineralized than the rest of the enamel."
    },
    {
        q: "What are Perikymata?",
        opts: ["The concave depressions where enamel rods end", "A delicate membrane on newly erupted teeth", "The external manifestation of the incremental lines of Retzius", "Precipitates of salivary protein"],
        correct: 2,
        explain: "Perikymata are the wave-like grooves on the enamel surface that correspond to the underlying incremental lines of Retzius."
    },
    {
        q: "The concavities on the enamel surface known as 'Enamel Rod Ends' are typically deepest near which area of the tooth?",
        opts: ["The cervical region", "The mid-coronal area", "The Dentinoenamel junction", "The incisal or occlusal surface"],
        correct: 3,
        explain: "The depressions of the enamel rod ends are shallowest at the cervical region and deepen towards the chewing surfaces (incisal or occlusal)."
    },
    {
        q: "What is another name for the Enamel Cuticle?",
        opts: ["Pellicle", "Nasmyth's membrane", "Prismless layer", "Striae of Retzius"],
        correct: 1,
        explain: "The Enamel Cuticle is also known as Nasmyth's membrane, a delicate layer covering a newly erupted tooth."
    },
    {
        q: "What is the Enamel Pellicle composed of?",
        opts: ["Degenerated cells from tooth development", "A precipitate of salivary protein", "Hypocalcified enamel rods", "Bacteria and food debris"],
        correct: 1,
        explain: "The enamel pellicle is an acellular layer formed by the precipitation of proteins from saliva onto the tooth surface."
    },
    {
        q: "Why does enamel appear more radiopaque on an X-ray than other tooth tissues?",
        opts: ["It has a higher water content.", "It has a higher organic content.", "It has the highest mineral content.", "It is the outermost layer."],
        correct: 2,
        explain: "Enamel's high degree of mineralization (highest in the body) makes it very dense, which blocks x-rays more effectively, causing it to appear whiter (more radiopaque)."
    },
    {
        q: "Which of the following is a common age change observed in enamel?",
        opts: ["Increased permeability", "Lightening of tooth color", "Attrition or wear", "Formation of new enamel layers"],
        correct: 2,
        explain: "Attrition, the wear of occlusal and proximal surfaces due to mastication, is the most apparent age-related change in enamel."
    },
    {
        q: "What causes the Incremental Lines of Retzius to appear as brownish bands in a ground section?",
        opts: ["They are hypercalcified.", "They contain trapped air.", "They represent a slight change in rod direction and mineralization.", "They are artifacts of slide preparation."],
        correct: 2,
        explain: "These lines are believed to result from periodic variations in the secretory activity of ameloblasts, leading to slight changes in rod orientation and mineralization."
    },
    {
        q: "Enamel lamellae that are restricted to the enamel of an unerupted tooth and consist of poorly calcified rod segments are classified as:",
        opts: ["Type A", "Type B", "Type C", "Not a valid classification"],
        correct: 0,
        explain: "Type A lamellae are composed of poorly calcified rod segments and are found within the enamel of unerupted teeth."
    },
    {
        q: "The structure that helps prevent fracture propagation and arises from the scalloped DEJ is the:",
        opts: ["Enamel Lamella", "Enamel Spindle", "Enamel Rod Sheath", "Enamel Tuft"],
        correct: 3,
        explain: "Enamel tufts, which are hypomineralized, branched structures, are thought to act as crack arrestors within the enamel."
    },
    {
        q: "Which of these structures is visible to the naked eye on the surface of a tooth?",
        opts: ["Hunter-Schreger Bands", "Perikymata", "Enamel Spindles", "Striae of Retzius"],
        correct: 1,
        explain: "Perikymata are the only structures listed that are surface features (wave-like grooves) and can be seen clinically without magnification."
    },
    {
        q: "The dental plaque biofilm initially forms on what structure?",
        opts: ["The prismless enamel layer", "The enamel cuticle", "The enamel pellicle", "The enamel rod ends"],
        correct: 2,
        explain: "The enamel pellicle, a layer of salivary proteins, forms on the tooth surface first and provides a site for bacteria to attach and form plaque."
    },
    {
        q: "A key difference between Enamel Tufts and Enamel Spindles is that:",
        opts: ["Tufts are hypocalcified, while Spindles are hypercalcified.", "Tufts contain enamel protein, while Spindles contain parts of dentin-forming cells.", "Tufts run horizontally, while Spindles run vertically.", "Tufts are found on the surface, while Spindles are deep in enamel."],
        correct: 1,
        explain: "Enamel Tufts are areas with more enamel protein (hypocalcified), whereas Enamel Spindles are the trapped ends of odontoblast (dentin-forming cell) processes."
    },
    {
        q: "The neonatal line is found in which teeth?",
        opts: ["All permanent teeth", "All deciduous teeth and first permanent molars", "Only deciduous incisors", "Only permanent molars"],
        correct: 1,
        explain: "The neonatal line is present in all deciduous (primary) teeth and the cusps of the first permanent molars, as their development straddles the time of birth."
    },
    {
        q: "What happens to the Enamel Cuticle (Nasmyth's membrane) after tooth eruption?",
        opts: ["It calcifies and becomes part of the enamel.", "It is soon removed by mastication.", "It transforms into the enamel pellicle.", "It remains for life unless professionally removed."],
        correct: 1,
        explain: "The enamel cuticle is a very delicate membrane that is quickly worn away by the abrasive action of chewing."
    },
    {
        q: "Which of the following is NOT an effect of aging on enamel?",
        opts: ["It becomes darker.", "Its fluid permeability is reduced.", "Its resistance to decay may increase.", "Its thickness increases due to continuous deposition."],
        correct: 3,
        explain: "Enamel is acellular and does not regenerate or get thicker with age. The other options are recognized age-related changes."
    }
];

const tfs = [
    {
        q: "The Incremental Lines of Retzius appear as oblique lines in a cross-section of enamel.",
        answer: false,
        explain: "This is false. In a cross-section, they appear as concentric rings. They appear as oblique lines in a longitudinal section."
    },
    {
        q: "The neonatal line separates enamel formed before birth from enamel formed after birth.",
        answer: true,
        explain: "This is true. It's an accentuated incremental line that marks the physiological trauma of birth."
    },
    {
        q: "Hunter-Schreger bands are visible due to varying degrees of mineralization in the enamel.",
        answer: false,
        explain: "This is false. They are an optical phenomenon caused by changes in the direction of enamel rods, not by differences in mineralization."
    },
    {
        q: "Enamel tufts are hypocalcified structures that extend from the DEJ into the enamel.",
        answer: true,
        explain: "This is true. They are rich in enamel protein and are considered hypocalcified."
    },
    {
        q: "Enamel lamellae are always confined to the enamel layer and never reach the dentin.",
        answer: false,
        explain: "This is false. Type B and Type C lamellae can extend from the surface and penetrate into the dentin."
    },
    {
        q: "The scalloped shape of the DEJ serves to weaken the bond between enamel and dentin.",
        answer: false,
        explain: "This is false. The scalloped shape creates a strong mechanical interlock, strengthening the bond between enamel and dentin."
    },
    {
        q: "Perikymata are the surface manifestations of the Hunter-Schreger bands.",
        answer: false,
        explain: "This is false. Perikymata are the surface manifestations of the Incremental Lines of Retzius."
    },
    {
        q: "Prismless enamel is a layer found on the enamel surface that is less mineralized than the underlying enamel.",
        answer: false,
        explain: "This is false. The prismless layer is described as being 'hyper-mineralized' or more highly mineralized than the rest of the enamel."
    },
    {
        q: "With age, enamel tends to become lighter in color and more permeable to fluids.",
        answer: false,
        explain: "This is false. Due to changes in the organic matrix and accumulation of stains, enamel becomes darker and less permeable with age."
    }
];

const saqs = [
    {
        q: "A patient who is a heavy bruxer (grinds their teeth) presents with significant wear on their molars, exposing the yellowish layer beneath the white outer layer. Based on the lecture, what is this phenomenon called and what are two other age-related changes that might be occurring in their enamel?",
        a: "The phenomenon is **attrition**. Two other age-related changes are: 1. The teeth becoming **darker** in color. 2. A **reduction in fluid permeability**, which might increase resistance to decay."
    },
    {
        q: "Define Enamel Lamellae and list the three types, specifying where each is found (erupted or unerupted tooth).",
        a: "Enamel lamellae are thin, leaf-like structures that extend from the enamel surface toward the DEJ, sometimes penetrating dentin. They are often sites of weakness.<br>1. <strong>Type A:</strong> Composed of poorly calcified rod segments. Found in unerupted teeth.<br>2. <strong>Type B:</strong> Consist of degenerated cells. Found in unerupted teeth.<br>3. <strong>Type C:</strong> Contain organic matter from saliva. Found in erupted teeth."
    },
    {
        q: "Explain what the Neonatal Line is, why it forms, and in which teeth it is typically found.",
        a: "The Neonatal Line is an accentuated Incremental Line of Retzius that marks the boundary between enamel formed before birth (prenatal) and after birth (postnatal). It forms due to the abrupt change in environment and nutrition the infant experiences at birth. It is found in all deciduous (primary) teeth and the first permanent molars."
    },
    {
        q: "Compare and contrast Enamel Tufts and Enamel Spindles using a numbered table, covering their origin and composition.",
        a: `<table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Enamel Tufts</th>
                        <th>Enamel Spindles</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1. <strong>Origin</strong></td>
                        <td>Arise at the DEJ due to abrupt changes in enamel rod direction.</td>
                        <td>Formed by the entrapment of odontoblast processes within the enamel matrix.</td>
                    </tr>
                    <tr>
                        <td>2. <strong>Composition</strong></td>
                        <td>Hypocalcified areas with a higher concentration of enamel proteins.</td>
                        <td>Contain the remnants of dentinal tubules and odontoblast processes.</td>
                    </tr>
                </tbody>
            </table>`
    },
    {
        q: "Describe three distinct structures found on the surface of enamel.",
        a: `1. <strong>Perikymata:</strong> These are transverse, wave-like grooves on the enamel surface that are the external manifestations of the Incremental Lines of Retzius.
           <br>2. <strong>Prismless Enamel:</strong> A highly mineralized outer layer (20-40 µm thick) where crystals are arranged at right angles to the surface.
           <br>3. <strong>Enamel Rod Ends:</strong> Concave depressions on the surface where the enamel rods terminate.`
    },
    {
        q: "Explain the formation and significance of the Enamel Pellicle.",
        a: "The Enamel Pellicle is a thin, acellular layer formed from the precipitation of salivary proteins onto the enamel surface after the original enamel cuticle (Nasmyth's membrane) wears away. It reforms within hours of being removed. Its significance is that it acts as the initial site for the attachment and accumulation of microorganisms, which can lead to the formation of dental plaque and subsequently, caries."
    }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);font-family:inherit;"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    const card = document.querySelector(`.qcard[data-type="tf"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
