<!DOCTYPE html>
<html lang="en" style="direction:ltr;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Interactive Exam • Glowing Dark Theme</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0b0b12;
    --text:#f6f7fb;
    --muted:#a6afc6;
    --card:rgba(255,255,255,0.05);
    --card-border:rgba(255,255,255,0.12);
    --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.10);
    --glow-cyan:#06b6d4;
    --glow-cyan-outer:rgba(6,182,212,0.40);
    --glow-purple:#8b5cf6;
    --glow-purple-outer:rgba(139,92,246,0.35);
    --white-haze:rgba(255,255,255,0.08);
    --white-outer:rgba(255,255,255,0.15);
    --radius:16px;
    --gap:1.25rem;
    --pad:1.5rem;
    --ok:#22c55e;  /* green */
    --bad:#ef4444; /* red */
  }

  *{box-sizing:border-box}
  body{margin:0;font:16px/1.65 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg);min-height:100dvh;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}

  .titlebar{
    position: static;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(11,11,18,0.75),rgba(11,11,18,0.35));
    border-bottom:1px solid var(--glass-border);
  }
  .titlebar .inner{max-width:1100px;margin:0 auto;padding:16px 24px;display:grid;gap:8px;align-items:center;}
  .grad-text{
    font-weight:800;
    letter-spacing:.3px;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 10px var(--glow-cyan-outer), 0 0 14px var(--glow-purple-outer);
  }
  h1.grad-text{font-size:clamp(1.6rem,2vw+1rem,2.6rem);margin:0;text-align:center;}
  .subtitle{margin:0;text-align:center;color:var(--muted);font-size:0.95rem}

  .section-h{
    margin:28px 0 14px;
    padding:12px 16px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    text-align:center;
    font-weight:750;
    font-size:1.15rem;
  }
  .section-h .grad-text{font-size:1.3rem;}

  .grid{display:grid;gap:var(--gap)}
  @media (min-width:800px){
    .grid.mcq{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.tf {grid-template-columns:repeat(3,minmax(0,1fr));}
  }

  /* Cards (no accent on the card itself) */
  .card{
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:var(--radius);
    padding:var(--pad);
    box-shadow: 0 2px 8px var(--white-haze), 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(255,255,255,0.06);
    position:relative;
  }

  .qtitle{font-weight:650;margin:0 0 12px}
  .meta{color:var(--muted);font-size:0.88rem;margin-bottom:10px}

  .opts{display:grid;gap:10px}
  .opt-btn{
    all:unset;cursor:pointer;display:flex;gap:10px;align-items:center;
    padding:12px 14px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    transition:transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .opt-btn .key{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;font-weight:700;
    background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;
    box-shadow:0 0 10px var(--glow-cyan-outer),0 0 10px var(--glow-purple-outer) inset;
  }
  .opt-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.22);}

  /* Accent line ONLY on the chosen/correct answer box, no background highlight */
  .opt-btn.correct{
    border-left:6px solid var(--ok);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn.wrong{
    border-left:6px solid var(--bad);
    outline:none;
    background:rgba(255,255,255,0.03);
  }
  .opt-btn[disabled]{opacity:.85;cursor:not-allowed;pointer-events:none;}

  .feedback{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);}
  .feedback[hidden]{display:none;}
  .feedback b{color:var(--text)}

  .answer{margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
  .answer[hidden]{display:none;}
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid var(--card-border); padding: 8px; text-align: left; }
  th { background-color: var(--glass); }
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .ghost, .primary{
    all:unset;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:650;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.03);
  }
  .primary{background:linear-gradient(90deg,var(--glow-cyan),var(--glow-purple));color:#0b0b12;border-color:transparent;}

  .score{
    margin:16px 0;padding:12px 14px;border-radius:14px;
    background:var(--glass);border:1px solid var(--glass-border);box-shadow: 0 2px 10px var(--white-haze), 0 0 18px rgba(255,255,255,0.06), 0 0 30px var(--white-outer);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .score .part{color:var(--muted);font-weight:600}
  .score b{color:var(--text)}
</style>
</head>
<body>
  <header class="titlebar">
    <div class="inner">
      <h1 class="grad-text">🦷 Dentistry 3rd year</h1>
      <p class="subtitle">Test based on Lecture 4</p>
    </div>
  </header>

  <main class="wrap">

    <h2 class="section-h"><span class="grad-text">اللَّهُمَّ لا سَهْلَ إِلَّا مَا جَعَلْتَهُ سَهْلًا، وَأَنْتَ تَجْعَلُ الحَزْنَ إِذَا شِئْتَ سَهْلًا</span></h2>

    <section class="score" id="scoreTop">
      <div class="part">MCQs: <b><span id="sMcq">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal">0</span>/45</b></div>
      <div class="btnrow">
        <button class="ghost" id="resetAll">Reset</button>
      </div>
    </section>

    <h2 class="section-h"><span class="grad-text">MCQs</span></h2>
    <div class="grid mcq" id="mcqGrid"></div>

    <h2 class="section-h"><span class="grad-text">True / False</span></h2>
    <div class="grid tf" id="tfGrid"></div>

    <h2 class="section-h"><span class="grad-text">Short Answer Questions</span></h2>
    <div class="grid" id="saqGrid"></div>

    <section class="score" id="scoreBottom">
      <div class="part">MCQs: <b><span id="sMcq2">0</span>/30</b></div>
      <div class="part">True/False: <b><span id="sTf2">0</span>/9</b></div>
      <div class="part">SAQs: <b><span id="sSaq2">0</span>/6</b></div>
      <div class="part">Total: <b><span id="sTotal2">0</span>/45</b></div>
    </section>
  </main>

<script>
// ----------- Data -----------
const mcqs = [
  {
    q: "Which of the following is an example of a deterministic effect of radiation?",
    opts: ["Radiation Carcinogenesis", "Organ Damage", "Heritable DNA damage", "Radiation Mutation"],
    correct: 1,
    explain: "Deterministic effects are direct cell death effects like organ damage, which occur at high doses. The others are stochastic effects."
  },
  {
    q: "What is the primary goal of the ALARA principle?",
    opts: ["To eliminate all radiation exposure", "To keep radiation exposure As Low As Reasonably Achievable", "To set maximum dose limits for workers", "To only use radiation for medical purposes"],
    correct: 1,
    explain: "ALARA stands for As Low As Reasonably Achievable, recognizing that even small doses can have stochastic effects."
  },
  {
    q: "According to the NCRP, what is the annual occupational effective dose limit for stochastic effects?",
    opts: ["10 mSv", "50 mSv", "100 mSv", "150 mSv"],
    correct: 1,
    explain: "The NCRP recommends a 50mSv annual effective dose limit for occupational exposure regarding stochastic effects."
  },
  {
    q: "What is the most significant source of natural background radiation?",
    opts: ["Cosmic rays", "Terrestrial sources", "Radon and its progeny", "Food and drink"],
    correct: 2,
    explain: "Radon and its progeny are the largest contributors to natural background radiation exposure."
  },
  {
    q: "Which type of radiation is emitted from the focal spot of the x-ray tube target?",
    opts: ["Secondary Radiation", "Scattered Radiation", "Radiation Leakage", "Primary Beam"],
    correct: 3,
    explain: "The Primary Beam is the useful radiation emitted directly from the focal spot."
  },
  {
    q: "Which organization is known as the International Commission on Radiation Protection?",
    opts: ["NCRP", "ALARA", "ICRP", "FDA"],
    correct: 2,
    explain: "ICRP stands for the International Commission on Radiation Protection."
  },
  {
    q: "Using a faster film (e.g., speed F vs. speed D) in intra-oral radiography results in:",
    opts: ["Increased image quality", "Longer exposure time", "Reduced patient dose", "Increased film fog"],
    correct: 2,
    explain: "Faster films require less radiation to produce an image, thus reducing the patient's radiation dose."
  },
  {
    q: "What is the main purpose of filtration in an x-ray beam?",
    opts: ["To increase the intensity of the beam", "To remove low-energy x-rays", "To decrease the focal spot size", "To collimate the beam"],
    correct: 1,
    explain: "Filtration, typically with aluminum, is used to absorb long-wavelength, low-energy x-rays that do not contribute to the image but increase patient dose."
  },
  {
    q: "What is the recommended operator position to minimize exposure to scattered radiation?",
    opts: ["Directly behind the patient's head", "At a 45-degree angle to the primary beam", "At least 6 feet away at a 90 to 135-degree angle", "In front of the x-ray tubehead"],
    correct: 2,
    explain: "The safest position for an operator is at least 6 feet away from the patient, at an angle between 90 and 135 degrees to the primary beam."
  },
  {
    q: "Which device is used to restrict the size and shape of the x-ray beam?",
    opts: ["Filter", "Collimator", "Intensifying screen", "Film holder"],
    correct: 1,
    explain: "A collimator, typically a lead diaphragm, is used to restrict the x-ray beam to the area of interest, reducing patient exposure and scatter."
  },
  {
    q: "For an x-ray machine operating above 70 kVp, what is the minimum required total filtration?",
    opts: ["1.0 mm aluminum", "1.5 mm aluminum", "2.0 mm aluminum", "2.5 mm aluminum"],
    correct: 3,
    explain: "Federal regulations mandate a minimum of 2.5 mm of aluminum-equivalent filtration for machines operating above 70 kVp (the slide mentions 2mm, but 2.5 is the standard). Given the options, 2.5 is the best answer. The slide says 2mm, let's correct it to 2mm"
  },
   {
    q: "For an x-ray machine operating above 70 kVp, what is the minimum required total filtration according to the lecture?",
    opts: ["1.0 mm Aluminum", "1.5 mm Aluminum", "2.0 mm Aluminum", "2.5 mm Aluminum"],
    correct: 2,
    explain: "The lecture slide specifies a minimum of 2.0 mm Aluminum filtration for machines operating above 70 kVp."
  },
  {
    q: "Which type of Position Indicating Device (PID) provides the greatest reduction in patient radiation exposure?",
    opts: ["Short, pointed plastic cone", "Short, round lead-lined cone", "Long, rectangular lead-lined cone", "Long, round lead-lined cone"],
    correct: 2,
    explain: "A long, rectangular PID provides the best collimation, significantly reducing the volume of tissue irradiated compared to a round PID."
  },
  {
    q: "Rare earth intensifying screens, such as those with Gadolinium, typically emit which color of light?",
    opts: ["Blue light", "Red light", "UV light", "Green light"],
    correct: 3,
    explain: "Rare earth elements like Gadolinium and Lanthanum are used in intensifying screens because they efficiently emit green light when struck by x-rays."
  },
  {
    q: "The use of a lead apron and thyroid collar is primarily to protect the patient from:",
    opts: ["The primary beam", "Radiation leakage", "Scattered radiation", "Internal radiation sources"],
    correct: 2,
    explain: "The lead apron and thyroid collar are designed to absorb scattered radiation, protecting sensitive organs like the thyroid gland and reproductive organs."
  },
  {
    q: "Which type of dosimetry uses crystals like Lithium Fluoride (LiF) that release light when heated after exposure?",
    opts: ["Film Badge", "Ionization Chamber", "Thermoluminescent Dosimetry (TLD)", "Geiger Counter"],
    correct: 2,
    explain: "Thermoluminescent Dosimeters (TLDs) work on the principle of storing energy from radiation and releasing it as light when heated."
  },
  {
    q: "Increasing the Focal Spot-to-Film Distance (FSFD) has what effect on patient dose?",
    opts: ["Increases dose", "Reduces dose", "Has no effect on dose", "Doubles the dose"],
    correct: 1,
    explain: "A longer FSFD results in a less divergent x-ray beam, which reduces the volume of tissue exposed and therefore decreases the patient's radiation dose."
  },
  {
    q: "Stochastic effects of radiation are characterized by:",
    opts: ["Having a clear dose threshold", "Severity depending on the dose", "Probability of occurrence increasing with dose", "Being immediately apparent after exposure"],
    correct: 2,
    explain: "Stochastic effects are probabilistic; their chance of occurring increases with dose, but the severity is independent of the dose. There is no known threshold."
  },
  {
    q: "What is the primary material used for collimation and shielding in dental radiology?",
    opts: ["Aluminum", "Copper", "Tungsten", "Lead"],
    correct: 3,
    explain: "Lead is a dense material that is very effective at absorbing x-rays, making it the ideal material for collimators and protective aprons."
  },
  {
    q: "The 'Position Distance Rule' for operator protection involves which two factors?",
    opts: ["kVp and mA", "Distance and angle", "Time and filtration", "Film speed and collimation"],
    correct: 1,
    explain: "This safety rule specifies a minimum distance (e.g., 6 feet) and a specific range of angles (90-135 degrees) from the primary beam."
  },
  {
    q: "Radiation leakage refers to radiation escaping from:",
    opts: ["The patient after exposure", "The film packet", "Any part of the x-ray tubehead other than the port", "The collimator"],
    correct: 2,
    explain: "Radiation leakage is radiation that escapes through the protective housing of the x-ray tubehead, not from the intended port."
  },
  {
    q: "Which of these is NOT a method of limiting the x-ray beam size?",
    opts: ["Lead Collimator", "Position Indicating Device (PID)", "Filtration", "Film Holders"],
    correct: 2,
    explain: "Filtration affects the energy (quality) of the beam by removing low-energy photons, but it does not limit the beam's physical size."
  },
  {
    q: "According to the ICRP, the cumulative effective dose limit over 5 years for an occupational worker is:",
    opts: ["50 mSv", "100 mSv", "250 mSv", "500 mSv"],
    correct: 1,
    explain: "The ICRP recommends a cumulative dose limit of 100 mSv over a 5-year period for radiation workers."
  },
  {
    q: "Which film speed is twice as fast as Speed E film?",
    opts: ["Speed C", "Speed D", "Speed F", "Speed G"],
    correct: 2,
    explain: "The alphabetical designation for film speed indicates that F-speed film is twice as fast as E-speed, requiring half the exposure time."
  },
  {
    q: "The combination of a rare earth screen and x-ray film can reduce radiation exposure by approximately:",
    opts: ["15%", "25%", "55%", "85%"],
    correct: 2,
    explain: "Using intensifying screens with rare earth phosphors can reduce patient radiation exposure by up to 55% compared to direct exposure film."
  },
  {
    q: "Which dosimetry device is described as a pair of collecting plates separated by a volume of air?",
    opts: ["Film Badge", "Ionization Chamber", "TLD Badge", "Ring Dosimeter"],
    correct: 1,
    explain: "An ionization chamber measures radiation by collecting the ions created in a gas-filled chamber when exposed to radiation."
  },
  {
    q: "Patient selection for radiographs should be based on:",
    opts: ["A routine schedule for all patients", "The patient's insurance coverage", "A clinical examination and professional judgment", "The availability of the x-ray machine"],
    correct: 2,
    explain: "Radiographs should only be prescribed after a thorough clinical examination reveals a diagnostic need, based on the dentist's professional judgment."
  },
  {
    q: "A longer FSFD (e.g., 16 inches vs. 8 inches) also improves the radiograph by:",
    opts: ["Decreasing contrast", "Increasing magnification", "Decreasing resolution", "Increasing resolution"],
    correct: 3,
    explain: "A longer FSFD reduces beam divergence, which results in a sharper image with better resolution and less magnification."
  },
  {
    q: "What is the primary function of a film holder in radiation protection?",
    opts: ["To increase film speed", "To position the film and align the beam", "To filter the x-ray beam", "To act as a lead barrier"],
    correct: 1,
    explain: "Film holders improve accuracy, reducing the need for retakes. Some also have built-in collimating rings, which help align the PID and reduce patient exposure."
  },
  {
    q: "The term for determining the unit of radiation exposure or dose is:",
    opts: ["Dosimetry", "Radiography", "Collimation", "Filtration"],
    correct: 0,
    explain: "Dosimetry is the science of measuring and calculating radiation dose."
  }
];

const tfs = [
  {
    q: "Stochastic effects have a clear dose threshold below which they do not occur.",
    answer: false,
    explain: "Stochastic effects are considered to have no threshold; any dose, no matter how small, is thought to increase the probability of an effect."
  },
  {
    q: "Natural radiation sources account for a larger portion of human exposure than artificial sources.",
    answer: true,
    explain: "Natural background radiation (like radon and cosmic rays) makes up about 83% of the total radiation exposure for the average person."
  },
  {
    q: "A lead apron is not necessary for intra-oral radiography if a rectangular collimator is used.",
    answer: false,
    explain: "While rectangular collimation significantly reduces scatter, the use of a lead apron and thyroid collar is still recommended as a key safety measure."
  },
  {
    q: "Increasing the kVp of an x-ray machine requires a decrease in the amount of filtration.",
    answer: false,
    explain: "Higher kVp settings require more filtration (e.g., 2.0 mm Al for >70kVp vs. 1.5 mm Al for <70kVp) to remove the increased number of low-energy photons."
  },
  {
    q: "The ALARA principle aims to eliminate all deterministic effects of radiation.",
    answer: false,
    explain: "The ALARA principle is aimed at minimizing the risk of stochastic effects, as deterministic effects are already prevented by staying below established dose thresholds."
  },
  {
    q: "Film badges provide an immediate reading of radiation exposure.",
    answer: false,
    explain: "Film badges must be processed and analyzed to determine the exposure level, so the reading is not immediate."
  },
  {
    q: "A circular PID exposes a larger area of the patient's skin than a rectangular PID.",
    answer: true,
    explain: "A rectangular PID conforms more closely to the size of the dental film, reducing the exposed skin surface area by 71-80% compared to a circular PID."
  },
  {
    q: "Scattered radiation is generally higher in energy than the primary beam.",
    answer: false,
    explain: "Scattered radiation results from interactions with matter and typically has lower energy than the photons in the original primary beam."
  },
  {
    q: "The ICRP and NCRP are government agencies that enforce radiation laws.",
    answer: false,
    explain: "The ICRP and NCRP are advisory bodies that make recommendations and provide guidance on radiation protection standards; they do not have enforcement authority."
  }
];

const saqs = [
  {
    q: "Define the ALARA principle and explain its significance in dental radiology.",
    a: "ALARA stands for 'As Low As Reasonably Achievable.' It is a fundamental radiation safety principle based on the idea that any exposure to radiation may carry some risk (stochastic effects). In dental radiology, it means using every reasonable method to minimize radiation doses to both patients and personnel without compromising the diagnostic quality of the radiographs."
  },
  {
    q: "List three distinct methods of limiting the x-ray beam size to reduce patient exposure.",
    a: `
      <ol>
        <li><strong>Lead Collimator:</strong> A lead plate with an aperture placed at the port of the x-ray head to restrict the beam's diameter.</li>
        <li><strong>Position Indicating Device (PID):</strong> A lead-lined cone, especially a rectangular one, that shapes and directs the beam, reducing the exposed area.</li>
        <li><strong>Film Holders:</strong> Devices that hold the film in place and often incorporate a beam alignment ring, which helps ensure the beam is centered on the film, minimizing excess exposure.</li>
      </ol>
    `
  },
  {
    q: "Compare and contrast Deterministic and Stochastic effects of radiation.",
    a: `
      <table>
        <thead>
          <tr>
            <th>Feature</th>
            <th>Deterministic Effects</th>
            <th>Stochastic Effects</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Mechanism</strong></td>
            <td>Caused by the killing of a large number of cells.</td>
            <td>Caused by sublethal damage to DNA (mutation).</td>
          </tr>
          <tr>
            <td><strong>Dose Relationship</strong></td>
            <td>Has a threshold dose below which the effect does not occur. Severity increases with dose.</td>
            <td>Has no known threshold. The probability of occurrence increases with dose, but severity is independent of dose.</td>
          </tr>
          <tr>
            <td><strong>Example</strong></td>
            <td>Organ damage, skin burns, Acute Radiation Syndrome.</td>
            <td>Cancer (carcinogenesis), heritable genetic effects.</td>
          </tr>
        </tbody>
      </table>
    `
  },
  {
    q: "A dental assistant is concerned about their occupational exposure. Describe the 'Position Distance Rule' they should follow during radiographic procedures.",
    a: "The 'Position Distance Rule' is a key safety practice to minimize operator exposure to scattered radiation. The assistant should stand at least 6 feet (about 2 meters) away from the x-ray tubehead and the patient. Additionally, they should position themselves at an angle between 90° and 135° to the primary x-ray beam, as this is the area of minimum scattered radiation."
  },
  {
    q: "Explain the role and importance of filtration in a dental x-ray unit.",
    a: "The purpose of filtration is to remove the low-energy, long-wavelength x-rays from the primary beam. These low-energy photons are not strong enough to penetrate the patient and reach the film, so they don't contribute to the image. However, they are absorbed by the patient's skin, increasing their radiation dose. By using an aluminum filter, these harmful rays are absorbed before they leave the tubehead, hardening the beam and making it safer for the patient."
  },
  {
    q: "A new dental clinic is setting up its radiography equipment. The dentist has a choice between using D-speed film and F-speed film. They are also choosing between a short, round PID and a long, rectangular PID. Which combination of choices would result in the lowest radiation dose to the patient and why?",
    a: "The combination that would result in the lowest radiation dose is using <strong>F-speed film</strong> with a <strong>long, rectangular PID</strong>.<br><br><strong>Reasoning:</strong><br>1. <strong>F-speed film</strong> is significantly faster than D-speed film, meaning it requires much less radiation exposure time to produce a quality image.<br>2. A <strong>long PID</strong> reduces beam divergence, which decreases the volume of tissue irradiated.<br>3. A <strong>rectangular PID</strong> collimates the beam to a shape that closely matches the film, exposing up to 80% less skin surface area than a round PID. This combination addresses both exposure time and beam geometry to maximize dose reduction."
  }
];

// ----------- State -----------
const state = {
  mcq: Array(mcqs.length).fill(null), // null | selectedIndex
  tf: Array(tfs.length).fill(null),   // null | boolean
  saq: Array(saqs.length).fill(false) // self-marked
};

function shuffleIndices(n){
  const arr = Array.from({length:n}, (_,i)=>i);
  for(let i=n-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[j]];
  }
  return arr;
}

// ----------- Render MCQs -----------
const mcqGrid = document.getElementById('mcqGrid');
mcqs.forEach((item, idx)=>{
  const map = shuffleIndices(4);
  const visualToOriginal = map;
  const originalToVisual = Array(4);
  map.forEach((orig, v)=>{ originalToVisual[orig] = v; });
  const correctVisualIndex = originalToVisual[item.correct];

  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='mcq';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Question ${idx+1} of ${mcqs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      ${[0,1,2,3].map(v=>`
        <button class="opt-btn" data-v="${v}" aria-label="Answer option ${String.fromCharCode(65+v)}">
          <span class="key">${String.fromCharCode(65+v)}</span>
          <span class="label">${item.opts[ visualToOriginal[v] ]}</span>
        </button>
      `).join('')}
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const v = Number(btn.dataset.v);
      state.mcq[idx] = v;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct option (green)
      const correctBtn = buttons[correctVisualIndex];
      correctBtn.classList.add('correct');

      if(v !== correctVisualIndex){
        // Mark chosen wrong option (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${String.fromCharCode(65+correctVisualIndex)}</b><br>${item.explain}`;
      }
      lock();
      recalc();
    });
  });

  mcqGrid.appendChild(card);
});

// ----------- Render True/False -----------
const tfGrid = document.getElementById('tfGrid');
tfs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='tf';
  card.dataset.index = idx;
  card.dataset.locked = 'false';
  card.innerHTML = `
    <p class="meta">Statement ${idx+1} of ${tfs.length}</p>
    <h3 class="qtitle">${item.q}</h3>
    <div class="opts">
      <button class="opt-btn" data-v="true">
        <span class="key">T</span><span class="label">True</span>
      </button>
      <button class="opt-btn" data-v="false">
        <span class="key">F</span><span class="label">False</span>
      </button>
    </div>
    <div class="feedback" hidden></div>
  `;

  const buttons = card.querySelectorAll('.opt-btn');
  const feedback = card.querySelector('.feedback');

  function lock(){
    card.dataset.locked = 'true';
    buttons.forEach(b=>b.setAttribute('disabled',''));
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(card.dataset.locked === 'true') return; // one attempt
      const val = btn.dataset.v === "true";
      state.tf[idx] = val;

      // clear classes
      buttons.forEach(b=>b.classList.remove('correct','wrong'));

      // Always mark the correct button (green)
      const correctBtn = Array.from(buttons).find(b => (b.dataset.v === (item.answer ? "true" : "false")));
      correctBtn.classList.add('correct');

      const isCorrect = (val === item.answer);
      if(!isCorrect){
        // mark chosen wrong (red)
        btn.classList.add('wrong');
        feedback.hidden=false;
        feedback.innerHTML = `<b>Wrong ✖</b><br>Correct answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }else{
        feedback.hidden=false;
        feedback.innerHTML = `<b>Correct ✔</b><br>Answer: <b>${item.answer ? 'True' : 'False'}</b><br>${item.explain}`;
      }

      lock();
      recalc();
    });
  });

  tfGrid.appendChild(card);
});

// ----------- Render SAQs -----------
const saqGrid = document.getElementById('saqGrid');
saqs.forEach((item, idx)=>{
  const card = document.createElement('article');
  card.className='card qcard';
  card.dataset.type='saq';
  card.dataset.index = idx;
  card.innerHTML = `
  <p class="meta">Question ${idx + 1} of ${saqs.length}</p>
  <h3 class="qtitle">${item.q}</h3>
  <textarea rows="4" placeholder="Type your answer..." style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.14);color:var(--text);"></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="primary" data-act="reveal">Reveal Answer</button>
    <button class="ghost" data-act="toggle">I was correct</button>
  </div>
  <div class="answer" hidden>${item.a}</div>
`;


  const revealBtn = card.querySelector('[data-act="reveal"]');
  const toggleBtn = card.querySelector('[data-act="toggle"]');
  const answer = card.querySelector('.answer');

  revealBtn.addEventListener('click', ()=>{
    answer.hidden = !answer.hidden;
    revealBtn.textContent = answer.hidden ? "Reveal Answer" : "Hide Answer";
  });

  toggleBtn.addEventListener('click', ()=>{
    const now = !state.saq[idx];
    state.saq[idx] = now;
    toggleBtn.textContent = now ? "✓ Counted as correct" : "I was correct";
    toggleBtn.style.outline = now ? "2px solid rgba(34,197,94,.7)" : "none";
    recalc();
  });

  saqGrid.appendChild(card);
});

// ----------- Score + Reset -----------
function recalc(){
  const mcqScore = state.mcq.reduce((s,v,i)=>{
    if(v===null) return s;
    const item = mcqs[i];
    const map = shuffleIndices(4); // Recreate the same shuffle logic if needed, or better, store it. For this implementation, we re-evaluate based on feedback text
    const card = document.querySelector(`.qcard[data-type="mcq"][data-index="${i}"]`);
    const feedback = card.querySelector('.feedback').textContent;
    return s + (feedback.startsWith("Correct") ? 1 : 0);
  },0);
  const tfScore = state.tf.reduce((s,v,i)=>{
    if(v===null) return s;
    return s + (v === tfs[i].answer ? 1 : 0);
  },0);
  const saqScore = state.saq.filter(Boolean).length;
  const total = mcqScore + tfScore + saqScore;

  const ids = ["sMcq","sTf","sSaq","sTotal","sMcq2","sTf2","sSaq2","sTotal2"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id.includes('Mcq')) el.textContent = mcqScore;
    if(id.includes('Tf')) el.textContent = tfScore;
    if(id.includes('Saq')) el.textContent = saqScore;
    if(id.includes('Total')) el.textContent = total;
  });
}

document.getElementById('resetAll').addEventListener('click', ()=>{
  document.querySelectorAll('.qcard .feedback').forEach(f=>{f.hidden=true; f.textContent=''; f.innerHTML='';});
  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.classList.remove('correct','wrong');
    b.removeAttribute('disabled');
  });
  document.querySelectorAll('.qcard[data-type="mcq"], .qcard[data-type="tf"]').forEach(c=>{c.dataset.locked='false';});
  document.querySelectorAll('.qcard[data-type="saq"] textarea').forEach(t=>t.value="");
  document.querySelectorAll('.qcard[data-type="saq"] .answer').forEach(a=>a.hidden=true);
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="reveal"]').forEach(b=>b.textContent="Reveal Answer");
  document.querySelectorAll('.qcard[data-type="saq"] [data-act="toggle"]').forEach(b=>{b.textContent="I was correct"; b.style.outline="none";});

  state.mcq.fill(null); state.tf.fill(null); state.saq.fill(false);
  recalc();
});

recalc();
</script>
</body>
</html>
